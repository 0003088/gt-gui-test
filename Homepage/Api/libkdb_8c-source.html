<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Elektra Project: libkdb.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>libkdb.c</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment">            localkdb.c  -  Methods for accessing the Key Database</span>
00003 <span class="comment">                             -------------------</span>
00004 <span class="comment">    begin                : Mon Dec 29 2003</span>
00005 <span class="comment">    copyright            : (C) 2003 by Avi Alkalay</span>
00006 <span class="comment">    email                : avi@unix.sh</span>
00007 <span class="comment"> ***************************************************************************/</span>
00008 
00009 <span class="comment">/***************************************************************************</span>
00010 <span class="comment"> *                                                                         *</span>
00011 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
00012 <span class="comment"> *   it under the terms of the BSD License (revised).                      *</span>
00013 <span class="comment"> *                                                                         *</span>
00014 <span class="comment"> ***************************************************************************/</span>
00015 
00016 
00017 
00018 
00019 <span class="comment">/* Subversion stuff</span>
00020 <span class="comment"></span>
00021 <span class="comment">$Id: libkdb.c 252 2005-07-30 11:58:10Z aviram $</span>
00022 <span class="comment">$LastChangedBy: aviram $</span>
00023 <span class="comment"></span>
00024 <span class="comment">*/</span>
00025 
00026 
00027 <span class="preprocessor">#include "kdb.h"</span>
00028 <span class="preprocessor">#include "kdbbackend.h"</span>
00029 <span class="preprocessor">#include "kdbprivate.h"</span>
00030 
00031 
00032 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00033 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00034 <span class="preprocessor">#include &lt;dlfcn.h&gt;</span>
00035 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00036 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00037 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00038 <span class="preprocessor">#include &lt;iconv.h&gt;</span>
00039 <span class="preprocessor">#include &lt;locale.h&gt;</span>
00040 <span class="preprocessor">#include &lt;langinfo.h&gt;</span>
00041 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00042 <span class="preprocessor">#include &lt;string.h&gt;</span>
00043 
00044 
00045 
00046 <span class="keyword">extern</span> <span class="keywordtype">int</span> errno;
00047 
00048 
00049 
00050 
00080 <span class="comment">/*</span>
00081 <span class="comment"> * @defgroup internals Elektra internals</span>
00082 <span class="comment"> * @brief These methods are not to be used by your application.</span>
00083 <span class="comment"> *</span>
00084 <span class="comment"> */</span>
00085 
00086 
00087 
00088 <span class="keyword">struct </span>_KDBBackend {
00089     <span class="keywordtype">void</span> *dlHandle;
00090     
00091     <span class="keywordtype">char</span> *name;
00092     
00093     <span class="comment">/* These are the must-have methods */</span>
00094     
00095     int (*kdbOpen)();
00096     int (*kdbClose)();
00097     
00098     int (*kdbGetKey)(<a class="code" href="struct__Key.html">Key</a> *);
00099     int (*kdbSetKey)(<a class="code" href="struct__Key.html">Key</a> *);
00100     int (*kdbStatKey)(<a class="code" href="struct__Key.html">Key</a> *);
00101     int (*kdbRename)(<a class="code" href="struct__Key.html">Key</a> *, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
00102     int (*kdbRemoveKey)(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *);
00103     int (*kdbGetKeyChildKeys)(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *, <a class="code" href="struct__KeySet.html">KeySet</a> *, <span class="keywordtype">unsigned</span> long);
00104 
00105     
00106     
00107     <span class="comment">/* These are the optional methods */</span>
00108     
00109     int (*kdbSetKeys)(KeySet *);
00110     u_int32_t (*kdbMonitorKey)(<a class="code" href="struct__Key.html">Key</a> *, u_int32_t,<span class="keywordtype">unsigned</span> long, unsigned);
00111     u_int32_t (*kdbMonitorKeys)(KeySet *, u_int32_t,<span class="keywordtype">unsigned</span> long, unsigned);
00112 };
00113 
00114 
00115 
00116 
00117 KDBBackend *backend;
00118 
00119 
00120 
<a name="l00146"></a><a class="code" href="group__kdb.html#ga0">00146</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga0">kdbOpen</a>() {
00147     <span class="keywordtype">char</span> *backendName=0;
00148     
00149     backendName=getenv(<span class="stringliteral">"KDB_BACKEND"</span>);
00150     <span class="keywordflow">if</span> (backendName) <span class="keywordflow">return</span> <a class="code" href="group__kdb.html#ga2">kdbOpenBackend</a>(backendName);
00151     <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="group__kdb.html#ga2">kdbOpenBackend</a>(<span class="stringliteral">"default"</span>);
00152 }
00153 
00154 
00155 
<a name="l00171"></a><a class="code" href="group__kdb.html#ga1">00171</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga1">kdbOpenDefault</a>() {
00172     <span class="keywordflow">return</span> <a class="code" href="group__kdb.html#ga2">kdbOpenBackend</a>(<span class="stringliteral">"default"</span>);
00173 }
00174 
00175 
00176 
00177 
<a name="l00223"></a><a class="code" href="group__kdb.html#ga2">00223</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga2">kdbOpenBackend</a>(<span class="keywordtype">char</span> *backendName) {
00224     <span class="keywordtype">void</span> *dlhandle=0;
00225     <span class="keywordtype">char</span> backendlib[300];
00226     KDBBackendFactory kdbBackendNew=0;
00227     <span class="keywordtype">int</span> rc=0;
00228     
00229     backend=0;
00230     
00231     <span class="comment">/* load the environment and make us aware of codeset conversions */</span>
00232     setlocale(LC_ALL,<span class="stringliteral">""</span>);
00233     
00234     sprintf(backendlib,<span class="stringliteral">"libelektra-%s.so"</span>,backendName);
00235     dlhandle=dlopen(backendlib,RTLD_LAZY);
00236     <span class="keywordflow">if</span> (dlhandle == 0) {
00237         fprintf(stderr, <span class="stringliteral">"libelektra: Could not open \"%s\" backend: %s\n"</span>,
00238             backendName,dlerror());
00239         errno=KDB_RET_NOSYS;
00240         <span class="keywordflow">return</span> 1; <span class="comment">/* error */</span>
00241     }
00242     
00243     kdbBackendNew=dlsym(dlhandle,<span class="stringliteral">"kdbBackendFactory"</span>);
00244     <span class="keywordflow">if</span> (kdbBackendNew == 0) {
00245         fprintf(stderr, <span class="stringliteral">"libelektra: \"%s\" backend: %s\n"</span>,backendName,dlerror());
00246         errno=KDB_RET_NOSYS;
00247         <span class="keywordflow">return</span> 2; <span class="comment">/* error */</span>
00248     }
00249     
00250     backend=(*kdbBackendNew)();
00251     <span class="keywordflow">if</span> (backend == 0) {
00252         fprintf(stderr,<span class="stringliteral">"libelektra: Can't initialize \"%s\" backend\n"</span>,
00253             backendName);
00254         errno=KDB_RET_NOSYS;
00255         <span class="keywordflow">return</span> 3; <span class="comment">/* error */</span>
00256     }
00257 
00258     <span class="comment">/* save the handle for future use */</span>
00259     backend-&gt;dlHandle=dlhandle;
00260     
00261     <span class="comment">/* let the backend initialize itself */</span>
00262     <span class="keywordflow">if</span> (backend-&gt;kdbOpen) rc=backend-&gt;kdbOpen();
00263     <span class="keywordflow">else</span> {
00264         errno=KDB_RET_NOSYS;
00265         rc=4;
00266     }
00267     <span class="keywordflow">return</span> rc;
00268 }
00269 
00270 
00271 
<a name="l00285"></a><a class="code" href="group__kdb.html#ga3">00285</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga3">kdbClose</a>() {
00286     <span class="keywordtype">int</span> rc=0;
00287     
00288     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbClose) rc=backend-&gt;kdbClose();
00289     <span class="keywordflow">else</span> {
00290         errno=KDB_RET_NOSYS;
00291         <span class="keywordflow">return</span> -1;
00292     }
00293     
00294     <span class="keywordflow">if</span> (rc == 0) {
00295         <span class="keywordflow">if</span> (backend-&gt;name) free(backend-&gt;name);
00296         dlclose(backend-&gt;dlHandle);
00297         free(backend); backend=0;
00298     }
00299     
00300     <span class="keywordflow">return</span> rc;
00301 }
00302 
00303 
00304 
00305 
<a name="l00318"></a><a class="code" href="group__backend.html#ga0">00318</a> ssize_t <a class="code" href="group__backend.html#ga0">unencode</a>(<span class="keywordtype">char</span> *encoded,<span class="keywordtype">void</span> *returned) {
00319     <span class="keywordtype">char</span> byteInHexa[5]=<span class="stringliteral">"0x"</span>;
00320     <span class="keywordtype">char</span> *readCursor=encoded;
00321     <span class="keywordtype">char</span> *writeCursor=returned;
00322 
00323     <span class="keywordflow">if</span> (!encoded) {
00324         <span class="keywordflow">if</span> (returned) *(<span class="keywordtype">char</span> *)returned=0;
00325         <span class="keywordflow">return</span> 0;
00326     }
00327 
00328     byteInHexa[4]=0;
00329     <span class="keywordflow">while</span> (*readCursor) {
00330         <span class="keywordflow">if</span> (isspace((<span class="keywordtype">int</span>)*readCursor)) 
00331         {
00332         readCursor++;
00333         <span class="keywordflow">continue</span>;
00334         }
00335         <span class="keywordflow">if</span> (isxdigit((<span class="keywordtype">int</span>)*readCursor)) {
00336             <span class="keywordtype">long</span> <span class="keywordtype">int</span> converted;
00337             byteInHexa[2]=readCursor[0];
00338             byteInHexa[3]=readCursor[1];
00339             converted=strtol(byteInHexa,0,16); <span class="comment">/* convert from hexa to a byte */</span>
00340             *writeCursor=(<span class="keywordtype">unsigned</span> char)converted;
00341 
00342             readCursor+=2;
00343             writeCursor++;
00344         } <span class="keywordflow">else</span> {
00345             <span class="comment">/* This is suposed to be a hex-digit stream. But is not, so return. */</span>
00346             errno=KDB_RET_TYPEMISMATCH;
00347             <span class="keywordflow">return</span> -1;
00348         }
00349     }
00350     <span class="keywordflow">return</span> (<span class="keywordtype">long</span> int)writeCursor-(<span class="keywordtype">long</span> int)returned;
00351 }
00352 
<a name="l00359"></a><a class="code" href="group__backend.html#ga1">00359</a> <span class="keywordtype">int</span> <a class="code" href="group__backend.html#ga1">kdbNeedsUTF8Conversion</a>() {
00360     <span class="keywordflow">return</span> strcmp(nl_langinfo(CODESET),<span class="stringliteral">"UTF-8"</span>);
00361 }
00362 
00363 
<a name="l00384"></a><a class="code" href="group__backend.html#ga2">00384</a> <span class="keywordtype">int</span> <a class="code" href="group__backend.html#ga2">UTF8Engine</a>(<span class="keywordtype">int</span> direction, <span class="keywordtype">char</span> **string, size_t *inputOutputByteSize) {
00385     <span class="keywordtype">char</span> *currentCharset=0;
00386     <span class="keywordtype">char</span> *converted=0;
00387     <span class="keywordtype">char</span> *readCursor, *writeCursor;
00388     size_t bufferSize;
00389     iconv_t converter;
00390 
00391     <span class="keywordflow">if</span> (<a class="code" href="group__backend.html#ga1">kdbNeedsUTF8Conversion</a>()) currentCharset=nl_langinfo(CODESET);
00392     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
00393 
00394     <span class="keywordflow">if</span> (direction==UTF8_TO) converter=iconv_open(<span class="stringliteral">"UTF-8"</span>,currentCharset);
00395     <span class="keywordflow">else</span> converter=iconv_open(currentCharset,<span class="stringliteral">"UTF-8"</span>);
00396 
00397     <span class="keywordflow">if</span> (converter == (iconv_t)(-1)) <span class="keywordflow">return</span> -1;
00398 
00399     <span class="comment">/* work with worst case, when all chars are wide */</span>
00400     bufferSize=*inputOutputByteSize * 4;
00401     converted=malloc(bufferSize);
00402     <span class="keywordflow">if</span> (!converted) <span class="keywordflow">return</span> -1;
00403 
00404     readCursor=*string;
00405     writeCursor=converted;
00406     <span class="keywordflow">if</span> (iconv(converter,
00407             &amp;readCursor,inputOutputByteSize,
00408             &amp;writeCursor,&amp;bufferSize) == (size_t)(-1)) {
00409         free(converted);
00410         iconv_close(converter);
00411         <span class="keywordflow">return</span> -1;
00412     }
00413 
00414     <span class="comment">/* calculate the UTF-8 string byte size, that will be returned */</span>
00415     *inputOutputByteSize=writeCursor-converted;
00416     <span class="comment">/* store the current unencoded string for future free */</span>
00417     readCursor=*string;
00418     <span class="comment">/* allocate an optimal size area to store the converted string */</span>
00419     *string=malloc(*inputOutputByteSize);
00420     <span class="comment">/* copy all that matters for returning */</span>
00421     memcpy(*string,converted,*inputOutputByteSize);
00422     <span class="comment">/* release memory used by passed string */</span>
00423     free(readCursor);
00424     <span class="comment">/* release buffer memory */</span>
00425     free(converted);
00426     <span class="comment">/* release the conversor engine */</span>
00427     iconv_close(converter);
00428 
00429     <span class="keywordflow">return</span> 0;
00430 }
00431 
00432 
00433 
<a name="l00448"></a><a class="code" href="group__backend.html#ga3">00448</a> ssize_t <a class="code" href="group__backend.html#ga3">encode</a>(<span class="keywordtype">void</span> *unencoded, size_t size, <span class="keywordtype">char</span> *returned) {
00449     <span class="keywordtype">void</span> *readCursor=unencoded;
00450     <span class="keywordtype">void</span> *writeCursor=returned;
00451     <span class="keywordtype">int</span> blockStep=4; <span class="comment">/* 4 bytes per block */</span>
00452     <span class="keywordtype">int</span> lineStep=8*blockStep; <span class="comment">/* 8 blocks per line */</span>
00453     <span class="keywordtype">int</span> currentInBlock=0;
00454     <span class="keywordtype">int</span> currentInLine=0;
00455 
00456     <span class="keywordflow">while</span> ((readCursor-unencoded)&lt;size) {
00457         sprintf(writeCursor,<span class="stringliteral">"%02x"</span>,*(u_int8_t *)readCursor);
00458         readCursor++;
00459         writeCursor+=2;
00460         currentInBlock++;
00461         currentInLine++;
00462         <span class="keywordflow">if</span> (currentInLine==lineStep) {
00463             *(<span class="keywordtype">char</span> *)writeCursor=<span class="charliteral">'\n'</span>; writeCursor++;
00464             currentInLine=0;
00465             currentInBlock=0;
00466         }
00467         <span class="keywordflow">if</span> (currentInBlock==blockStep) {
00468             *(<span class="keywordtype">char</span> *)writeCursor=<span class="charliteral">' '</span>; writeCursor++;
00469             currentInBlock=0;
00470         }
00471     }
00472     *(<span class="keywordtype">char</span> *)writeCursor=<span class="charliteral">'\n'</span>;
00473     *(<span class="keywordtype">char</span> *)++writeCursor=0;
00474     <span class="keywordflow">return</span> (writeCursor)-(<span class="keywordtype">void</span> *)returned;
00475 }
00476 
00477 
00478 
00479 
00480 
<a name="l00494"></a><a class="code" href="group__kdb.html#ga4">00494</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga4">kdbGetValue</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyname, <span class="keywordtype">char</span> *returned,size_t maxSize) {
00495     <a class="code" href="struct__Key.html">Key</a> *key;
00496     <span class="keywordtype">int</span> rc=0;
00497 
00498     key=<a class="code" href="group__key.html#ga0">keyNew</a>(keyname,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00499     rc=<a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(key);
00500     <span class="keywordflow">if</span> (rc == 0) <a class="code" href="group__keyvalue.html#ga3">keyGetString</a>(key,returned,maxSize);
00501     <span class="keywordflow">else</span> rc=errno; <span class="comment">/* store errno before a possible change */</span>
00502     <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00503     errno=rc;
00504     <span class="keywordflow">return</span> rc;
00505 }
00506 
00507 
00508 
<a name="l00522"></a><a class="code" href="group__kdb.html#ga5">00522</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga5">kdbSetValue</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyname, <span class="keyword">const</span> <span class="keywordtype">char</span> *value) {
00523     <a class="code" href="struct__Key.html">Key</a> *key;
00524     <span class="keywordtype">int</span> rc;
00525 
00526 <span class="comment">/* TODO: check key type first */</span>
00527     key=<a class="code" href="group__key.html#ga0">keyNew</a>(keyname,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00528     rc=<a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(key);
00529     <a class="code" href="group__keyvalue.html#ga2">keySetString</a>(key,value);
00530     rc=<a class="code" href="group__kdb.html#ga16">kdbSetKey</a>(key);
00531     <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00532     <span class="keywordflow">return</span> rc;
00533 }
00534 
00535 
00536 
<a name="l00563"></a><a class="code" href="group__kdb.html#ga6">00563</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga6">kdbGetValueByParent</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *parentName, <span class="keyword">const</span> <span class="keywordtype">char</span> *baseName, <span class="keywordtype">char</span> *returned, size_t maxSize) {
00564     <span class="keywordtype">char</span> name[<a class="code" href="group__backend.html#ga8">strblen</a>(parentName)+<a class="code" href="group__backend.html#ga8">strblen</a>(baseName)];
00565 
00566     sprintf(name,<span class="stringliteral">"%s/%s"</span>,parentName,baseName);
00567     <span class="keywordflow">return</span> <a class="code" href="group__kdb.html#ga4">kdbGetValue</a>(name,returned,maxSize);
00568 }
00569 
00570 
00571 
<a name="l00582"></a><a class="code" href="group__kdb.html#ga7">00582</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga7">kdbSetValueByParent</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *parentName, <span class="keyword">const</span> <span class="keywordtype">char</span> *baseName, <span class="keyword">const</span> <span class="keywordtype">char</span> *value) {
00583     <span class="keywordtype">char</span> name[<a class="code" href="group__backend.html#ga8">strblen</a>(parentName)+<a class="code" href="group__backend.html#ga8">strblen</a>(baseName)];
00584 
00585     sprintf(name,<span class="stringliteral">"%s/%s"</span>,parentName,baseName);
00586     <span class="keywordflow">return</span> <a class="code" href="group__kdb.html#ga5">kdbSetValue</a>(name,value);
00587 }
00588 
00589 
00590 
<a name="l00605"></a><a class="code" href="group__kdb.html#ga8">00605</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga8">kdbGetKeyByParent</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *parentName, <span class="keyword">const</span> <span class="keywordtype">char</span> *baseName, <a class="code" href="struct__Key.html">Key</a> *returned) {
00606     <span class="keywordtype">char</span> name[<a class="code" href="group__backend.html#ga8">strblen</a>(parentName)+<a class="code" href="group__backend.html#ga8">strblen</a>(baseName)];
00607 
00608     sprintf(name,<span class="stringliteral">"%s/%s"</span>,parentName,baseName);
00609     <a class="code" href="group__keyname.html#ga0">keySetName</a>(returned,name);
00610 
00611     <span class="keywordflow">return</span> <a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(returned);
00612 }
00613 
00614 
<a name="l00622"></a><a class="code" href="group__kdb.html#ga9">00622</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga9">kdbGetKeyByParentKey</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *parent, <span class="keyword">const</span> <span class="keywordtype">char</span> *baseName, <a class="code" href="struct__Key.html">Key</a> *returned) {
00623     size_t size=<a class="code" href="group__keyname.html#ga6">keyGetFullNameSize</a>(parent);
00624     <span class="keywordtype">char</span> name[size+<a class="code" href="group__backend.html#ga8">strblen</a>(baseName)];
00625 
00626     <a class="code" href="group__keyname.html#ga7">keyGetFullName</a>(parent,name,size);
00627     name[size-1]=<span class="charliteral">'/'</span>;
00628     strcpy((<span class="keywordtype">char</span> *)(name+size),baseName);
00629 
00630     <a class="code" href="group__keyname.html#ga0">keySetName</a>(returned,name);
00631 
00632     <span class="keywordflow">return</span> <a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(returned);
00633 }
00634 
00635 
00636 
00637 
00638 
<a name="l00721"></a><a class="code" href="group__kdb.html#ga10">00721</a> ssize_t <a class="code" href="group__kdb.html#ga10">kdbGetKeyChildKeys</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *parentKey, <a class="code" href="struct__KeySet.html">KeySet</a> *returned, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> options) {
00722     
00723     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbGetKeyChildKeys)
00724         <span class="keywordflow">return</span> backend-&gt;kdbGetKeyChildKeys(parentKey,returned,options);
00725     <span class="keywordflow">else</span> {
00726         errno=KDB_RET_NOSYS;
00727         <span class="keywordflow">return</span> -1;
00728     }
00729 }
00730 
00731 
00732 
<a name="l00738"></a><a class="code" href="group__kdb.html#ga11">00738</a> ssize_t <a class="code" href="group__kdb.html#ga11">kdbGetChildKeys</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *parentName, <a class="code" href="struct__KeySet.html">KeySet</a> *returned, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> options) {
00739     <a class="code" href="struct__Key.html">Key</a> *parentKey;
00740     ssize_t rc;
00741     
00742     parentKey=<a class="code" href="group__key.html#ga0">keyNew</a>(parentName,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00743     rc=<a class="code" href="group__kdb.html#ga10">kdbGetKeyChildKeys</a>(parentKey,returned,options);
00744     
00745     <a class="code" href="group__key.html#ga1">keyDel</a>(parentKey);
00746     
00747     <span class="keywordflow">return</span> rc;
00748 }
00749 
00750 
00751 
<a name="l00763"></a><a class="code" href="group__kdb.html#ga12">00763</a> ssize_t <a class="code" href="group__kdb.html#ga12">kdbGetRootKeys</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *returned) {
00764     <a class="code" href="struct__Key.html">Key</a> *system=0,*user=0;
00765 
00766     user=<a class="code" href="group__key.html#ga0">keyNew</a>(<span class="stringliteral">"user"</span>,<a class="code" href="group__key.html#gga7a24">KEY_SWITCH_NEEDSYNC</a>,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00767     <span class="keywordflow">if</span> (user-&gt;flags &amp; KEY_SWITCH_FLAG) {
00768         <a class="code" href="group__key.html#ga1">keyDel</a>(user);
00769         user=0;
00770     } <span class="keywordflow">else</span> <a class="code" href="group__keyset.html#ga12">ksInsert</a>(returned,user);
00771 
00772     system=<a class="code" href="group__key.html#ga0">keyNew</a>(<span class="stringliteral">"system"</span>,<a class="code" href="group__key.html#gga7a24">KEY_SWITCH_NEEDSYNC</a>,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00773     <span class="keywordflow">if</span> (system-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_FLAG) {
00774         <a class="code" href="group__key.html#ga1">keyDel</a>(system);
00775         system=0;
00776     } <span class="keywordflow">else</span> <a class="code" href="group__keyset.html#ga12">ksInsert</a>(returned,system);
00777 
00778     <span class="keywordflow">return</span> returned-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>;
00779 }
00780 
00781 
00782 
<a name="l00801"></a><a class="code" href="group__kdb.html#ga13">00801</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga13">kdbStatKey</a>(<a class="code" href="struct__Key.html">Key</a> *key) {
00802     <span class="keywordtype">int</span> rc=0;
00803     
00804     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbStatKey)
00805         rc=backend-&gt;kdbStatKey(key);
00806     <span class="keywordflow">else</span> {
00807         errno=KDB_RET_NOSYS;
00808         <span class="keywordflow">return</span> -1;
00809     }
00810     
00811     <span class="keywordflow">return</span> rc;
00812 }
00813 
00814 
00815 
<a name="l00825"></a><a class="code" href="group__kdb.html#ga14">00825</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(<a class="code" href="struct__Key.html">Key</a> *key) {
00826     <span class="keywordtype">int</span> rc=0;
00827     
00828     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbGetKey)
00829         rc=backend-&gt;kdbGetKey(key);
00830     <span class="keywordflow">else</span> {
00831         errno=KDB_RET_NOSYS;
00832         <span class="keywordflow">return</span> -1;
00833     }
00834     
00835     <span class="keywordflow">return</span> rc;
00836 }
00837 
00838 
00839 
<a name="l00859"></a><a class="code" href="group__kdb.html#ga15">00859</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga15">kdbSetKeys</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
00860     <span class="keywordtype">int</span> rc=0;
00861     
00862     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbSetKeys)
00863         rc=backend-&gt;kdbSetKeys(ks);
00864     <span class="keywordflow">else</span> {
00865         errno=KDB_RET_NOSYS;
00866         <span class="keywordflow">return</span> -1;
00867     }
00868     
00869     <span class="keywordflow">return</span> rc;
00870 }
00871 
00872 
00873 
<a name="l00884"></a><a class="code" href="group__backend.html#ga4">00884</a> <span class="keywordtype">int</span> <a class="code" href="group__backend.html#ga4">kdbSetKeys_default</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
00885     <a class="code" href="struct__Key.html">Key</a> *current=<a class="code" href="group__keyset.html#ga5">ksCurrent</a>(ks);
00886     <span class="keywordtype">int</span> ret;
00887 
00888     <span class="keywordflow">if</span> (!current) current=<a class="code" href="group__keyset.html#ga4">ksNext</a>(ks);
00889     <span class="keywordflow">while</span> (current) {
00890         <span class="keywordflow">if</span> (<a class="code" href="group__keytest.html#ga8">keyNeedsSync</a>(current))
00891             <span class="keywordflow">if</span> ((ret=<a class="code" href="group__kdb.html#ga16">kdbSetKey</a>(current))) <span class="comment">/* check error */</span>
00892                 <span class="keywordflow">return</span> ret;
00893         
00894         current=<a class="code" href="group__keyset.html#ga4">ksNext</a>(ks);
00895     }
00896 
00897     <span class="keywordflow">return</span> 0;
00898 }
00899 
00900 
00901 
<a name="l00910"></a><a class="code" href="group__kdb.html#ga16">00910</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga16">kdbSetKey</a>(<a class="code" href="struct__Key.html">Key</a> *key) {
00911     <span class="keywordtype">int</span> rc=0;
00912     
00913     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbSetKey)
00914         rc=backend-&gt;kdbSetKey(key);
00915     <span class="keywordflow">else</span> {
00916         errno=KDB_RET_NOSYS;
00917         <span class="keywordflow">return</span> -1;
00918     }
00919     
00920     <span class="keywordflow">return</span> rc;
00921 }
00922 
00923 
00924 
00925 
<a name="l00935"></a><a class="code" href="group__kdb.html#ga17">00935</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga17">kdbRename</a>(<a class="code" href="struct__Key.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *newName) {
00936     <span class="keywordtype">int</span> rc=0;
00937     
00938     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbRename)
00939         rc=backend-&gt;kdbRename(key,newName);
00940     <span class="keywordflow">else</span> {
00941         errno=KDB_RET_NOSYS;
00942         <span class="keywordflow">return</span> -1;
00943     }
00944     
00945     <span class="keywordflow">return</span> rc;
00946 }
00947 
00948 
00949 
<a name="l00960"></a><a class="code" href="group__kdb.html#ga18">00960</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga18">kdbRemoveKey</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
00961     <span class="keywordtype">int</span> rc=0;
00962     
00963     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbRemoveKey)
00964         rc=backend-&gt;kdbRemoveKey(key);
00965     <span class="keywordflow">else</span> {
00966         errno=KDB_RET_NOSYS;
00967         <span class="keywordflow">return</span> -1;
00968     }
00969     
00970     <span class="keywordflow">return</span> rc;
00971 }
00972 
00973 
00974 
<a name="l00985"></a><a class="code" href="group__kdb.html#ga19">00985</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga19">kdbRemove</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyName) {
00986     <span class="keywordtype">int</span> rc=0;
00987     <a class="code" href="struct__Key.html">Key</a> *key=0;
00988     
00989     key=<a class="code" href="group__key.html#ga0">keyNew</a>(<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00990     rc=<a class="code" href="group__keyname.html#ga0">keySetName</a>(key,keyName);
00991     <span class="keywordflow">if</span> (rc == 0) {
00992         <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00993         <span class="keywordflow">return</span> -1; <span class="comment">/* error */</span>
00994     }
00995     
00996     rc=<a class="code" href="group__kdb.html#ga18">kdbRemoveKey</a>(key);
00997     <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00998     
00999     <span class="keywordflow">return</span> rc;
01000 }
01001 
01002 
01003 
01004 
01005 
<a name="l01017"></a><a class="code" href="group__kdb.html#ga20">01017</a> <span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga20">kdbLink</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *oldPath, <span class="keyword">const</span> <span class="keywordtype">char</span> *newKeyName) {
01018     <a class="code" href="struct__Key.html">Key</a> *key;
01019     <span class="keywordtype">int</span> rc;
01020 
01021     key=<a class="code" href="group__key.html#ga0">keyNew</a>(newKeyName,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
01022     <a class="code" href="group__keyvalue.html#ga5">keySetLink</a>(key,oldPath);
01023 
01024     rc=<a class="code" href="group__kdb.html#ga16">kdbSetKey</a>(key);
01025     <a class="code" href="group__key.html#ga1">keyDel</a>(key);
01026 
01027     <span class="keywordflow">return</span> rc;
01028 }
01029 
01030 
01031 
01032 
<a name="l01091"></a><a class="code" href="group__kdb.html#ga21">01091</a> u_int32_t <a class="code" href="group__kdb.html#ga21">kdbMonitorKeys</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *interests, u_int32_t diffMask,
01092         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> iterations, <span class="keywordtype">unsigned</span> sleep) {
01093     
01094     u_int32_t rc=0;
01095     
01096     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbMonitorKeys)
01097         rc=backend-&gt;kdbMonitorKeys(interests,diffMask,iterations,sleep);
01098     <span class="keywordflow">else</span> {
01099         errno=KDB_RET_NOSYS;
01100         <span class="keywordflow">return</span> 0;
01101     }
01102     
01103     <span class="keywordflow">return</span> rc;
01104 }
01105 
01106 
<a name="l01114"></a><a class="code" href="group__backend.html#ga5">01114</a> u_int32_t <a class="code" href="group__backend.html#ga5">kdbMonitorKeys_default</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *interests, u_int32_t diffMask,
01115         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> iterations, <span class="keywordtype">unsigned</span> sleep) {
01116     <a class="code" href="struct__Key.html">Key</a> *start,*current;
01117     u_int32_t diff;
01118     <span class="keywordtype">int</span> infinitum=0;
01119 
01120     <span class="keywordflow">if</span> (!interests || !interests-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>) <span class="keywordflow">return</span> 0;
01121 
01122     <span class="comment">/* Unacceptable 0 usecs sleep. Defaults to 1 second */</span>
01123     <span class="keywordflow">if</span> (!sleep) sleep=1000;
01124 
01125     <span class="keywordflow">if</span> (!iterations) infinitum=1;
01126     <span class="keywordflow">else</span> infinitum=0;
01127 
01128     current=start=<a class="code" href="group__keyset.html#ga5">ksCurrent</a>(interests);
01129 
01130     <span class="keywordflow">while</span> (infinitum || --iterations) {
01131         <span class="keywordflow">do</span> {
01132             diff=<a class="code" href="group__kdb.html#ga22">kdbMonitorKey</a>(current,diffMask,1,0);
01133             <span class="keywordflow">if</span> (diff) <span class="keywordflow">return</span> diff;
01134             current=<a class="code" href="group__keyset.html#ga4">ksNext</a>(interests);
01135         } <span class="keywordflow">while</span> (current!=start);
01136 
01137         <span class="comment">/* Test if some iterations left . . . */</span>
01138         <span class="keywordflow">if</span> (infinitum || iterations) usleep(sleep);
01139     }
01140     <span class="keywordflow">return</span> 0;
01141 }
01142 
01143 
01144 
<a name="l01184"></a><a class="code" href="group__kdb.html#ga22">01184</a> u_int32_t <a class="code" href="group__kdb.html#ga22">kdbMonitorKey</a>(<a class="code" href="struct__Key.html">Key</a> *interest, u_int32_t diffMask,
01185         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> iterations, <span class="keywordtype">unsigned</span> sleep) {
01186     
01187     <span class="keywordtype">int</span> rc=0;
01188     
01189     <span class="keywordflow">if</span> (backend &amp;&amp; backend-&gt;kdbMonitorKey)
01190         rc=backend-&gt;kdbMonitorKey(interest,diffMask,iterations,sleep);
01191     <span class="keywordflow">else</span> {
01192         errno=KDB_RET_NOSYS;
01193         <span class="keywordflow">return</span> 0;
01194     }
01195     
01196     <span class="keywordflow">return</span> rc;
01197 }
01198 
01199 
01200 
01201 
<a name="l01209"></a><a class="code" href="group__backend.html#ga6">01209</a> u_int32_t <a class="code" href="group__backend.html#ga6">kdbMonitorKey_default</a>(<a class="code" href="struct__Key.html">Key</a> *interest, u_int32_t diffMask,
01210         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> iterations, <span class="keywordtype">unsigned</span> sleep) {
01211     <a class="code" href="struct__Key.html">Key</a> *tested;
01212     <span class="keywordtype">int</span> rc;
01213     u_int32_t diff;
01214     <span class="keywordtype">int</span> infinitum=0;
01215 
01216     <span class="comment">/* consistency */</span>
01217     <span class="keywordflow">if</span> (!interest || !<a class="code" href="group__keyname.html#ga3">keyGetNameSize</a>(interest)) <span class="keywordflow">return</span> 0;
01218 
01219     <span class="comment">/* Unacceptable 0 usecs sleep. Defaults to 1 second */</span>
01220     <span class="keywordflow">if</span> (!sleep) sleep=1000;
01221 
01222     <span class="keywordflow">if</span> (!iterations) infinitum=1;
01223     <span class="keywordflow">else</span> infinitum=0;
01224 
01225     <span class="comment">/* Work with a copy of the key */</span>
01226     tested=<a class="code" href="group__key.html#ga0">keyNew</a>(0);
01227     <a class="code" href="group__key.html#ga2">keyDup</a>(interest,tested);
01228 
01229     <span class="keywordflow">while</span> (infinitum || --iterations) {
01230         rc=<a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(tested);
01231         <span class="keywordflow">if</span> (rc) {
01232             <span class="comment">/* check what type of problem happened.... */</span>
01233             <span class="keywordflow">switch</span> (errno) {
01234                 <span class="keywordflow">case</span> <a class="code" href="group__kdb.html#gga23a56">KDB_RET_NOCRED</a>:
01235                     <a class="code" href="group__key.html#ga1">keyDel</a>(tested);
01236                     <span class="keywordflow">return</span> KEY_SWITCH_NEEDSYNC;
01237                 <span class="keywordflow">case</span> <a class="code" href="group__kdb.html#gga23a48">KDB_RET_NOTFOUND</a>:
01238                     <a class="code" href="group__key.html#ga1">keyDel</a>(tested);
01239                     <span class="keywordflow">return</span> KEY_SWITCH_FLAG;
01240             }
01241         }
01242         
01243         diff=<a class="code" href="group__keytest.html#ga9">keyCompare</a>(tested,interest);
01244         
01245         <span class="keywordflow">if</span> (diff &amp; diffMask) {
01246             <span class="comment">/* If differences interests us, return it, otherwise cycle again.</span>
01247 <span class="comment">             * We don't loose the original key context in a KeySet because</span>
01248 <span class="comment">             * we worked with a copy of the key.</span>
01249 <span class="comment">             */</span>
01250             <a class="code" href="group__key.html#ga2">keyDup</a>(tested,interest);
01251             <a class="code" href="group__key.html#ga1">keyDel</a>(tested);
01252             <span class="keywordflow">return</span> diff;
01253         }
01254         <span class="comment">/* Test if some iterations left . . . */</span>
01255         <span class="keywordflow">if</span> (infinitum || iterations) usleep(sleep);
01256     }
01257     
01258     <a class="code" href="group__key.html#ga1">keyDel</a>(tested);
01259 
01260     <span class="keywordflow">return</span> 0;
01261 }
01262 
01263 
01264 
<a name="l01336"></a><a class="code" href="group__backend.html#ga7">01336</a> KDBBackend *<a class="code" href="group__backend.html#ga7">kdbBackendExport</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *backendName, ...) {
01337     va_list va;
01338     KDBBackend *returned;
01339     u_int32_t method=0;
01340 
01341     <span class="keywordflow">if</span> (backendName == 0) <span class="keywordflow">return</span> 0;
01342     
01343     returned=malloc(<span class="keyword">sizeof</span>(KDBBackend));
01344     memset(returned,0,<span class="keyword">sizeof</span>(KDBBackend));
01345     
01346     returned-&gt;name=(<span class="keywordtype">char</span> *)malloc(<a class="code" href="group__backend.html#ga8">strblen</a>(backendName));
01347     strcpy(returned-&gt;name,backendName);
01348     
01349     <span class="comment">/* Start processing parameters */</span>
01350     
01351     va_start(va,backendName);
01352 
01353     <span class="keywordflow">while</span> ((method=va_arg(va,u_int32_t))) {
01354         <span class="keywordflow">switch</span> (method) {
01355             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a2">KDB_BE_OPEN</a>:
01356                 returned-&gt;kdbOpen=va_arg(va,<span class="keywordtype">int</span> (*)());
01357                 <span class="keywordflow">break</span>;
01358             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a3">KDB_BE_CLOSE</a>:
01359                 returned-&gt;kdbClose=va_arg(va,<span class="keywordtype">int</span> (*)());
01360                 <span class="keywordflow">break</span>;
01361             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a4">KDB_BE_STATKEY</a>:
01362                 returned-&gt;kdbStatKey=va_arg(va,<span class="keywordtype">int</span> (*)(<a class="code" href="struct__Key.html">Key</a> *));
01363                 <span class="keywordflow">break</span>;
01364             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a5">KDB_BE_GETKEY</a>:
01365                 returned-&gt;kdbGetKey=va_arg(va,<span class="keywordtype">int</span> (*)(Key *));
01366                 <span class="keywordflow">break</span>;
01367             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a6">KDB_BE_SETKEY</a>:
01368                 returned-&gt;kdbSetKey=va_arg(va,<span class="keywordtype">int</span> (*)(Key *));
01369                 <span class="keywordflow">break</span>;
01370             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a8">KDB_BE_RENAME</a>:
01371                 returned-&gt;kdbRename=va_arg(va,<span class="keywordtype">int</span> (*)(Key *, <span class="keyword">const</span> <span class="keywordtype">char</span> *));
01372                 <span class="keywordflow">break</span>;
01373             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a9">KDB_BE_REMOVEKEY</a>:
01374                 returned-&gt;kdbRemoveKey=va_arg(va,<span class="keywordtype">int</span> (*)(<span class="keyword">const</span> Key *));
01375                 <span class="keywordflow">break</span>;
01376             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a10">KDB_BE_GETCHILD</a>:
01377                 returned-&gt;kdbGetKeyChildKeys=
01378                     va_arg(va,<span class="keywordtype">int</span> (*)(<span class="keyword">const</span> Key *, <a class="code" href="struct__KeySet.html">KeySet</a> *, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>));
01379                 <span class="keywordflow">break</span>;
01380             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a7">KDB_BE_SETKEYS</a>:
01381                 returned-&gt;kdbSetKeys=va_arg(va,<span class="keywordtype">int</span> (*)(<a class="code" href="struct__KeySet.html">KeySet</a> *));
01382                 <span class="keywordflow">break</span>;
01383             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a11">KDB_BE_MONITORKEY</a>:
01384                 returned-&gt;kdbMonitorKey=
01385                     va_arg(va,u_int32_t (*)(Key *, u_int32_t,<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>, <span class="keywordtype">unsigned</span>));
01386                 <span class="keywordflow">break</span>;
01387             <span class="keywordflow">case</span> <a class="code" href="group__backend.html#gga21a12">KDB_BE_MONITORKEYS</a>:
01388                 returned-&gt;kdbMonitorKeys=
01389                     va_arg(va,u_int32_t (*)(KeySet *, u_int32_t,<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>, <span class="keywordtype">unsigned</span>));
01390                 <span class="keywordflow">break</span>;
01391         }
01392     }
01393     va_end(va);
01394     
01395     <span class="keywordflow">return</span> returned;
01396 }
01397 
01398 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Jul 30 09:10:59 2005 for Elektra Project by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
