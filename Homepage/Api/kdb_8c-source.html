<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Elektra Project: kdb.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>kdb.c</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment">                          kdb.c  -  Tool for the kdb administration</span>
00003 <span class="comment">                             -------------------</span>
00004 <span class="comment">    begin                : Mon Mar 02 2003</span>
00005 <span class="comment">    copyright            : (C) 2003 by Avi Alkalay</span>
00006 <span class="comment">    email                : avi@unix.sh</span>
00007 <span class="comment"> ***************************************************************************/</span>
00008 
00009 <span class="comment">/***************************************************************************</span>
00010 <span class="comment"> *                                                                         *</span>
00011 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
00012 <span class="comment"> *   it under the terms of the BSD License (revised).                      *</span>
00013 <span class="comment"> *                                                                         *</span>
00014 <span class="comment"> ***************************************************************************/</span>
00015 
00016 
00017 <span class="comment">/* Subversion stuff</span>
00018 <span class="comment"></span>
00019 <span class="comment">$Id: kdb.c 252 2005-07-30 11:58:10Z aviram $</span>
00020 <span class="comment">$LastChangedBy: aviram $</span>
00021 <span class="comment"></span>
00022 <span class="comment">*/</span>
00023 
00024 
00025 
00026 
00027 
00028 <span class="preprocessor">#include "kdb.h"</span>
00029 
00030 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00031 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00032 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00033 <span class="preprocessor">#include &lt;time.h&gt;</span>
00034 <span class="preprocessor">#include &lt;locale.h&gt;</span>
00035 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00036 <span class="preprocessor">#include &lt;string.h&gt;</span>
00037 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00038 <span class="preprocessor">#include &lt;grp.h&gt;</span>
00039 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
00040 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00041 <span class="preprocessor">#include &lt;dlfcn.h&gt;</span>
00042 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00043 
00044 
00045 <span class="preprocessor">#define CMD_GET       1</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#define CMD_SET       2</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#define CMD_REMOVE    3</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#define CMD_LIST      4</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#define CMD_LINK      5</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#define CMD_EDIT      6</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#define CMD_LOAD      7</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#define CMD_SAVE      8</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#define CMD_MONITOR   9</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#define CMD_MOVE      10</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#define CMD_HELP      30</span>
00056 <span class="preprocessor"></span>
00057 <span class="preprocessor">#define ARGSIZE      30</span>
00058 <span class="preprocessor"></span>
00059 
00060 <span class="comment">/* we are cheating . . . */</span>
00061 ssize_t <a class="code" href="group__backend.html#ga0">unencode</a>(<span class="keywordtype">char</span> *encoded, <span class="keywordtype">void</span> *returned);
00062 
00063 
00064 <span class="comment">/* We'll load this methods dynamically to avoid libxml dependencies */</span>
00065 int (*ksFromXMLfile)(<a class="code" href="struct__KeySet.html">KeySet</a> *ks,<span class="keywordtype">char</span> *filename);
00066 int (*ksFromXML)(<a class="code" href="struct__KeySet.html">KeySet</a> *ks,<span class="keywordtype">int</span> fd);
00067 
00068 
00069 
00077 <span class="keywordtype">char</span> *argComment=0;
00078 <span class="keywordtype">char</span> *argFile=0;
00079 <span class="keywordtype">char</span> *argData=0;
00080 <span class="keywordtype">char</span> *argKeyName=0;
00081 <span class="keywordtype">char</span> *argDomain=0;
00082 uid_t *argUID=0;
00083 uid_t *argGID=0;
00084 <span class="keywordtype">int</span> argCommand=0;
00085 <span class="keywordtype">int</span> argRecursive=0;
00086 <span class="keywordtype">int</span> argLong=0;
00087 <span class="keywordtype">int</span> argValue=0;
00088 <span class="keywordtype">int</span> argAll=0;
00089 <span class="keywordtype">int</span> argSort=1;
00090 <span class="keywordtype">int</span> argDescriptive=0;
00091 <span class="keywordtype">int</span> argFullName=0;
00092 <span class="keywordtype">int</span> argShow=1;
00093 <span class="keywordtype">int</span> argShell=0;
00094 <span class="keywordtype">int</span> argXML=0;
00095 mode_t argMode=0;
00096 <span class="keywordtype">int</span> argType=KEY_TYPE_UNDEFINED;
00097 
00098 
00099 <span class="keywordtype">int</span> parseCommandLine(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {
00100     <span class="keywordtype">char</span> sargType[ARGSIZE],argUser[ARGSIZE],argGroup[ARGSIZE];
00101     <span class="keywordtype">char</span> sargMode[ARGSIZE],sargCommand[ARGSIZE];
00102     <span class="keywordtype">char</span> * keyEnv;
00103     size_t keyEnvLength=0, keyOptLength=0;
00104 
00105     <span class="keywordtype">int</span> opt;
00106 
00107     <span class="keywordtype">int</span> test;
00108 
00109     *sargType=*argUser=*argGroup=*sargCommand=*sargMode=0;
00110 
00111     <span class="keywordflow">while</span> ((opt=getopt(argc,argv,<span class="stringliteral">"-t:c:u:g:m:b:raflvRdxsi"</span>))!=-1) {
00112         <span class="keywordflow">switch</span> (opt) {
00113             <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
00114                 strncpy(sargType,optarg,ARGSIZE);
00115                 <span class="keywordflow">break</span>;
00116             <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
00117                 argComment=realloc(argComment,strlen(optarg)+1);
00118                 assert(argComment!=NULL);
00119                 strcpy(argComment,optarg);
00120                 <span class="keywordflow">break</span>;
00121             <span class="keywordflow">case</span> <span class="charliteral">'b'</span>:
00122                 argFile=realloc(argFile,strlen(optarg)+1);
00123                 assert(argFile!=NULL);
00124                 strcpy(argFile,optarg);
00125                 <span class="keywordflow">break</span>;
00126             <span class="keywordflow">case</span> <span class="charliteral">'u'</span>:
00127                 strncpy(argUser,optarg,ARGSIZE);
00128                 <span class="keywordflow">break</span>;
00129             <span class="keywordflow">case</span> <span class="charliteral">'g'</span>:
00130                 strncpy(argGroup,optarg,ARGSIZE);
00131                 <span class="keywordflow">break</span>;
00132             <span class="keywordflow">case</span> <span class="charliteral">'m'</span>:
00133                 strncpy(sargMode,optarg,ARGSIZE);
00134                 <span class="keywordflow">break</span>;
00135             <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
00136                 argRecursive=KDB_O_RECURSIVE;
00137                 <span class="keywordflow">break</span>;
00138             <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
00139                 argLong=1;
00140                 <span class="keywordflow">break</span>;
00141             <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
00142                 argValue=1;
00143                 <span class="keywordflow">break</span>;
00144             <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00145                 argDescriptive=1;
00146                 argLong=1;
00147                 <span class="keywordflow">break</span>;
00148             <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
00149                 argAll=1;
00150                 <span class="keywordflow">break</span>;
00151             <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00152                 argShell=1;
00153                 <span class="keywordflow">break</span>;
00154             <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
00155                 argFullName=1;
00156                 <span class="keywordflow">break</span>;
00157             <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
00158                 argSort=0;
00159                 <span class="keywordflow">break</span>;
00160             <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00161                 argShow=0;
00162                 <span class="keywordflow">break</span>;
00163             <span class="keywordflow">case</span> <span class="charliteral">'x'</span>:
00164                 argXML=1;
00165                 <span class="keywordflow">break</span>;
00166             <span class="keywordflow">case</span> 1: { <span class="comment">/* handle non '-x' args */</span>
00167                 test=optind;
00168                 <span class="keywordflow">if</span> (*sargCommand==0) { <span class="comment">/* parse sub-command */</span>
00169                     strncpy(sargCommand,optarg,ARGSIZE);
00170                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!argKeyName) { <span class="comment">/* parse key name */</span>
00171                     keyEnv = getenv (<span class="stringliteral">"KDB_ROOT"</span>);
00172                     <span class="keywordflow">if</span> (keyEnv) keyEnvLength += <a class="code" href="group__backend.html#ga8">strblen</a> (keyEnv);
00173                     <span class="keywordflow">else</span> keyEnvLength = 0;
00174                     keyOptLength = <a class="code" href="group__backend.html#ga8">strblen</a> (optarg);
00175                     argKeyName=realloc(argKeyName,
00176                         keyEnvLength + keyOptLength + 1);
00177                     assert(argKeyName!=NULL);
00178                     <span class="keywordflow">if</span> (keyEnv) strncpy (argKeyName, keyEnv,   keyEnvLength);
00179                     strncpy(argKeyName + keyEnvLength, optarg, keyOptLength);
00180                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!argData) { <span class="comment">/* parse value */</span>
00181                     argData=realloc(argData,<a class="code" href="group__backend.html#ga8">strblen</a>(optarg)+1);
00182                     assert(argData!=NULL);
00183                     strcpy(argData,optarg);
00184                 }
00185                 <span class="keywordflow">break</span>;
00186             }
00187         }
00188     }
00189     test=optind;
00190 
00191     <span class="comment">/* Now check if we have the '--' argument, and get all its values */</span>
00192     <span class="keywordflow">if</span> (!strcmp(argv[optind-1],<span class="stringliteral">"--"</span>) &amp;&amp; optind&lt;argc) {
00193         <span class="keywordtype">int</span> wordind=optind;
00194         size_t valueLength=0;
00195 
00196         <span class="keywordflow">while</span> (wordind&lt;argc) valueLength+=strlen(argv[wordind++])+1;
00197         argData=realloc(argData,valueLength);
00198         assert(argData!=NULL);
00199         strcpy(argData,argv[optind++]);
00200         <span class="comment">/* very ugly */</span>
00201         <span class="keywordflow">while</span> (optind&lt;argc) sprintf(argData,<span class="stringliteral">"%s %s"</span>,argData,argv[optind++]);
00202     }
00203 
00204     <span class="comment">/* End of command line argument reading. Now parse and finalize */</span>
00205 
00206     <span class="comment">/* Check parsed command */</span>
00207     <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"ls"</span>)) argCommand=CMD_LIST;
00208     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"set"</span>)) argCommand=CMD_SET;
00209     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"get"</span>)) argCommand=CMD_GET;
00210     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"ln"</span>)) argCommand=CMD_LINK;
00211     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"rm"</span>)) argCommand=CMD_REMOVE;
00212     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"vi"</span>)) argCommand=CMD_EDIT;
00213     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"edit"</span>)) argCommand=CMD_EDIT;
00214     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"load"</span>)) argCommand=CMD_LOAD;
00215     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"import"</span>)) argCommand=CMD_LOAD;
00216     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"save"</span>)) argCommand=CMD_SAVE;
00217     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"export"</span>)) argCommand=CMD_SAVE;
00218     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"mon"</span>)) argCommand=CMD_MONITOR;
00219     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"monitor"</span>)) argCommand=CMD_MONITOR;
00220     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"mv"</span>)) argCommand=CMD_MOVE;
00221     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargCommand,<span class="stringliteral">"help"</span>)) argCommand=CMD_HELP;
00222     <span class="keywordflow">else</span> {
00223         fprintf(stderr,<span class="stringliteral">"kdb: Invalid subcommand.\n"</span>);
00224         exit(1);
00225     }
00226 
00227     <span class="comment">/* Parse type */</span>
00228     <span class="keywordflow">if</span> (*sargType!=0) {
00229         <span class="comment">/* TODO: use regex */</span>
00230         <span class="keywordflow">if</span>      (!strcmp(sargType,<span class="stringliteral">"string"</span>)) argType=KEY_TYPE_STRING;
00231         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargType,<span class="stringliteral">"bin"</span>))    argType=KEY_TYPE_BINARY;
00232         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargType,<span class="stringliteral">"binary"</span>)) argType=KEY_TYPE_BINARY;
00233         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargType,<span class="stringliteral">"dir"</span>))    argType=KEY_TYPE_DIR;
00234         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(sargType,<span class="stringliteral">"link"</span>))   argType=KEY_TYPE_LINK;
00235         <span class="keywordflow">else</span> {
00236             argType=strtol(sargType,0,10);
00237             <span class="keywordflow">if</span> (errno == ERANGE || errno == EINVAL)
00238                 <span class="comment">/* handle undefined later */</span>
00239                 argType=KEY_TYPE_UNDEFINED;
00240         }
00241     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argCommand==CMD_SET) { <span class="comment">/* We must have a type */</span>
00242         argType=KEY_TYPE_STRING;
00243     }
00244 
00245 
00246     <span class="comment">/* Parse UID */</span>
00247     <span class="keywordflow">if</span> (*argUser) {
00248         <span class="keywordflow">if</span> (isdigit(*argUser)) {
00249             argUID=malloc(<span class="keyword">sizeof</span>(uid_t));
00250             *argUID=atoi(argUser);
00251         } <span class="keywordflow">else</span> {
00252             <span class="keyword">struct </span>passwd *pwd;
00253             pwd=getpwnam(argUser);
00254             <span class="keywordflow">if</span> (pwd) {
00255                 argUID=malloc(<span class="keyword">sizeof</span>(uid_t));
00256                 *argUID=pwd-&gt;pw_uid;
00257             } <span class="keywordflow">else</span> {
00258                 fprintf(stderr,<span class="stringliteral">"kdb: Invalid user \'%s\'. Ignoring\n"</span>, argUser);
00259             }
00260         }
00261     }
00262 
00263 
00264     <span class="comment">/* Parse GID */</span>
00265     <span class="keywordflow">if</span> (*argGroup) {
00266         <span class="keywordflow">if</span> (isdigit(*argGroup)) {
00267             argGID=malloc(<span class="keyword">sizeof</span>(gid_t));
00268             *argGID=atoi(argGroup);
00269         } <span class="keywordflow">else</span> {
00270             <span class="keyword">struct </span>group *grp;
00271             grp=getgrnam(argGroup);
00272             <span class="keywordflow">if</span> (grp) {
00273                 argGID=malloc(<span class="keyword">sizeof</span>(gid_t));
00274                 *argGID=grp-&gt;gr_gid;
00275             } <span class="keywordflow">else</span> {
00276                 fprintf(stderr,<span class="stringliteral">"kdb: Invalid group \'%s\'. Ignoring\n"</span>,argGroup);
00277             }
00278         }
00279     }
00280 
00281 
00282 
00283     <span class="comment">/* Parse permissions */</span>
00284     <span class="keywordflow">if</span> (*sargMode!=0) argMode=strtol(sargMode,0,8);
00285 
00286     <span class="keywordflow">return</span> argCommand;
00287 }
00288 
00289 
00290 
00291 
00292 
00293 
00294 <span class="comment">/*</span>
00295 <span class="comment"> * Helper for the 'kdb ls' command</span>
00296 <span class="comment"> *</span>
00297 <span class="comment"> */</span>
00298 <span class="keywordtype">void</span> listAccess(<a class="code" href="struct__Key.html">Key</a> *key,<span class="keywordtype">char</span> *readable) {
00299     mode_t mode=<a class="code" href="group__keymeta.html#ga12">keyGetAccess</a>(key);
00300 
00301     <span class="keywordflow">if</span> (S_ISDIR(mode)) readable[0]=<span class="charliteral">'d'</span>;
00302     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISLNK(mode)) readable[0]=<span class="charliteral">'l'</span>;
00303     <span class="keywordflow">else</span> readable[0]=<span class="charliteral">'-'</span>;
00304 
00305     readable[1] = mode &amp; S_IRUSR ? <span class="charliteral">'r'</span> : <span class="charliteral">'-'</span>;
00306     readable[2] = mode &amp; S_IWUSR ? <span class="charliteral">'w'</span> : <span class="charliteral">'-'</span>;
00307     readable[3] = mode &amp; S_IXUSR ? <span class="charliteral">'x'</span> : <span class="charliteral">'-'</span>;
00308     readable[4] = mode &amp; S_IRGRP ? <span class="charliteral">'r'</span> : <span class="charliteral">'-'</span>;
00309     readable[5] = mode &amp; S_IWGRP ? <span class="charliteral">'w'</span> : <span class="charliteral">'-'</span>;
00310     readable[6] = mode &amp; S_IXGRP ? <span class="charliteral">'x'</span> : <span class="charliteral">'-'</span>;
00311     readable[7] = mode &amp; S_IROTH ? <span class="charliteral">'r'</span> : <span class="charliteral">'-'</span>;
00312     readable[8] = mode &amp; S_IWOTH ? <span class="charliteral">'w'</span> : <span class="charliteral">'-'</span>;
00313     readable[9] = mode &amp; S_IXOTH ? <span class="charliteral">'x'</span> : <span class="charliteral">'-'</span>;
00314     readable[10]= 0;
00315 }
00316 
00317 
00318 
00319 
00320 <span class="comment">/*</span>
00321 <span class="comment"> * Helper for the 'kdb ls' command</span>
00322 <span class="comment"> *</span>
00323 <span class="comment"> */</span>
00324 <span class="keywordtype">void</span> listTime(time_t when,<span class="keywordtype">char</span> *readable) {
00325     time_t current_time=time(0);
00326     <span class="keywordtype">char</span> buf[400];
00327     time_t six_months_ago;
00328     <span class="keywordtype">int</span> recent;
00329 
00330     <span class="comment">/* If the file appears to be in the future, update the current</span>
00331 <span class="comment">       time, in case the file happens to have been modified since</span>
00332 <span class="comment">       the last time we checked the clock.  */</span>
00333 
00334     <span class="comment">/* Consider a time to be recent if it is within the past six</span>
00335 <span class="comment">       months.  A Gregorian year has 365.2425 * 24 * 60 * 60 ==</span>
00336 <span class="comment">       31556952 seconds on the average.  Write this value as an</span>
00337 <span class="comment">       integer constant to avoid floating point hassles.  */</span>
00338     six_months_ago = current_time - 31556952 / 2;
00339     recent = (six_months_ago &lt;= when) &amp;&amp; (when &lt;= current_time);
00340 
00341     ctime_r(&amp;when,buf); <span class="comment">/* buf will become "Wed Jun 30 21:49:08 1993\n" */</span>
00342     memcpy(readable,buf+4,7); <span class="comment">/* take only month and day */</span>
00343     <span class="keywordflow">if</span> (recent) {
00344         memcpy(readable,buf+4,12);
00345         readable[12]=0;
00346     } <span class="keywordflow">else</span> {
00347         memcpy(readable,buf+4,7);
00348         readable[7]=<span class="charliteral">' '</span>;
00349         memcpy(readable+8,buf+20,4);
00350         readable[12]=0;
00351     }
00352 }
00353 
00354 
00355 
00356 <span class="comment">/*</span>
00357 <span class="comment"> * Helper for the 'kdb ls' command</span>
00358 <span class="comment"> *</span>
00359 <span class="comment"> */</span>
00360 <span class="keywordtype">void</span> listSingleKey(<a class="code" href="struct__Key.html">Key</a> *key) {
00361     <span class="keywordtype">char</span> buffer[400];
00362     <span class="keywordtype">char</span> *p=buffer;
00363 
00364     <span class="keywordflow">if</span> (argLong) {
00365         <span class="keyword">struct </span>passwd *pwd;
00366         <span class="keyword">struct </span>group *grp;
00367 
00368         listAccess(key,p);
00369         p+=strlen(p);
00370         *p=<span class="charliteral">' '</span>; p++;
00371         *p=<span class="charliteral">' '</span>; p++;
00372         *p=<span class="charliteral">' '</span>; p++;
00373 
00374         pwd=getpwuid(<a class="code" href="group__keymeta.html#ga8">keyGetUID</a>(key));
00375         strcpy(p,pwd-&gt;pw_name);
00376         p+=strlen(p);
00377         *p=<span class="charliteral">' '</span>; p++;
00378         *p=<span class="charliteral">' '</span>; p++;
00379 
00380         grp=getgrgid(<a class="code" href="group__keymeta.html#ga10">keyGetGID</a>(key));
00381         strcpy(p,grp-&gt;gr_name);
00382         p+=strlen(p);
00383         *p=<span class="charliteral">' '</span>; p++;
00384 
00385         sprintf(p,<span class="stringliteral">"%*d "</span>,5,keyGetRecordSize(key));
00386         p+=strlen(p);
00387 
00388         listTime(<a class="code" href="group__keymeta.html#ga14">keyGetMTime</a>(key),p);
00389         p+=strlen(p);
00390         *p=<span class="charliteral">' '</span>; p++;
00391     }
00392     <span class="keywordflow">if</span> (argFullName) <a class="code" href="group__keyname.html#ga7">keyGetFullName</a>(key,p,<span class="keyword">sizeof</span>(buffer)-(p-buffer));
00393     <span class="keywordflow">else</span> <a class="code" href="group__keyname.html#ga4">keyGetName</a>(key,p,<span class="keyword">sizeof</span>(buffer)-(p-buffer));
00394     <span class="keywordflow">if</span> (argValue &amp;&amp; (<a class="code" href="group__keyvalue.html#ga1">keyGetValueSize</a>(key)&gt;0)) {
00395         u_int8_t ktype;
00396 
00397         p+=strlen(p);
00398         *p=<span class="charliteral">'='</span>; p++;
00399 
00400         ktype=<a class="code" href="group__keyvalue.html#ga9">keyGetType</a>(key);
00401         <span class="keywordflow">if</span> (ktype &gt;= KEY_TYPE_STRING)
00402             p+=<a class="code" href="group__keyvalue.html#ga3">keyGetString</a>(key,p,<span class="keyword">sizeof</span>(buffer)-(p-buffer));
00403         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ktype &gt;= KEY_TYPE_BINARY)
00404             p+=sprintf(p,<span class="stringliteral">"&lt;BINARY VALUE&gt;"</span>);
00405         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ktype == KEY_TYPE_LINK)
00406             p+=<a class="code" href="group__keyvalue.html#ga6">keyGetLink</a>(key,p,<span class="keyword">sizeof</span>(buffer)-(p-buffer));
00407 
00408         *p=0;
00409     }
00410     puts(buffer);
00411 }
00412 
00413 
00414 
00415 
00416 
00417 
00418 
00419 
<a name="l00430"></a><a class="code" href="group__libexample.html#ga24">00430</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga24">commandRemove</a>() {
00431     <span class="keywordflow">if</span> (!argKeyName) {
00432         fprintf(stderr,<span class="stringliteral">"kdb rm: No key name\n"</span>);
00433         <span class="keywordflow">return</span> -1;
00434     }
00435 
00436     <span class="keywordflow">if</span> (<a class="code" href="group__kdb.html#ga19">kdbRemove</a>(argKeyName)) {
00437         <span class="keywordtype">char</span> error[300];
00438         
00439         sprintf(error,<span class="stringliteral">"kdb rm: \'%s\'"</span>,argKeyName);
00440         perror(error);
00441         <span class="keywordflow">return</span> -1;
00442     }
00443     <span class="keywordflow">return</span> 0;
00444 }
00445 
00446 
00447 
<a name="l00461"></a><a class="code" href="group__libexample.html#ga25">00461</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga25">commandMove</a>() {
00462     <a class="code" href="struct__Key.html">Key</a> *key;
00463     size_t size=0;
00464     <span class="keywordtype">int</span> rc;
00465     
00466     key=<a class="code" href="group__key.html#ga0">keyNew</a>(argKeyName,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00467     size=<a class="code" href="group__keyname.html#ga3">keyGetNameSize</a>(key);
00468     
00469     <span class="keywordflow">if</span> (size == 0) {
00470         <span class="keywordtype">char</span> error[100];
00471         
00472         sprintf(error,<span class="stringliteral">"kdb mv: \'%s\'"</span>, argKeyName);
00473         perror(error);
00474         
00475         <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00476         <span class="keywordflow">return</span> 1;
00477     }
00478     
00479     rc=<a class="code" href="group__kdb.html#ga17">kdbRename</a>(key,argData);
00480     <span class="keywordflow">if</span> (rc != 0) {
00481         <span class="comment">/* Handle a non-zero rc, with same behavior of Unix mv command */</span>
00482         <span class="keywordflow">switch</span> (errno) {
00483             
00484         }
00485     }
00486     
00487     <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00488     
00489     <span class="keywordflow">return</span> rc;
00490 }
00491 
00492 
00493 
<a name="l00513"></a><a class="code" href="group__libexample.html#ga26">00513</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga26">commandSet</a>() {
00514     <a class="code" href="struct__Key.html">Key</a> *key;
00515     <span class="keywordtype">int</span> ret;
00516     <span class="keywordtype">char</span> error[200];
00517     size_t offset=0;
00518 
00519 
00520     <span class="comment">/* Consistency */</span>
00521     <span class="keywordflow">if</span> (!argKeyName) {
00522         fprintf(stderr,<span class="stringliteral">"kdb set: No key name\n"</span>);
00523         <span class="keywordflow">return</span> -1;
00524     }
00525 
00526     key=<a class="code" href="group__key.html#ga0">keyNew</a>(argKeyName,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00527     ret=<a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(key);
00528     <span class="keywordflow">if</span> (ret == 0) { <span class="comment">/* Key already exists. Good. */</span>
00529         <span class="comment">/* Use existed key type if user didn't give us one */</span>
00530         <span class="keywordflow">if</span> (argType==KEY_TYPE_UNDEFINED) argType=<a class="code" href="group__keyvalue.html#ga9">keyGetType</a>(key);
00531     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno!=KDB_RET_NOTFOUND) {
00532         <span class="comment">/* Handle errors different from NOTFOUND */</span>
00533         sprintf(error,<span class="stringliteral">"kdb set: %s"</span>,argKeyName);
00534         perror(error);
00535     }
00536 
00537     <span class="comment">/* Set or overwrite everything else... */</span>
00538     
00539     <span class="keywordflow">if</span> (argUID) <a class="code" href="group__keymeta.html#ga9">keySetUID</a>(key,*argUID);
00540     <span class="keywordflow">if</span> (argGID) <a class="code" href="group__keymeta.html#ga11">keySetGID</a>(key,*argGID);
00541     <span class="keywordflow">if</span> (argMode) <a class="code" href="group__keymeta.html#ga13">keySetAccess</a>(key,argMode);
00542 
00543     <span class="keywordflow">if</span> (argComment) <a class="code" href="group__keymeta.html#ga4">keySetComment</a>(key,argComment);
00544     
00545     <span class="keywordflow">if</span> (argFile) {
00546         FILE *f;
00547         <span class="keywordtype">int</span> end=0;
00548         
00549         <span class="keywordflow">if</span> (argData) free(argData);
00550         argData=0;
00551         f=fopen(argFile,<span class="stringliteral">"r"</span>);
00552         
00553         <span class="keywordflow">if</span> (!f) {
00554             sprintf(error,<span class="stringliteral">"kdb set: \'%s\'"</span>,argFile);
00555             perror(error);
00556             <span class="keywordflow">return</span> -1;
00557         }
00558         <span class="keywordflow">while</span> (! end) {
00559             <span class="keywordtype">char</span> buffer[100];
00560             ssize_t r;
00561             
00562             r=read(fileno(f),buffer,<span class="keyword">sizeof</span>(buffer));
00563             <span class="keywordflow">if</span> (r == 0) {
00564                 r=lseek(fileno(f),0,SEEK_END)-offset;
00565                 end=1;
00566             }
00567             argData=realloc(argData,offset+r);
00568             assert(argData!=NULL);
00569             memcpy(argData+offset,buffer,r);
00570             offset+=r;
00571         }
00572         fclose(f);
00573     }
00574 
00575 
00576     <span class="comment">/* Set key value . . . */</span>
00577     <span class="keywordflow">if</span> (argType == KEY_TYPE_UNDEFINED)
00578         <a class="code" href="group__keyvalue.html#ga2">keySetString</a>(key,argData); <span class="comment">/* the most common here */</span>
00579     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argType == KEY_TYPE_DIR)
00580         <a class="code" href="group__keyvalue.html#ga10">keySetType</a>(key,<a class="code" href="group__key.html#gga5a8">KEY_TYPE_DIR</a>);
00581     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argType == KEY_TYPE_LINK)
00582         <a class="code" href="group__keyvalue.html#ga5">keySetLink</a>(key,argData);
00583     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argData) { <span class="comment">/* Handle special type values . . . */</span>
00584     
00585         <span class="comment">/* set raw data */</span>
00586         <span class="keywordflow">if</span> (offset) <a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,argData,offset);
00587         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__key.html#gga5a10">KEY_TYPE_BINARY</a> &lt;= argType &amp;&amp; argType &lt; KEY_TYPE_STRING)
00588              <span class="comment">/* command-line-passed bin values have unwanted \0 in the end */</span>
00589              <a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,argData,<a class="code" href="group__backend.html#ga8">strblen</a>(argData)-1);
00590         <span class="keywordflow">else</span> <a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,argData,<a class="code" href="group__backend.html#ga8">strblen</a>(argData));
00591         
00592         <span class="comment">/* set type explicitly */</span>
00593         <a class="code" href="group__keyvalue.html#ga10">keySetType</a>(key,argType);
00594     }
00595 
00596 
00597     ret=<a class="code" href="group__kdb.html#ga16">kdbSetKey</a>(key);
00598     <span class="keywordflow">if</span> (ret) {
00599         sprintf(error,<span class="stringliteral">"kdb set: \'%s\'"</span>,argKeyName);
00600         perror(error);
00601     }
00602     
00603     <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00604     
00605     <span class="keywordflow">return</span> ret;
00606 }
00607 
00608 
00609 
00610 
00611 
00612 
<a name="l00625"></a><a class="code" href="group__libexample.html#ga27">00625</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga27">commandLink</a>() {
00626     <span class="keywordtype">int</span> rc;
00627 
00628     <span class="comment">/* Consistency */</span>
00629     <span class="keywordflow">if</span> (!argKeyName) {
00630         fprintf(stderr,<span class="stringliteral">"kdb ln: No target specified\n"</span>);
00631         <span class="keywordflow">return</span> -1;
00632     }
00633 
00634     <span class="keywordflow">if</span> (!argData) {
00635         fprintf(stderr,<span class="stringliteral">"kdb ln: \'%s\': No destination specified"</span>,argKeyName);
00636         <span class="keywordflow">return</span> -1;
00637     }
00638 
00639     <span class="keywordflow">if</span> ((rc=<a class="code" href="group__kdb.html#ga20">kdbLink</a>(argKeyName,argData))) {
00640         perror(<span class="stringliteral">"kdb ln"</span>);
00641     }
00642 
00643     <span class="keywordflow">return</span> rc;
00644 }
00645 
00646 
00647 
00648 
00649 
00650 
00651 
00652 
00653 
00654 
00655 
00656 
00657 
00658 
<a name="l00679"></a><a class="code" href="group__libexample.html#ga28">00679</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga28">commandList</a>() {
00680     <a class="code" href="struct__KeySet.html">KeySet</a> *ks; <span class="comment">/* this is the container for all keys we'll collect bellow */</span>
00681     ssize_t ret;
00682 
00683     ks=<a class="code" href="group__keyset.html#ga0">ksNew</a>();
00684 
00685     <span class="keywordflow">if</span> (!argKeyName) {
00686         <a class="code" href="struct__KeySet.html">KeySet</a> *roots;
00687         <span class="comment">/* User don't want a specific key, so list the root keys */</span>
00688 
00689         roots=<a class="code" href="group__keyset.html#ga0">ksNew</a>();
00690         <a class="code" href="group__kdb.html#ga12">kdbGetRootKeys</a>(roots);
00691 
00692         <span class="keywordflow">if</span> (argRecursive) {
00693             <a class="code" href="struct__Key.html">Key</a> *walker=0;
00694             
00695             <span class="keywordflow">while</span> ((walker=<a class="code" href="group__keyset.html#ga13">ksPop</a>(roots))) {
00696                 <span class="comment">/* walk root by root, retrieve entire subtree</span>
00697 <span class="comment">                 * and append it to ks</span>
00698 <span class="comment">                 */</span>
00699                 <a class="code" href="struct__KeySet.html">KeySet</a> *thisRoot=<a class="code" href="group__keyset.html#ga0">ksNew</a>();
00700                 
00701                 <span class="keywordflow">if</span> (argValue) ret=<a class="code" href="group__kdb.html#ga10">kdbGetKeyChildKeys</a>(walker,thisRoot,
00702                     (argSort?KDB_O_SORT:0) | (argRecursive?KDB_O_RECURSIVE:0) |
00703                     <a class="code" href="group__kdb.html#gga24a63">KDB_O_DIR</a> | (argAll?KDB_O_INACTIVE:0) | <a class="code" href="group__kdb.html#gga24a69">KDB_O_NFOLLOWLINK</a>);
00704                 <span class="keywordflow">else</span> ret=<a class="code" href="group__kdb.html#ga10">kdbGetKeyChildKeys</a>(walker,thisRoot,
00705                     (argSort?KDB_O_SORT:0) | <a class="code" href="group__kdb.html#gga24a66">KDB_O_STATONLY</a> |
00706                     (argRecursive?KDB_O_RECURSIVE:0) | <a class="code" href="group__kdb.html#gga24a63">KDB_O_DIR</a> |
00707                     (argAll?KDB_O_INACTIVE:0) | <a class="code" href="group__kdb.html#gga24a69">KDB_O_NFOLLOWLINK</a>);
00708                 
00709                 <span class="comment">/* A hack to transfer a key from a keyset to another.</span>
00710 <span class="comment">                 * Don't do this at home.</span>
00711 <span class="comment">                 */</span>
00712                 <a class="code" href="group__keyset.html#ga16">ksAppend</a>(ks,walker);
00713                 <a class="code" href="group__keyset.html#ga17">ksAppendKeys</a>(ks,thisRoot);
00714                 <a class="code" href="group__keyset.html#ga1">ksDel</a>(thisRoot); <span class="comment">/* we don't need the container anymore */</span>
00715             }
00716         } <span class="keywordflow">else</span> <a class="code" href="group__keyset.html#ga17">ksAppendKeys</a>(ks,roots);
00717         <a class="code" href="group__keyset.html#ga1">ksDel</a>(roots);
00718     } <span class="keywordflow">else</span> {
00719         <span class="comment">/* User gave us a specific key to start with */</span>
00720 
00721         <span class="keywordflow">if</span> (argValue) ret=<a class="code" href="group__kdb.html#ga11">kdbGetChildKeys</a>(argKeyName,ks,
00722             (argSort?KDB_O_SORT:0) | (argRecursive?KDB_O_RECURSIVE:0) |
00723             <a class="code" href="group__kdb.html#gga24a63">KDB_O_DIR</a> | (argAll?KDB_O_INACTIVE:0) | <a class="code" href="group__kdb.html#gga24a69">KDB_O_NFOLLOWLINK</a>);
00724         <span class="keywordflow">else</span> ret=<a class="code" href="group__kdb.html#ga11">kdbGetChildKeys</a>(argKeyName,ks,
00725             (argSort?KDB_O_SORT:0) | <a class="code" href="group__kdb.html#gga24a66">KDB_O_STATONLY</a> |
00726             (argRecursive?KDB_O_RECURSIVE:0) | <a class="code" href="group__kdb.html#gga24a63">KDB_O_DIR</a> |
00727             (argAll?KDB_O_INACTIVE:0) | <a class="code" href="group__kdb.html#gga24a69">KDB_O_NFOLLOWLINK</a>);
00728     
00729         <span class="keywordflow">if</span> (ret&lt;0) {
00730             <span class="comment">/* We got an error. Check if it is because its not a folder key */</span>
00731             <span class="keywordflow">if</span> (errno==ENOTDIR) {
00732                 <span class="comment">/* We still have a chance, since there is something there */</span>
00733                 <a class="code" href="struct__Key.html">Key</a> *key=<a class="code" href="group__key.html#ga0">keyNew</a>(argKeyName,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00734                 
00735                 <span class="keywordflow">if</span> (argValue) ret=<a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(key);
00736                 <span class="keywordflow">else</span> ret=<a class="code" href="group__kdb.html#ga13">kdbStatKey</a>(key);
00737                 
00738                 <span class="keywordflow">if</span> (ret == 0) <a class="code" href="group__keyset.html#ga16">ksAppend</a>(ks,key);
00739                 <span class="keywordflow">else</span> {
00740                     <span class="comment">/* There is absolutelly nothing there */</span>
00741                     <span class="keywordtype">char</span> error[200];
00742 
00743                     <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00744                     <a class="code" href="group__keyset.html#ga1">ksDel</a>(ks);
00745                     
00746                     sprintf(error,<span class="stringliteral">"kdb ls: %s"</span>,argKeyName);
00747                     perror(error);
00748                     <span class="keywordflow">return</span> ret;
00749                 }
00750                 
00751             } <span class="keywordflow">else</span> { <span class="comment">/* A real error */</span>
00752                 <span class="keywordtype">char</span> error[200];
00753                 
00754                 <a class="code" href="group__keyset.html#ga1">ksDel</a>(ks);
00755 
00756                 sprintf(error,<span class="stringliteral">"kdb ls: %s"</span>,argKeyName);
00757                 perror(error);
00758                 <span class="keywordflow">return</span> ret;
00759             }
00760         }
00761     }
00762 
00763     <span class="keywordflow">if</span> (argShow) {
00764         size_t listSize=<a class="code" href="group__keyset.html#ga2">ksGetSize</a>(ks);
00765         
00766         <span class="keywordflow">if</span> (argXML) <a class="code" href="group__keyset.html#ga19">ksToStream</a>(ks,stdout,<a class="code" href="group__kdb.html#gga24a72">KDB_O_XMLHEADERS</a> |
00767             (argFullName?(<a class="code" href="group__kdb.html#gga24a73">KDB_O_FULLNAME</a> | <a class="code" href="group__kdb.html#gga24a74">KDB_O_FULLUGID</a>):0));
00768         <span class="keywordflow">else</span> {
00769             <span class="keywordflow">if</span> (listSize == 1) listSingleKey(<a class="code" href="group__keyset.html#ga6">ksHead</a>(ks));
00770             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (listSize &gt; 1) {
00771                 <a class="code" href="struct__Key.html">Key</a> *walker;
00772             
00773                 <a class="code" href="group__keyset.html#ga3">ksRewind</a>(ks);
00774                 <span class="keywordflow">while</span> ((walker=<a class="code" href="group__keyset.html#ga4">ksNext</a>(ks)))
00775                     listSingleKey(walker);
00776             }
00777         }
00778     }
00779 
00780     <a class="code" href="group__keyset.html#ga23">ksClose</a>(ks);
00781     <span class="keywordflow">return</span> 0;
00782 }
00783 
00784 
00785 
00786 
00787 
00788 
00789 
<a name="l00809"></a><a class="code" href="group__libexample.html#ga29">00809</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga29">commandGet</a>() {
00810     <span class="keywordtype">int</span> ret;
00811     <a class="code" href="struct__Key.html">Key</a> *key;
00812     <span class="keywordtype">char</span> *buffer;
00813     <span class="keywordtype">char</span> *p;
00814     size_t size,cs=0;
00815     u_int8_t keyType;
00816 
00817     <span class="keywordflow">if</span> (!argKeyName) {
00818         fprintf(stderr,<span class="stringliteral">"kdb get: No key name\n"</span>);
00819         <span class="keywordflow">return</span> -1;
00820     }
00821 
00822     key=<a class="code" href="group__key.html#ga0">keyNew</a>(argKeyName,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00823     
00824     ret=<a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(key);
00825 
00826     <span class="keywordflow">if</span> (ret) {
00827         <span class="keywordtype">char</span> error[200];
00828 
00829         <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00830         sprintf(error,<span class="stringliteral">"kdb get: %s"</span>,argKeyName);
00831         perror(error);
00832         <span class="keywordflow">return</span> ret;
00833     }
00834     size=<a class="code" href="group__keyvalue.html#ga1">keyGetValueSize</a>(key);
00835     <span class="keywordflow">if</span> (argDescriptive) {
00836         cs=<a class="code" href="group__keymeta.html#ga5">keyGetCommentSize</a>(key);
00837         <span class="keywordflow">if</span> (cs) size+=cs+3;
00838     }
00839     <span class="keywordflow">if</span> (argShell) {
00840         size+=<a class="code" href="group__keyname.html#ga18">keyGetBaseNameSize</a>(key);
00841         size+=2; <span class="comment">/* for 2 '"' to wrap the value */</span>
00842     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argLong) {
00843         <span class="keywordflow">if</span> (argFullName) size+=<a class="code" href="group__keyname.html#ga6">keyGetFullNameSize</a>(key);
00844         <span class="keywordflow">else</span> size+=<a class="code" href="group__keyname.html#ga3">keyGetNameSize</a>(key);
00845     }
00846 
00847 
00848     p=buffer=malloc(size);
00849 
00850 
00851     <span class="keywordflow">if</span> (argDescriptive) {
00852         <span class="keywordflow">if</span> (cs) {
00853             p+=sprintf(p,<span class="stringliteral">"# "</span>);
00854             p+=<a class="code" href="group__keymeta.html#ga6">keyGetComment</a>(key,p,size-(p-buffer));
00855             *--p=<span class="charliteral">'\n'</span>; p++;
00856         }
00857     }
00858     <span class="keywordflow">if</span> (argShell) {
00859         p+=<a class="code" href="group__keyname.html#ga19">keyGetBaseName</a>(key,p,size-(p-buffer));
00860         *--p=<span class="charliteral">'='</span>; p++;
00861         *p=<span class="charliteral">'\"'</span>; p++;
00862     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argLong) {
00863         <span class="keywordflow">if</span> (argFullName) p+=<a class="code" href="group__keyname.html#ga7">keyGetFullName</a>(key,p,size-(p-buffer));
00864         <span class="keywordflow">else</span> p+=<a class="code" href="group__keyname.html#ga4">keyGetName</a>(key,p,size-(p-buffer));
00865         *--p=<span class="charliteral">'='</span>; p++;
00866     }
00867     
00868     keyType=<a class="code" href="group__keyvalue.html#ga9">keyGetType</a>(key);
00869 
00870     <span class="keywordflow">if</span> (<a class="code" href="group__keytest.html#ga7">keyIsBin</a>(key)) p+=<a class="code" href="group__keyvalue.html#ga7">keyGetBinary</a>(key,p,size-(p-buffer));
00871     <span class="keywordflow">else</span> p+=<a class="code" href="group__keyvalue.html#ga3">keyGetString</a>(key,p,size-(p-buffer));
00872     <span class="keywordflow">if</span> (argShell) {
00873         *--p=<span class="charliteral">'\"'</span>; p++;
00874         *p=0;
00875     }
00876     <span class="keywordflow">if</span> (<a class="code" href="group__keytest.html#ga7">keyIsBin</a>(key)) fwrite(buffer,size,1,stdout);
00877     <span class="keywordflow">else</span> printf(<span class="stringliteral">"%s\n"</span>,buffer);
00878 
00879 
00880     free(buffer);
00881     <a class="code" href="group__key.html#ga1">keyDel</a>(key);
00882 
00883     <span class="keywordflow">return</span> 0;
00884 }
00885 
00886 
00887 
00888 
00889 
00890 
00891 
00892 
00893 
00894 
<a name="l00923"></a><a class="code" href="group__libexample.html#ga30">00923</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga30">commandEdit</a>() {
00924     <a class="code" href="struct__KeySet.html">KeySet</a> *ks;
00925     <a class="code" href="struct__KeySet.html">KeySet</a> *ksEdited;
00926     <a class="code" href="struct__KeySet.html">KeySet</a> *toRemove;
00927     <a class="code" href="struct__Key.html">Key</a> *current;
00928     <span class="keywordtype">int</span> ret;
00929     <span class="keywordtype">char</span> filename[]=<span class="stringliteral">"/var/tmp/kdbeditXXXXXX"</span>;
00930     <span class="keywordtype">char</span> command[300];
00931     FILE *xmlfile=0;
00932     <span class="keywordtype">char</span> choice[5];
00933 
00934     <span class="keywordflow">if</span> (!ksFromXMLfile) <span class="keywordflow">return</span> 1;
00935     
00936     ks=<a class="code" href="group__keyset.html#ga0">ksNew</a>();
00937 
00938     <a class="code" href="group__kdb.html#ga11">kdbGetChildKeys</a>(argKeyName,ks, <a class="code" href="group__kdb.html#gga24a68">KDB_O_SORT</a> | <a class="code" href="group__kdb.html#gga24a69">KDB_O_NFOLLOWLINK</a> |
00939         (argAll?KDB_O_INACTIVE:0) | (argRecursive?KDB_O_RECURSIVE:0));
00940 
00941     <span class="keywordflow">if</span> (! <a class="code" href="group__keyset.html#ga2">ksGetSize</a>(ks)) {
00942         <span class="comment">/* Maybe the user parameter is not a parent key, but a single key */</span>
00943         current=<a class="code" href="group__key.html#ga0">keyNew</a>(argKeyName,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
00944         <span class="keywordflow">if</span> (<a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(current)) {
00945             <span class="comment">/* Failed. Cleanup */</span>
00946             <a class="code" href="group__key.html#ga1">keyDel</a>(current);
00947             current=0;
00948         } <span class="keywordflow">else</span> {
00949             <span class="comment">/* We have something. */</span>
00950             <a class="code" href="group__keyset.html#ga16">ksAppend</a>(ks,current);
00951             current=0;
00952         }
00953     }
00954 
00955 <span class="comment">/*</span>
00956 <span class="comment">    for (current=ks.start; current; current=current-&gt;next) {</span>
00957 <span class="comment">        if (keyNeedsSync(current)) {</span>
00958 <span class="comment">            printf("%s needs sync\n",current-&gt;key);</span>
00959 <span class="comment">        }</span>
00960 <span class="comment">    }</span>
00961 <span class="comment">*/</span>
00962 
00963     xmlfile=fdopen(mkstemp(filename),<span class="stringliteral">"rw+"</span>);
00964 
00965     <a class="code" href="group__keyset.html#ga19">ksToStream</a>(ks,xmlfile,<a class="code" href="group__kdb.html#gga24a72">KDB_O_XMLHEADERS</a> | 
00966         (argFullName?(<a class="code" href="group__kdb.html#gga24a73">KDB_O_FULLNAME</a> | <a class="code" href="group__kdb.html#gga24a74">KDB_O_FULLUGID</a>):0));
00967     fclose(xmlfile);
00968 
00969     <span class="keywordflow">do</span> 
00970         {
00971     <span class="comment">/* execute the editor and wait for it to finish */</span>
00972     sprintf(command,<span class="stringliteral">"[ -z \"$EDITOR\" ] &amp;&amp; EDITOR=vi; $EDITOR %s"</span>,filename);
00973     system(command);
00974 
00975     toRemove=<a class="code" href="group__keyset.html#ga0">ksNew</a>();
00976     ksEdited=<a class="code" href="group__keyset.html#ga0">ksNew</a>();
00977 
00978     <span class="comment">/* ksFromXML is not a library function.</span>
00979 <span class="comment">     * It is implemented in and for this program only.</span>
00980 <span class="comment">     * It is pretty reusable code, though.</span>
00981 <span class="comment">     */</span>
00982      ret=<a class="code" href="group__tools.html#ga0">ksFromXMLfile</a>(ksEdited,filename);
00983     <span class="keywordflow">if</span> (ret!=0)
00984         {
00985         printf(<span class="stringliteral">"kdb cannot import this file, because it is not valid !\n"</span>);
00986         strcpy(choice,<span class="stringliteral">""</span>);
00987         <span class="keywordflow">while</span> (choice[0]!=<span class="charliteral">'E'</span> &amp;&amp; choice[0]!=<span class="charliteral">'C'</span>)
00988             {
00989             printf(<span class="stringliteral">"Do you want to edit it again or to cancel ? (E/C) : "</span>);
00990             fgets(choice,4, stdin );
00991             }
00992         }
00993     }
00994     <span class="keywordflow">while</span> (ret!=0 &amp;&amp; choice[0]==<span class="charliteral">'E'</span>);
00995     remove(filename);
00996     
00997     <span class="keywordflow">if</span> (ret==0)
00998         {
00999 
01000         <a class="code" href="group__keyset.html#ga18">ksCompare</a>(ks,ksEdited,toRemove);
01001     
01002         <span class="comment">/* Discard ksEdited because there is nothing else here</span>
01003 <span class="comment">        * after keyCompare() */</span>
01004         <a class="code" href="group__keyset.html#ga1">ksDel</a>(ksEdited);
01005         
01006         <span class="comment">/* Commit changed keys */</span>
01007         <a class="code" href="group__keyset.html#ga3">ksRewind</a>(ks);
01008         <span class="keywordflow">while</span> ((ret=<a class="code" href="group__kdb.html#ga15">kdbSetKeys</a>(ks))) {
01009             <span class="comment">/* We got an error. Warn user. */</span>
01010             <a class="code" href="struct__Key.html">Key</a> *problem;
01011             <span class="keywordtype">char</span> error[500];
01012             <span class="keywordtype">char</span> keyname[300]=<span class="stringliteral">""</span>;
01013             
01014             problem=<a class="code" href="group__keyset.html#ga5">ksCurrent</a>(ks);
01015             <span class="keywordflow">if</span> (problem) <a class="code" href="group__keyname.html#ga7">keyGetFullName</a>(problem,keyname,<span class="keyword">sizeof</span>(keyname));
01016             sprintf(error,<span class="stringliteral">"kdb edit: while setting/updating %s"</span>, keyname);
01017             perror(error);
01018             
01019             <span class="comment">/* And try to set keys again starting from the next key,</span>
01020 <span class="comment">            * unless we reached the end of the KeySet */</span>
01021             <span class="keywordflow">if</span> (<a class="code" href="group__keyset.html#ga4">ksNext</a>(ks) == 0) <span class="keywordflow">break</span>;
01022         }
01023         
01024         <a class="code" href="group__keyset.html#ga1">ksDel</a>(ks); <span class="comment">/* Finished with this KeySet */</span>
01025     
01026         <span class="comment">/* Remove removed keys */</span>
01027         <a class="code" href="group__keyset.html#ga3">ksRewind</a>(toRemove);
01028         <span class="keywordflow">while</span> ((current=<a class="code" href="group__keyset.html#ga4">ksNext</a>(toRemove))) {
01029             <span class="keywordtype">char</span> keyName[800];
01030     
01031             <a class="code" href="group__keyname.html#ga7">keyGetFullName</a>(current,keyName,<span class="keyword">sizeof</span>(keyName));
01032             ret=<a class="code" href="group__kdb.html#ga19">kdbRemove</a>(keyName);
01033             <span class="keywordflow">if</span> (ret != 0) {
01034                 <span class="keywordtype">char</span> error[850];
01035                 
01036                 sprintf(error,<span class="stringliteral">"kdb edit: while removing %s"</span>,keyName);
01037                 perror(error);
01038             }
01039         }
01040     
01041         <span class="comment">/* Finished with this KeySet too */</span>
01042         <a class="code" href="group__keyset.html#ga1">ksDel</a>(toRemove);
01043         }
01044     
01045     <span class="keywordflow">return</span> 0;
01046 }
01047 
01048 
01049 
01050 
<a name="l01064"></a><a class="code" href="group__libexample.html#ga31">01064</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga31">commandImport</a>() {
01065     <a class="code" href="struct__KeySet.html">KeySet</a> *ks;
01066     <span class="keywordtype">int</span> ret;
01067 
01068     <span class="keywordflow">if</span> (!ksFromXMLfile || !ksFromXML) <span class="keywordflow">return</span> 1;
01069     
01070     
01071     ks=<a class="code" href="group__keyset.html#ga0">ksNew</a>();
01072     <span class="comment">/* The command line parsing function will put the XML filename</span>
01073 <span class="comment">       in the argKeyName global. */</span>
01074     <span class="keywordflow">if</span> (argKeyName) <a class="code" href="group__tools.html#ga0">ksFromXMLfile</a>(ks,argKeyName);
01075     <span class="keywordflow">else</span> <a class="code" href="group__tools.html#ga1">ksFromXML</a>(ks,fileno(stdin) <span class="comment">/* more elegant then just '0' */</span>);
01076 
01077     <a class="code" href="group__keyset.html#ga3">ksRewind</a>(ks);
01078     <span class="keywordflow">while</span> ((ret=<a class="code" href="group__kdb.html#ga15">kdbSetKeys</a>(ks))) {
01079         <span class="comment">/* We got an error. Warn user. */</span>
01080         <a class="code" href="struct__Key.html">Key</a> *problem;
01081         <span class="keywordtype">char</span> error[500]=<span class="stringliteral">""</span>;
01082         <span class="keywordtype">char</span> keyname[300]=<span class="stringliteral">""</span>;
01083 
01084         problem=<a class="code" href="group__keyset.html#ga5">ksCurrent</a>(ks);
01085         <span class="keywordflow">if</span> (problem) <a class="code" href="group__keyname.html#ga7">keyGetFullName</a>(problem,keyname,<span class="keyword">sizeof</span>(keyname));
01086         sprintf(error,<span class="stringliteral">"kdb import: while importing %s"</span>, keyname);
01087         perror(error);
01088         
01089         <span class="comment">/* And try to set keys again starting from the next key,</span>
01090 <span class="comment">         *  unless we reached the end of KeySet */</span>
01091         <span class="keywordflow">if</span> (<a class="code" href="group__keyset.html#ga4">ksNext</a>(ks) == 0) <span class="keywordflow">break</span>;
01092     }
01093     
01094     <span class="keywordflow">return</span> ret;
01095 }
01096 
01097 
01098 
01099 
01100 
<a name="l01117"></a><a class="code" href="group__libexample.html#ga32">01117</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga32">commandExport</a>() {
01118 
01119     <span class="comment">/* Equivalent to 'kdb ls -xRv</span>
01120 <span class="comment">       So lets mimic and reuse code */</span>
01121 
01122     argSort=1;
01123     argRecursive=1;
01124     argAll=1;
01125     argXML=1;
01126     argShow=1;
01127     argValue=1;
01128     <span class="comment">/* argFullName=1; */</span>
01129 
01130     <span class="comment">/* force a superuniversal modern charset: UTF-8 */</span>
01131     setenv(<span class="stringliteral">"LANG"</span>,<span class="stringliteral">"en_US.UTF-8"</span>,1);
01132     
01133     <span class="comment">/* reopen key database to forced charset to take effect */</span>
01134     <a class="code" href="group__kdb.html#ga3">kdbClose</a>();
01135     <a class="code" href="group__kdb.html#ga0">kdbOpen</a>();
01136 
01137     <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga28">commandList</a>();
01138 }
01139 
01140 
<a name="l01154"></a><a class="code" href="group__libexample.html#ga33">01154</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga33">commandMonitor</a>() {
01155     <a class="code" href="struct__Key.html">Key</a> *toMonitor;
01156     u_int32_t diff;
01157     
01158     toMonitor=<a class="code" href="group__key.html#ga0">keyNew</a>(argKeyName,<a class="code" href="group__key.html#gga7a24">KEY_SWITCH_NEEDSYNC</a>,<a class="code" href="group__key.html#gga7a29">KEY_SWITCH_END</a>);
01159     
01160     diff=<a class="code" href="group__kdb.html#ga22">kdbMonitorKey</a>(
01161         toMonitor,           <span class="comment">/* key to monitor */</span>
01162         <a class="code" href="group__key.html#gga7a16">KEY_SWITCH_VALUE</a>,    <span class="comment">/* key info we are interested in */</span>
01163         0,                   <span class="comment">/* how many times to poll. 0 = ad-infinitum */</span>
01164         500                  <span class="comment">/* usecs between polls. 0 defaults to 1 second */</span>);
01165 
01166     <span class="comment">/*</span>
01167 <span class="comment">     * Since in our case we'll hang completelly until we get a key's</span>
01168 <span class="comment">     * value change, we don't have to check diff.</span>
01169 <span class="comment">     * So if method returned, the value has changed, and toMonitor has it.</span>
01170 <span class="comment">     */</span>
01171     printf(<span class="stringliteral">"New value is %s\n"</span>,(<span class="keywordtype">char</span> *)<a class="code" href="group__keyvalue.html#ga4">keyStealValue</a>(toMonitor));
01172     
01173     <a class="code" href="group__key.html#ga1">keyDel</a>(toMonitor);
01174     <span class="keywordflow">return</span> 0;
01175 }
01176 
01177 
<a name="l01186"></a><a class="code" href="group__libexample.html#ga34">01186</a> <span class="keywordtype">int</span> <a class="code" href="group__libexample.html#ga34">commandHelp</a>() {
01187     fprintf(stderr,<span class="stringliteral">"Use kdb to manipulate the Key Database. Examples:\n\n"</span>);
01188     fprintf(stderr,<span class="stringliteral">" kdb get [-dlr] key/name\n"</span>);
01189     fprintf(stderr,<span class="stringliteral">" kdb set [-t type] [-c \"A comment about this key\"] [-m mode] [-u uid]\n"</span>);
01190     fprintf(stderr,<span class="stringliteral">"         [-g gid] key/name \"the value\"\n"</span>);
01191     fprintf(stderr,<span class="stringliteral">" kdb set [-t type] [-m mode] [-c \"A comment\"] key/name -- \"the value\"\n"</span>);
01192     fprintf(stderr,<span class="stringliteral">" kdb set [-t type] [-b file] key/name\n"</span>);
01193     fprintf(stderr,<span class="stringliteral">" kdb ls [-lRfv] [key/dir | key/name]\n"</span>);
01194     fprintf(stderr,<span class="stringliteral">" kdb ls [-lRfvx] [key/dir | key/name] &gt; keys.xml\n"</span>);
01195     fprintf(stderr,<span class="stringliteral">" kdb edit [-R] [key/dir | key/name]\n"</span>);
01196     fprintf(stderr,<span class="stringliteral">" kdb rm key/name\n"</span>);
01197     fprintf(stderr,<span class="stringliteral">" kdb mv key/src key/dest\n"</span>);
01198     fprintf(stderr,<span class="stringliteral">" kdb ln key/src key/dest\n"</span>);
01199     fprintf(stderr,<span class="stringliteral">" kdb export system/some/tree.root &gt; file.xml\n"</span>);
01200     fprintf(stderr,<span class="stringliteral">" kdb import &lt; file.xml\n"</span>);
01201     fprintf(stderr,<span class="stringliteral">" kdb import file.xml\n"</span>);
01202     fprintf(stderr,<span class="stringliteral">" kdb monitor some/key/name\n\n"</span>);
01203     fprintf(stderr,<span class="stringliteral">"For additional info see kdb(1).\n"</span>);
01204     
01205     <span class="keywordflow">return</span> 0;
01206 }
01207 
01208 
01209 <span class="keywordtype">int</span> loadToolsLib(<span class="keywordtype">void</span>) {
01210     <span class="keywordtype">void</span> *dlhandle=0;
01211     
01212     dlhandle=dlopen(<span class="stringliteral">"libelektratools.so"</span>,RTLD_LAZY);
01213     <span class="keywordflow">if</span> (dlhandle == 0) {
01214         fprintf(stderr, <span class="stringliteral">"kdb: %s\n"</span>,dlerror());
01215         <span class="keywordflow">return</span> 1;
01216     }
01217     
01218     ksFromXMLfile=dlsym(dlhandle,<span class="stringliteral">"ksFromXMLfile"</span>);
01219     ksFromXML=dlsym(dlhandle,<span class="stringliteral">"ksFromXML"</span>);
01220     
01221     <span class="keywordflow">return</span> 0;
01222 }
01223 
01224 <span class="keywordtype">int</span> doCommand(<span class="keywordtype">int</span> command) {
01225     <span class="keywordflow">switch</span> (command) {
01226         <span class="keywordflow">case</span> CMD_SET:             <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga26">commandSet</a>();
01227         <span class="keywordflow">case</span> CMD_LIST:            <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga28">commandList</a>();
01228         <span class="keywordflow">case</span> CMD_LINK:            <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga27">commandLink</a>();
01229         <span class="keywordflow">case</span> CMD_GET:             <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga29">commandGet</a>();
01230         <span class="keywordflow">case</span> CMD_REMOVE:          <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga24">commandRemove</a>();
01231         <span class="keywordflow">case</span> CMD_EDIT:            <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga30">commandEdit</a>();
01232         <span class="keywordflow">case</span> CMD_LOAD:            <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga31">commandImport</a>();
01233         <span class="keywordflow">case</span> CMD_SAVE:            <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga32">commandExport</a>();
01234         <span class="keywordflow">case</span> CMD_MONITOR:         <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga33">commandMonitor</a>();
01235         <span class="keywordflow">case</span> CMD_MOVE:            <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga25">commandMove</a>();
01236         <span class="keywordflow">case</span> CMD_HELP:            <span class="keywordflow">return</span> <a class="code" href="group__libexample.html#ga34">commandHelp</a>();
01237     }
01238     <span class="keywordflow">return</span> 0;
01239 }
01240 
01241 
01242 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {
01243     <span class="keywordtype">int</span> command=0;
01244     <span class="keywordtype">int</span> ret=0;
01245 
01246     <span class="keywordflow">if</span> (loadToolsLib())
01247         fprintf(stderr,<span class="stringliteral">"kdb: XML importing and editing disabled\n"</span>);
01248     
01249     command=parseCommandLine(argc,argv);
01250 
01251     <a class="code" href="group__kdb.html#ga0">kdbOpen</a>();
01252     ret=doCommand(command);
01253     <a class="code" href="group__kdb.html#ga3">kdbClose</a>();
01254 
01255     <span class="keywordflow">return</span> ret;
01256 }
01257 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Jul 30 09:10:59 2005 for Elektra Project by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
