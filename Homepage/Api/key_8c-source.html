<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Elektra Project: key.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>key.c</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment">                          key.c  -  Methods for Key and KeySet manipulation</span>
00003 <span class="comment">                             -------------------</span>
00004 <span class="comment">    begin                : Mon Dec 29 2003</span>
00005 <span class="comment">    copyright            : (C) 2003 by Avi Alkalay</span>
00006 <span class="comment">    email                : avi@unix.sh</span>
00007 <span class="comment"> ***************************************************************************/</span>
00008 
00009 <span class="comment">/***************************************************************************</span>
00010 <span class="comment"> *                                                                         *</span>
00011 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
00012 <span class="comment"> *   it under the terms of the BSD License (revised).                      *</span>
00013 <span class="comment"> *                                                                         *</span>
00014 <span class="comment"> ***************************************************************************/</span>
00015 
00016 <span class="comment">/* Subversion stuff</span>
00017 <span class="comment"></span>
00018 <span class="comment">$Id: key.c 248 2005-07-25 12:51:33Z aviram $</span>
00019 <span class="comment">$LastChangedBy: aviram $</span>
00020 <span class="comment"></span>
00021 <span class="comment">*/</span>
00022 
00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00024 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00025 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00026 <span class="preprocessor">#include &lt;string.h&gt;</span>
00027 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00028 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00029 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00030 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00031 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00032 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
00033 <span class="preprocessor">#include &lt;grp.h&gt;</span>
00034 <span class="preprocessor">#include &lt;langinfo.h&gt;</span>
00035 
00036 <span class="preprocessor">#include "kdb.h"</span>
00037 <span class="preprocessor">#include "kdbprivate.h"</span>
00038 
00039 
<a name="l00049"></a><a class="code" href="group__backend.html#ga8">00049</a> size_t <a class="code" href="group__backend.html#ga8">strblen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s) {
00050     <span class="keywordtype">char</span> *found=index(s,0);
00051     <span class="keywordflow">if</span> (found) <span class="keywordflow">return</span> found-s+1;
00052     <span class="keywordflow">return</span> 0;
00053 }
00054 
00055 
00056 
<a name="l00321"></a><a class="code" href="group__key.html#ga0">00321</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__key.html#ga0">keyNew</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyName, ...) {
00322     va_list va;
00323     <a class="code" href="struct__Key.html">Key</a> *key;
00324     u_int32_t action=0;
00325     u_int8_t keyType=KEY_TYPE_UNDEFINED;
00326     u_int8_t keyTypeBinary=0; <span class="comment">/* a boolean shortcut */</span>
00327     size_t valueSize=0;
00328     
00329     key=(<a class="code" href="struct__Key.html">Key</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct__Key.html">Key</a>));
00330     <span class="keywordflow">if</span> (!key) <span class="keywordflow">return</span> 0;
00331     <a class="code" href="group__key.html#ga3">keyInit</a>(key);
00332     
00333     <span class="keywordflow">if</span> (keyName) {
00334         size_t nameSize;
00335         
00336         nameSize=<a class="code" href="group__keyname.html#ga0">keySetName</a>(key,keyName);
00337         <span class="keywordflow">if</span> (! nameSize) {
00338             free(key);
00339             <span class="keywordflow">return</span> 0;
00340         }
00341         
00342         va_start(va,keyName);
00343         
00344         action=va_arg(va,u_int32_t);
00345         <span class="keywordflow">while</span> (action) {
00346             <span class="keywordflow">switch</span> (action) {
00347                 <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga7a14">KEY_SWITCH_TYPE</a>:
00348                     <span class="comment">/* We are waiting for 1 or 2 parameters</span>
00349 <span class="comment">                     * following this action */</span>
00350                     
00351                     <span class="comment">/* First is the type */</span>
00352                     keyType=(u_int8_t)va_arg(va,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>);
00353                     
00354                     keyTypeBinary=(<a class="code" href="group__key.html#gga5a10">KEY_TYPE_BINARY</a> &lt;= keyType &amp;&amp;
00355                         keyType &lt; KEY_TYPE_STRING);
00356                     
00357                     <a class="code" href="group__keyvalue.html#ga10">keySetType</a>(key,keyType);
00358                     
00359                     <span class="keywordflow">break</span>;
00360                 <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga7a16">KEY_SWITCH_VALUE</a>:
00361                     <span class="keywordflow">if</span> (keyType == KEY_TYPE_UNDEFINED)
00362                         keyType=KEY_TYPE_STRING;
00363 
00364                     <span class="keywordflow">if</span> (!keyTypeBinary) {
00365                         <span class="comment">/* most popular cases */</span>
00366                         <a class="code" href="group__keyvalue.html#ga2">keySetString</a>(key,va_arg(va,<span class="keywordtype">char</span> *));
00367                         <span class="comment">/* reset the type due to the</span>
00368 <span class="comment">                         * above keySetString override */</span>
00369                         <a class="code" href="group__keyvalue.html#ga10">keySetType</a>(key,keyType);
00370                     } <span class="keywordflow">else</span> {
00371                         <span class="comment">/* Binary val: we need first the size of the value */</span>
00372                         valueSize=va_arg(va,size_t);
00373                         <a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,va_arg(va,<span class="keywordtype">void</span> *),valueSize);
00374                     }
00375 
00376                     <span class="keywordflow">break</span>;
00377                 <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga7a20">KEY_SWITCH_UID</a>:
00378                     <a class="code" href="group__keymeta.html#ga9">keySetUID</a>(key,va_arg(va,uid_t));
00379                     <span class="keywordflow">break</span>;
00380                 <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga7a21">KEY_SWITCH_GID</a>:
00381                     <a class="code" href="group__keymeta.html#ga11">keySetGID</a>(key,va_arg(va,gid_t));
00382                     <span class="keywordflow">break</span>;
00383                 <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga7a22">KEY_SWITCH_MODE</a>:
00384                     <a class="code" href="group__keymeta.html#ga13">keySetAccess</a>(key,va_arg(va,mode_t));
00385                     <span class="keywordflow">break</span>;
00386                 <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga7a18">KEY_SWITCH_DOMAIN</a>:
00387                     <a class="code" href="group__keymeta.html#ga0">keySetOwner</a>(key,va_arg(va,<span class="keywordtype">char</span> *));
00388                     <span class="keywordflow">break</span>;
00389                 <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga7a19">KEY_SWITCH_COMMENT</a>:
00390                     <a class="code" href="group__keymeta.html#ga4">keySetComment</a>(key,va_arg(va,<span class="keywordtype">char</span> *));
00391                     <span class="keywordflow">break</span>;
00392                 <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga7a24">KEY_SWITCH_NEEDSYNC</a>: {
00393                     <span class="keywordtype">int</span> rc=0;
00394                     rc=<a class="code" href="group__kdb.html#ga14">kdbGetKey</a>(key);
00395                     <span class="keywordflow">if</span> (rc)
00396                         <span class="comment">/* Flag the key to indicate an error in</span>
00397 <span class="comment">                         * kdbGetKey(). Propagated errno will indicate</span>
00398 <span class="comment">                         * the error ocurred. */</span>
00399                         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a>|=KEY_SWITCH_FLAG; <span class="comment">/* same as keySetFlag(key) */</span>
00400                 } <span class="keywordflow">break</span>;
00401             }
00402             action=va_arg(va,u_int32_t);
00403         }
00404         va_end(va);
00405     }
00406     <span class="keywordflow">return</span> key;
00407 }
00408  
00409  
00410  
00411  
<a name="l00424"></a><a class="code" href="group__key.html#ga1">00424</a> <span class="keywordtype">int</span> <a class="code" href="group__key.html#ga1">keyDel</a>(<a class="code" href="struct__Key.html">Key</a> *key) {
00425     <span class="keywordtype">int</span> rc;
00426     
00427     rc=<a class="code" href="group__key.html#ga4">keyClose</a>(key);
00428     free(key);
00429     
00430     <span class="keywordflow">return</span> rc;
00431  }
00432 
00433  
00434 
00435 
00436 
<a name="l00447"></a><a class="code" href="group__keytest.html#ga0">00447</a> <span class="keywordtype">int</span> <a class="code" href="group__keytest.html#ga0">keyIsInitialized</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
00448     <span class="comment">/* if (!key) return 0; */</span> <span class="comment">/* removing to activate stupid mode */</span>
00449     <span class="keywordflow">return</span> ((key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_INITMASK)==KEY_SWITCH_INITIALIZED);
00450 }
00451 
00452 
00453 <span class="comment">/******************************************* </span>
00454 <span class="comment"> *    General name manipulation methods    *</span>
00455 <span class="comment"> *******************************************/</span>
00456 
00457 
<a name="l00486"></a><a class="code" href="group__keyname.html#ga0">00486</a> ssize_t <a class="code" href="group__keyname.html#ga0">keySetName</a>(<a class="code" href="struct__Key.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *newName) {
00487     size_t length;
00488     size_t rootLength, userLength, systemLength, userDomainLength;
00489     size_t keyNameSize=1; <span class="comment">/* equal to length plus a space for \0 */</span>
00490     <span class="keywordtype">char</span> *p;
00491 
00492 <span class="comment">/*</span>
00493 <span class="comment">    if (!key) {</span>
00494 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
00495 <span class="comment">        return 0;</span>
00496 <span class="comment">    }</span>
00497 <span class="comment">    if (!keyIsInitialized(key)) keyInit(key); */</span> <span class="comment">/* commented for stupidity */</span>
00498 
00499     <span class="comment">/* handle null new key name, removing the old key */</span>
00500     <span class="keywordflow">if</span> (!newName || !(length=<a class="code" href="group__backend.html#ga8">strblen</a>(newName)-1)) {
00501         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) {
00502             free(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
00503             key-&gt;<a class="code" href="struct__Key.html#o11">key</a>=0;
00504         }
00505         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp;= ~(<a class="code" href="group__key.html#gga7a15">KEY_SWITCH_NAME</a> | <a class="code" href="group__key.html#gga7a24">KEY_SWITCH_NEEDSYNC</a> |
00506                         <a class="code" href="group__key.html#gga7a26">KEY_SWITCH_ISSYSTEM</a> | KEY_SWITCH_ISUSER);
00507         <span class="keywordflow">return</span> 0;
00508     }
00509 
00510     <span class="comment">/* Remove trailing  '/' if caller passed some */</span>
00511     <span class="keywordflow">while</span> (length &amp;&amp; newName[length]==RG_KEY_DELIM) {
00512         length--;
00513     }
00514 
00515     rootLength=<a class="code" href="group__keyname.html#ga10">keyNameGetRootNameSize</a>(newName);
00516     <span class="keywordflow">if</span> (!rootLength) {
00517         errno=KDB_RET_INVALIDKEY;
00518         <span class="keywordflow">return</span> -1;
00519     }
00520     userLength=<span class="keyword">sizeof</span>(<span class="stringliteral">"user"</span>)-1;
00521     systemLength=<span class="keyword">sizeof</span>(<span class="stringliteral">"system"</span>)-1;
00522     userDomainLength=rootLength-userLength-1;
00523     <span class="keywordflow">if</span> (userDomainLength&lt;0) userDomainLength=0;
00524 
00525     <span class="keywordflow">if</span> (!strncmp(<span class="stringliteral">"user"</span>,newName,userLength&lt;length?userLength:length)) {
00526         <span class="comment">/* handle "user*" */</span>
00527         <span class="keywordflow">if</span> (length &gt; userLength) {
00528             <span class="comment">/* handle "user?*" */</span>
00529             <span class="keywordflow">if</span> (*(newName+userLength)==<span class="charliteral">':'</span>) {
00530                 <span class="comment">/* handle "user:*" */</span>
00531                 <span class="keywordflow">if</span> (userDomainLength &gt; 0) {
00532                                         p=realloc(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>,userDomainLength+1);
00533                                         <span class="keywordflow">if</span> (NULL==p) <span class="keywordflow">goto</span> error_mem;
00534                     key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>=p;
00535                     strncpy(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>,newName+userLength+1,userDomainLength);
00536                     key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>[userDomainLength]=0;
00537                 }
00538                 keyNameSize+=length-userDomainLength-1;  <span class="comment">/* -1 is for the ':' */</span>
00539             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(newName+userLength)!=RG_KEY_DELIM) {
00540                 <span class="comment">/* handle when != "user/ *" */</span>
00541                 errno=KDB_RET_INVALIDKEY;
00542                 <span class="keywordflow">return</span> -1;
00543             } <span class="keywordflow">else</span> {
00544                 <span class="comment">/* handle regular "user/ *" */</span>
00545                 keyNameSize+=length;
00546             }
00547         } <span class="keywordflow">else</span> {
00548             <span class="comment">/* handle "user" */</span>
00549             keyNameSize+=userLength;
00550         }
00551 
00552         p=realloc(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,keyNameSize);
00553         <span class="keywordflow">if</span> (NULL==p) <span class="keywordflow">goto</span> error_mem;
00554         key-&gt;<a class="code" href="struct__Key.html#o11">key</a>=p;
00555 
00556         <span class="comment">/* here key-&gt;key must have a correct size allocated buffer */</span>
00557         <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) <span class="keywordflow">return</span> -1;
00558 
00559         strcpy(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,<span class="stringliteral">"user"</span>);
00560         strncpy(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>+userLength,newName+rootLength,length-rootLength);
00561         key-&gt;<a class="code" href="struct__Key.html#o11">key</a>[keyNameSize-1]=0;
00562 
00563         <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) {
00564             size_t bsize=<a class="code" href="group__backend.html#ga8">strblen</a>(getenv(<span class="stringliteral">"USER"</span>));
00565 
00566             <span class="keywordflow">if</span> (!bsize) {}
00567             <span class="keywordflow">else</span> {
00568                 key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>=malloc(bsize);
00569                 strncpy(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>,getenv(<span class="stringliteral">"USER"</span>),bsize);
00570             }
00571         }
00572         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= KEY_SWITCH_ISUSER;
00573         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp;= ~KEY_SWITCH_ISSYSTEM;
00574     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(<span class="stringliteral">"system"</span>,newName,systemLength&lt;length?systemLength:length)) {
00575         <span class="comment">/* handle "system*" */</span>
00576         <span class="keywordflow">if</span> (length &gt; systemLength &amp;&amp; *(newName+systemLength)!=RG_KEY_DELIM) {
00577             <span class="comment">/* handle when != "system/ *" */</span>
00578             errno=KDB_RET_INVALIDKEY;
00579             <span class="keywordflow">return</span> -1;
00580         }
00581         keyNameSize+=length;
00582         p=realloc(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,keyNameSize);
00583         <span class="keywordflow">if</span> (NULL==p) <span class="keywordflow">goto</span> error_mem;
00584         key-&gt;<a class="code" href="struct__Key.html#o11">key</a>=p;
00585 
00586 
00587         <span class="comment">/* here key-&gt;key must have a correct size allocated buffer */</span>
00588         <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) <span class="keywordflow">return</span> -1;
00589 
00590         strncpy(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,newName,length);
00591         key-&gt;<a class="code" href="struct__Key.html#o11">key</a>[keyNameSize-1]=0;
00592         
00593         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= KEY_SWITCH_ISSYSTEM;
00594         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp;= ~KEY_SWITCH_ISUSER;
00595     } <span class="keywordflow">else</span> {
00596         <span class="comment">/* Passed name is neither "system" or "user" */</span>
00597         errno=KDB_RET_INVALIDKEY;
00598         <span class="keywordflow">return</span> -1;
00599     }
00600 
00601     key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= <a class="code" href="group__key.html#gga7a15">KEY_SWITCH_NAME</a> | KEY_SWITCH_NEEDSYNC;
00602 
00603     <span class="keywordflow">return</span> keyNameSize;
00604 
00605     error_mem:
00606         errno=KDB_RET_NOMEM;
00607         <span class="keywordflow">return</span> -1;
00608 }
00609 
00610  
00611 
<a name="l00629"></a><a class="code" href="group__keyname.html#ga1">00629</a> ssize_t <a class="code" href="group__keyname.html#ga1">keyAddBaseName</a>(<a class="code" href="struct__Key.html">Key</a> *key,<span class="keyword">const</span> <span class="keywordtype">char</span> *baseName) {
00630     size_t nameSize=0;
00631     size_t newSize=0;
00632     <span class="keywordtype">int</span> ndelim=0;
00633     <span class="keywordtype">char</span> *p;
00634 
00635     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) nameSize=<a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>)-1;
00636     <span class="keywordflow">if</span> (baseName) newSize=<a class="code" href="group__backend.html#ga8">strblen</a>(baseName);
00637     <span class="keywordflow">else</span> <span class="keywordflow">return</span> nameSize;
00638     
00639     <span class="keywordflow">if</span> (newSize==0) <span class="keywordflow">return</span> nameSize;
00640     
00641     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) {
00642         <span class="comment">/* Remove trailing '/' if caller passed some */</span>
00643         <span class="keywordflow">while</span> (nameSize-2 &amp;&amp; key-&gt;<a class="code" href="struct__Key.html#o11">key</a>[nameSize-1]==RG_KEY_DELIM &amp;&amp;
00644                key-&gt;<a class="code" href="struct__Key.html#o11">key</a>[nameSize-2]!=RG_KEY_DELIM) {
00645             key-&gt;<a class="code" href="struct__Key.html#o11">key</a>[--nameSize]=0;
00646         }
00647         
00648         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o11">key</a>[nameSize-1] != RG_KEY_DELIM) nameSize++;
00649         
00650         <span class="comment">/* Remove all '/' in the begining of baseName */</span>
00651         <span class="keywordflow">while</span> (baseName[ndelim] &amp;&amp; baseName[ndelim] == RG_KEY_DELIM) {
00652             newSize--;
00653             ndelim++;
00654         }
00655         
00656         <span class="comment">/* Now we know the final key size */</span>
00657         newSize+=nameSize;
00658         p=realloc(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,newSize);
00659         <span class="keywordflow">if</span> (NULL == p) {
00660             errno=KDB_RET_NOMEM;
00661             <span class="keywordflow">return</span> -1;
00662         }
00663         key-&gt;<a class="code" href="struct__Key.html#o11">key</a>=p;
00664 
00665         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o11">key</a>[nameSize-1] != RG_KEY_DELIM &amp;&amp; baseName[ndelim])
00666             strcat(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,<span class="stringliteral">"/"</span>);
00667         
00668         strcat(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,baseName+ndelim);
00669         
00670     } <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="group__keyname.html#ga0">keySetName</a>(key,baseName);
00671     
00672     <span class="keywordflow">return</span> newSize;
00673 }
00674 
00675 
00676 
00677 
<a name="l00693"></a><a class="code" href="group__keyname.html#ga2">00693</a> ssize_t <a class="code" href="group__keyname.html#ga2">keySetBaseName</a>(<a class="code" href="struct__Key.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *baseName) {
00694     size_t newSize=<a class="code" href="group__backend.html#ga8">strblen</a>(baseName);
00695     <span class="keywordtype">char</span> *end;
00696         <span class="keywordtype">char</span> *p;
00697     
00698     end=rindex(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,<span class="charliteral">'/'</span>);
00699     
00700     <span class="keywordflow">if</span> (end) {
00701         newSize+=end-key-&gt;<a class="code" href="struct__Key.html#o11">key</a>;
00702         end[1]=0;
00703         p=realloc(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,newSize);
00704                 <span class="keywordflow">if</span> (NULL == p) {
00705                         errno=KDB_RET_NOMEM;
00706                     <span class="keywordflow">return</span> -1;
00707                 }
00708         key-&gt;<a class="code" href="struct__Key.html#o11">key</a>=p;
00709         strcat(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,baseName);
00710         <span class="keywordflow">return</span> newSize;
00711     } <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="group__keyname.html#ga0">keySetName</a>(key,baseName);
00712 }
00713 
00714 
00715 
00716 
<a name="l00724"></a><a class="code" href="group__keyname.html#ga3">00724</a> ssize_t <a class="code" href="group__keyname.html#ga3">keyGetNameSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
00725     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
00726 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
00727 <span class="comment">        return 0;</span>
00728 <span class="comment">    } */</span>
00729 
00730     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) <span class="keywordflow">return</span> <a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
00731     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
00732 }
00733 
00734 
00735 
00736 
<a name="l00747"></a><a class="code" href="group__keyname.html#ga4">00747</a> ssize_t <a class="code" href="group__keyname.html#ga4">keyGetName</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returnedName, size_t maxSize) {
00748     size_t bytes;
00749 
00750     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
00751 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
00752 <span class="comment">        return 0;</span>
00753 <span class="comment">    } */</span>
00754 
00755     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) {
00756         errno=KDB_RET_NOKEY;
00757         returnedName[0]=0;
00758         <span class="keywordflow">return</span> 0;
00759     }
00760 
00761     bytes=<a class="code" href="group__backend.html#ga8">strblen</a>(strncpy(returnedName,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,maxSize));
00762     <span class="keywordflow">if</span> (maxSize &lt; <a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>)) {
00763         errno=KDB_RET_TRUNC;
00764         <span class="keywordflow">return</span> -1;
00765     }
00766     <span class="keywordflow">return</span> bytes;
00767 }
00768 
00769 
00770 
<a name="l00782"></a><a class="code" href="group__keyname.html#ga5">00782</a> <span class="keywordtype">char</span> *<a class="code" href="group__keyname.html#ga5">keyStealName</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
00783     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o11">key</a>;
00784 }
00785 
00786 
00787 
00788 
00789 
00790 
<a name="l00798"></a><a class="code" href="group__keyname.html#ga6">00798</a> ssize_t <a class="code" href="group__keyname.html#ga6">keyGetFullNameSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
00799     size_t returnedSize;
00800 
00801     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
00802 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
00803 <span class="comment">        return -1;</span>
00804 <span class="comment">    } */</span>
00805 
00806     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) <span class="keywordflow">return</span> 0;
00807 
00808     returnedSize=<a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
00809 
00810     <span class="keywordflow">if</span> (!strncmp(<span class="stringliteral">"user"</span>,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,<span class="keyword">sizeof</span>(<span class="stringliteral">"user"</span>)-1) &amp;&amp; key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>)
00811         returnedSize+=<a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
00812 
00813     <span class="keywordflow">return</span> returnedSize;
00814 }
00815 
00816 
00817 
00818 
<a name="l00828"></a><a class="code" href="group__keyname.html#ga7">00828</a> ssize_t <a class="code" href="group__keyname.html#ga7">keyGetFullName</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returnedName, size_t maxSize) {
00829     size_t userSize=<span class="keyword">sizeof</span>(<span class="stringliteral">"user"</span>)-1;
00830     size_t userDomainSize;
00831     ssize_t length;
00832     <span class="keywordtype">char</span> *cursor;
00833 
00834     length=<a class="code" href="group__keyname.html#ga6">keyGetFullNameSize</a>(key);
00835     <span class="keywordflow">if</span> (length == 0) {
00836         errno=KDB_RET_NOKEY;
00837         returnedName[0]=0;
00838         <span class="keywordflow">return</span> length;
00839     }
00840     <span class="keywordflow">if</span> (length &lt; 0) <span class="keywordflow">return</span> length;
00841     <span class="keywordflow">if</span> (length &gt; maxSize) {
00842         errno=KDB_RET_TRUNC;
00843         <span class="keywordflow">return</span> -1;
00844     }
00845 
00846     cursor=returnedName;
00847     <span class="keywordflow">if</span> (!strncmp(<span class="stringliteral">"user"</span>,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,userSize)) {
00848         strncpy(cursor,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,userSize);
00849         cursor+=userSize;
00850         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) {
00851             *cursor=<span class="charliteral">':'</span>; ++cursor;
00852             userDomainSize=<a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>)-1;
00853             strcpy(cursor,key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
00854             cursor+=userDomainSize;
00855         }
00856         strcpy(cursor,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>+userSize);
00857     } <span class="keywordflow">else</span> strcpy(cursor,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
00858 
00859     <span class="keywordflow">return</span> length;
00860 }
00861 
00862 
00863 
00864 
00865 
<a name="l00877"></a><a class="code" href="group__keytest.html#ga1">00877</a> <span class="keywordtype">int</span> <a class="code" href="group__keytest.html#ga1">keyNameGetNamespace</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyName) {
00878     <span class="keywordflow">if</span> (<a class="code" href="group__keyname.html#ga8">keyNameIsSystem</a>(keyName)) <span class="keywordflow">return</span> KEY_NS_SYSTEM;
00879     <span class="keywordflow">if</span> (<a class="code" href="group__keyname.html#ga9">keyNameIsUser</a>(keyName)) <span class="keywordflow">return</span> KEY_NS_USER;
00880     <span class="keywordflow">return</span> 0;
00881 }
00882 
00883 
00884 
<a name="l00895"></a><a class="code" href="group__keytest.html#ga2">00895</a> <span class="keywordtype">int</span> <a class="code" href="group__keytest.html#ga2">keyGetNamespace</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
00896     <span class="comment">/* if (!key) return 0;</span>
00897 <span class="comment">    if (!keyIsInitialized(key)) return 0; */</span>
00898 
00899     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_ISSYSTEM) <span class="keywordflow">return</span> KEY_NS_SYSTEM;
00900     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_ISUSER) <span class="keywordflow">return</span> KEY_NS_USER;
00901     <span class="keywordflow">return</span> 0;
00902 }
00903 
00904 
00905 
<a name="l00915"></a><a class="code" href="group__keyname.html#ga8">00915</a> <span class="keywordtype">int</span> <a class="code" href="group__keyname.html#ga8">keyNameIsSystem</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyName) {
00916     <span class="comment">/* if (!keyName) return 0;</span>
00917 <span class="comment">    if (!strlen(keyName)) return 0; */</span>
00918 
00919     <span class="keywordflow">if</span> (!strncmp(<span class="stringliteral">"system"</span>,keyName,<span class="keyword">sizeof</span>(<span class="stringliteral">"system"</span>)-1)) <span class="keywordflow">return</span> 1;
00920     <span class="keywordflow">return</span> 0;
00921 }
00922 
00923 
00924 
<a name="l00933"></a><a class="code" href="group__keytest.html#ga3">00933</a> <span class="keywordtype">int</span> <a class="code" href="group__keytest.html#ga3">keyIsSystem</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
00934     <span class="comment">/* if (!key) return 0;</span>
00935 <span class="comment">    if (!keyIsInitialized(key)) return 0; */</span>
00936 
00937     <span class="keywordflow">return</span> (key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_ISSYSTEM)?1:0;
00938 }
00939 
00940 
00941 
<a name="l00951"></a><a class="code" href="group__keyname.html#ga9">00951</a> <span class="keywordtype">int</span> <a class="code" href="group__keyname.html#ga9">keyNameIsUser</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyName) {
00952     <span class="comment">/* if (!keyName) return 0;</span>
00953 <span class="comment">    if (!strlen(keyName)) return 0; */</span>
00954 
00955     <span class="keywordflow">if</span> (!strncmp(<span class="stringliteral">"user"</span>,keyName,<span class="keyword">sizeof</span>(<span class="stringliteral">"user"</span>)-1)) <span class="keywordflow">return</span> 1;
00956     <span class="keywordflow">return</span> 0;
00957 }
00958 
00959 
00960 
<a name="l00969"></a><a class="code" href="group__keytest.html#ga4">00969</a> <span class="keywordtype">int</span> <a class="code" href="group__keytest.html#ga4">keyIsUser</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
00970     <span class="comment">/* if (!key) return 0;</span>
00971 <span class="comment">    if (!keyIsInitialized(key)) return 0; */</span>
00972 
00973     <span class="keywordflow">return</span> (key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_ISUSER)?1:0;
00974 }
00975 
00976 
00977 
<a name="l00988"></a><a class="code" href="group__keyname.html#ga10">00988</a> ssize_t <a class="code" href="group__keyname.html#ga10">keyNameGetRootNameSize</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyName) {
00989     <span class="keywordtype">char</span> *end;
00990     <span class="keywordtype">int</span> length=strlen(keyName);
00991 
00992     <span class="keywordflow">if</span> (!length) <span class="keywordflow">return</span> 0;
00993 
00994     <span class="comment">/*</span>
00995 <span class="comment">        Possible situations:</span>
00996 <span class="comment">        user:someuser</span>
00997 <span class="comment">        user:someuser/</span>
00998 <span class="comment">        user:someuser/key/name</span>
00999 <span class="comment">        user:some.user/key/name</span>
01000 <span class="comment">        .</span>
01001 <span class="comment">        \.</span>
01002 <span class="comment">        (empty)</span>
01003 <span class="comment">    */</span>
01004     end=strchr(keyName,RG_KEY_DELIM);
01005     <span class="keywordflow">if</span> (!end) <span class="comment">/* Reached end of string. Root is entire key. */</span>
01006         end = (<span class="keywordtype">char</span> *)keyName + length;
01007 
01008     <span class="keywordflow">return</span> end-keyName;
01009 }
01010 
01011 
01012 
<a name="l01023"></a><a class="code" href="group__keyname.html#ga11">01023</a> ssize_t <a class="code" href="group__keyname.html#ga11">keyGetRootNameSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01024     <span class="comment">/* if (!key) return 0;</span>
01025 <span class="comment">    if (!keyIsInitialized(key)) return 0; */</span>
01026     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) <span class="keywordflow">return</span> 0;
01027 
01028     <span class="keywordflow">return</span> <a class="code" href="group__keyname.html#ga10">keyNameGetRootNameSize</a>(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
01029 }
01030 
01031 
01032 
<a name="l01050"></a><a class="code" href="group__keyname.html#ga12">01050</a> ssize_t <a class="code" href="group__keyname.html#ga12">keyGetRootName</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returned, size_t maxSize) {
01051     size_t size;
01052 
01053     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
01054 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01055 <span class="comment">        return -1;</span>
01056 <span class="comment">    } */</span>
01057 
01058     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) {
01059         errno=KDB_RET_NOKEY;
01060         <span class="keywordflow">return</span> -1;
01061     }
01062 
01063     <span class="keywordflow">if</span> (!(size=<a class="code" href="group__keyname.html#ga11">keyGetRootNameSize</a>(key))) {
01064         errno=KDB_RET_NOKEY;
01065         <span class="keywordflow">return</span> -1;
01066     }
01067 
01068     <span class="keywordflow">if</span> (maxSize &lt; size) {
01069         errno=KDB_RET_TRUNC;
01070         <span class="keywordflow">return</span> -1;
01071     } <span class="keywordflow">else</span> strncpy(returned,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,size);
01072     <span class="keywordflow">return</span> size;
01073 }
01074 
01075 
01076 
<a name="l01088"></a><a class="code" href="group__keyname.html#ga13">01088</a> ssize_t <a class="code" href="group__keyname.html#ga13">keyGetFullRootNameSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01089     size_t size=0;
01090 
01091     <span class="keywordflow">if</span> (<a class="code" href="group__keytest.html#ga4">keyIsUser</a>(key)) {
01092         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) size=<a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
01093         <span class="keywordflow">else</span> size=<a class="code" href="group__backend.html#ga8">strblen</a>(getenv(<span class="stringliteral">"USER"</span>));
01094     }
01095 
01096     <span class="keywordflow">return</span> size+<a class="code" href="group__keyname.html#ga10">keyNameGetRootNameSize</a>(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
01097 }
01098 
01099 
<a name="l01117"></a><a class="code" href="group__keyname.html#ga14">01117</a> ssize_t <a class="code" href="group__keyname.html#ga14">keyGetFullRootName</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returned, size_t maxSize) {
01118     size_t size;
01119     size_t userSize;
01120     <span class="keywordtype">char</span> *cursor;
01121 
01122     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
01123 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01124 <span class="comment">        return 0;</span>
01125 <span class="comment">    } */</span>
01126 
01127     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) {
01128         errno=KDB_RET_NOKEY;
01129         <span class="keywordflow">return</span> 0;
01130     }
01131 
01132     <span class="keywordflow">if</span> (!(size=<a class="code" href="group__keyname.html#ga13">keyGetFullRootNameSize</a>(key))) {
01133         errno=KDB_RET_NOKEY;
01134         <span class="keywordflow">return</span> 0;
01135     }
01136 
01137     <span class="keywordflow">if</span> (maxSize &lt; size) {
01138         errno=KDB_RET_TRUNC;
01139         <span class="keywordflow">return</span> -1;
01140     }
01141     
01142     userSize = <a class="code" href="group__keyname.html#ga11">keyGetRootNameSize</a>(key);
01143     strncpy(returned,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>, userSize); <span class="comment">/* copy "user" or "system" */</span>
01144     <span class="keywordflow">if</span> (<a class="code" href="group__keytest.html#ga4">keyIsUser</a>(key)) {
01145         cursor = returned + userSize;
01146         *cursor = <span class="charliteral">':'</span>; cursor++;
01147         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>)
01148             strncpy (cursor, key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>, size - userSize);
01149         <span class="keywordflow">else</span>
01150             strncpy (cursor, getenv(<span class="stringliteral">"USER"</span>),  size - userSize);
01151     }
01152 
01153     <span class="keywordflow">return</span> size;
01154 }
01155 
01156 
01157 
01158 
01159 
01160 
<a name="l01168"></a><a class="code" href="group__keyname.html#ga15">01168</a> ssize_t <a class="code" href="group__keyname.html#ga15">keyGetParentNameSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01169     <span class="keywordtype">char</span> *parentNameEnd;
01170 
01171     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
01172 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01173 <span class="comment">        return 0;</span>
01174 <span class="comment">    } */</span>
01175 
01176     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) {
01177         errno=KDB_RET_NOKEY;
01178         <span class="keywordflow">return</span> 0;
01179     }
01180 
01181     <span class="comment">/*</span>
01182 <span class="comment">        user   (size=0)</span>
01183 <span class="comment">        user/parent/base</span>
01184 <span class="comment">        user/parent/base/ (size=sizeof("user/parent"))</span>
01185 <span class="comment">    */</span>
01186 
01187     parentNameEnd=strrchr(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,RG_KEY_DELIM);
01188 
01189     <span class="keywordflow">if</span> (!parentNameEnd || parentNameEnd==key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) {
01190         <span class="comment">/* handle NULL or /something */</span>
01191         <span class="keywordflow">return</span> 0;
01192     }
01193 
01194     <span class="comment">/* handle system/parent/base/ */</span>
01195     <span class="keywordflow">if</span> ((parentNameEnd-key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) == (<a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>)-2)) {
01196         parentNameEnd--;
01197         <span class="keywordflow">while</span> (*parentNameEnd!=RG_KEY_DELIM) parentNameEnd--;
01198     }
01199 
01200     <span class="keywordflow">return</span> parentNameEnd - key-&gt;<a class="code" href="struct__Key.html#o11">key</a>;
01201 }
01202 
01203 
01204 
<a name="l01223"></a><a class="code" href="group__keyname.html#ga16">01223</a> ssize_t <a class="code" href="group__keyname.html#ga16">keyGetParentName</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returnedParent, size_t maxSize) {
01224     ssize_t parentSize;
01225 
01226     parentSize=<a class="code" href="group__keyname.html#ga15">keyGetParentNameSize</a>(key);
01227 
01228     <span class="keywordflow">if</span> (parentSize+1 &gt; maxSize) {
01229         errno=KDB_RET_TRUNC;
01230         <span class="keywordflow">return</span> 0;
01231     } <span class="keywordflow">else</span> strncpy(returnedParent,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,parentSize);
01232 
01233     returnedParent[parentSize]=0; <span class="comment">/* ending NULL */</span>
01234     
01235     <span class="keywordflow">return</span> parentSize;
01236 }
01237 
01238 
01239 
01240 
01241 
01242 
<a name="l01257"></a><a class="code" href="group__keyname.html#ga17">01257</a> ssize_t <a class="code" href="group__keyname.html#ga17">keyNameGetBaseNameSize</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyName) {
01258     <span class="keywordtype">char</span> *end;
01259 
01260     end=strrchr(keyName,RG_KEY_DELIM);
01261     <span class="keywordflow">if</span> (end) <span class="keywordflow">return</span> keyName+<a class="code" href="group__backend.html#ga8">strblen</a>(keyName)-1-end;
01262     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
01263 }
01264 
01265 
01266 
<a name="l01281"></a><a class="code" href="group__keyname.html#ga18">01281</a> ssize_t <a class="code" href="group__keyname.html#ga18">keyGetBaseNameSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01282     <span class="comment">/* if (!key) return 0;</span>
01283 <span class="comment">    if (!keyIsInitialized(key)) return 0; */</span>
01284     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o11">key</a>) <span class="keywordflow">return</span> 0;
01285 
01286     <span class="keywordflow">return</span> <a class="code" href="group__keyname.html#ga17">keyNameGetBaseNameSize</a>(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
01287 }
01288 
01289 
01290 
<a name="l01305"></a><a class="code" href="group__keyname.html#ga19">01305</a> ssize_t <a class="code" href="group__keyname.html#ga19">keyGetBaseName</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returned, size_t maxSize) {
01306     ssize_t size;
01307     size_t keySize;
01308 
01309     <span class="comment">/* if (!key) {</span>
01310 <span class="comment">        errno=KDB_RET_NULLKEY;</span>
01311 <span class="comment">        return 0;</span>
01312 <span class="comment">    }</span>
01313 <span class="comment"></span>
01314 <span class="comment">    if (!keyIsInitialized(key)) {</span>
01315 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01316 <span class="comment">        return 0;</span>
01317 <span class="comment">    } */</span>
01318 
01319     <span class="keywordflow">if</span> (!(size=<a class="code" href="group__keyname.html#ga18">keyGetBaseNameSize</a>(key))) {
01320         errno=KDB_RET_NOKEY;
01321         <span class="keywordflow">return</span> 0;
01322     }
01323 
01324     keySize=<a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
01325 
01326     <span class="keywordflow">if</span> (maxSize &lt; size) {
01327         strncpy(returned,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>+keySize-size,maxSize);
01328         errno=KDB_RET_TRUNC;
01329         <span class="keywordflow">return</span> size;
01330     } <span class="keywordflow">else</span> strncpy(returned,key-&gt;<a class="code" href="struct__Key.html#o11">key</a>+keySize-size,size);
01331 
01332     <span class="keywordflow">return</span> size;
01333 }
01334 
01335 
<a name="l01345"></a><a class="code" href="group__keyname.html#ga20">01345</a> <span class="keywordtype">char</span> *<a class="code" href="group__keyname.html#ga20">keyStealBaseName</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01346     <span class="keywordtype">char</span> *end=strrchr(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>,RG_KEY_DELIM);
01347     
01348     <span class="keywordflow">if</span> (end) <span class="keywordflow">return</span> end++;
01349     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
01350 }
01351 
01352 
01353 <span class="comment">/******************************************* </span>
01354 <span class="comment"> *    General value manipulation methods   *</span>
01355 <span class="comment"> *******************************************/</span>
01356 
01357 
01358 
01359 
<a name="l01365"></a><a class="code" href="group__keyvalue.html#ga0">01365</a> ssize_t <a class="code" href="group__keyvalue.html#ga0">keyGetDataSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01366     <span class="keywordflow">return</span> <a class="code" href="group__keyvalue.html#ga1">keyGetValueSize</a>(key);
01367 }
01368 
01369 
01370 
<a name="l01381"></a><a class="code" href="group__keyvalue.html#ga1">01381</a> ssize_t <a class="code" href="group__keyvalue.html#ga1">keyGetValueSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01382     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
01383 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01384 <span class="comment">        return -1;</span>
01385 <span class="comment">    } */</span>
01386 
01387     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>;
01388 }
01389 
01390 
01391 
<a name="l01409"></a><a class="code" href="group__keyvalue.html#ga2">01409</a> ssize_t <a class="code" href="group__keyvalue.html#ga2">keySetString</a>(<a class="code" href="struct__Key.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *newStringValue) {
01410     ssize_t ret=newStringValue?<a class="code" href="group__backend.html#ga8">strblen</a>(newStringValue):0;
01411 
01412     <span class="keywordflow">if</span> (!newStringValue || !ret) ret=<a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,0,0);
01413     <span class="keywordflow">else</span> ret=<a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,newStringValue,ret);
01414 
01415     <a class="code" href="group__keyvalue.html#ga10">keySetType</a>(key,<a class="code" href="group__key.html#gga5a11">KEY_TYPE_STRING</a>);
01416 
01417     <span class="keywordflow">return</span> ret;
01418 }
01419 
01420 
01421 
<a name="l01446"></a><a class="code" href="group__keyvalue.html#ga3">01446</a> ssize_t <a class="code" href="group__keyvalue.html#ga3">keyGetString</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returnedString, size_t maxSize) {
01447     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
01448 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01449 <span class="comment">        return 0;</span>
01450 <span class="comment">    } */</span>
01451 
01452     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o14">data</a>) {
01453         *returnedString=0;
01454         errno=KDB_RET_NODATA;
01455         <span class="keywordflow">return</span> 0;
01456     }
01457 
01458     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a> &gt; maxSize) {
01459         errno=KDB_RET_TRUNC;
01460         <span class="keywordflow">return</span> -1;
01461     }
01462 
01463     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o0">type</a> &lt; KEY_TYPE_STRING) {
01464         errno=KDB_RET_TYPEMISMATCH;
01465         <span class="keywordflow">return</span> -1;
01466     }
01467 
01468     strcpy(returnedString,key-&gt;<a class="code" href="struct__Key.html#o14">data</a>);
01469     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>;
01470 }
01471 
01472 
01473 
01474 
01475 
01476 
<a name="l01526"></a><a class="code" href="group__keyvalue.html#ga4">01526</a> <span class="keywordtype">void</span> *<a class="code" href="group__keyvalue.html#ga4">keyStealValue</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01527     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o14">data</a>;
01528 }
01529 
01530 
01531 
01532 
01533 
01534 
01535 
01536 
<a name="l01546"></a><a class="code" href="group__keyvalue.html#ga5">01546</a> ssize_t <a class="code" href="group__keyvalue.html#ga5">keySetLink</a>(<a class="code" href="struct__Key.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *target) {
01547     ssize_t ret=target?<a class="code" href="group__backend.html#ga8">strblen</a>(target):0;
01548 
01549     <span class="keywordflow">if</span> (!target || !ret) ret=<a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,0,0);
01550     <span class="keywordflow">else</span> ret=<a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,target,ret);
01551 
01552     <a class="code" href="group__keyvalue.html#ga10">keySetType</a>(key,<a class="code" href="group__key.html#gga5a9">KEY_TYPE_LINK</a>);
01553 
01554     <span class="keywordflow">return</span> ret;
01555 }
01556 
01557 
01558 
<a name="l01569"></a><a class="code" href="group__keyvalue.html#ga6">01569</a> ssize_t <a class="code" href="group__keyvalue.html#ga6">keyGetLink</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returnedTarget, size_t maxSize) {
01573     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
01574 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01575 <span class="comment">        return 0;</span>
01576 <span class="comment">    } */</span>
01577 
01578     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o14">data</a>) {
01579         errno=KDB_RET_NODATA;
01580         <span class="keywordflow">return</span> 0;
01581     }
01582 
01583     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o0">type</a> != KEY_TYPE_LINK) {
01584         errno=KDB_RET_TYPEMISMATCH;
01585         <span class="keywordflow">return</span> -1;
01586     }
01587 
01588     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a> &gt; maxSize) {
01589         errno=KDB_RET_TRUNC;
01590         <span class="keywordflow">return</span> -1;
01591     }
01592 
01593     strcpy(returnedTarget,key-&gt;<a class="code" href="struct__Key.html#o14">data</a>);
01594     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>;
01595 }
01596 
01597 
01598 
<a name="l01608"></a><a class="code" href="group__keytest.html#ga5">01608</a> <span class="keywordtype">int</span> <a class="code" href="group__keytest.html#ga5">keyIsLink</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01609     <span class="comment">/* if (!key) return 0;</span>
01610 <span class="comment">    if (!keyIsInitialized(key)) return 0; */</span>
01611 
01612     <span class="keywordflow">return</span> (S_ISLNK(key-&gt;<a class="code" href="struct__Key.html#o3">access</a>) || (key-&gt;<a class="code" href="struct__Key.html#o0">type</a>==KEY_TYPE_LINK));
01613 }
01614 
01615 
01616 
<a name="l01626"></a><a class="code" href="group__keytest.html#ga6">01626</a> <span class="keywordtype">int</span> <a class="code" href="group__keytest.html#ga6">keyIsDir</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01627     <span class="comment">/* if (!key) return 0;</span>
01628 <span class="comment">    if (!keyIsInitialized(key)) return 0; */</span>
01629 
01630     <span class="keywordflow">return</span> (S_ISDIR(key-&gt;<a class="code" href="struct__Key.html#o3">access</a>) || (key-&gt;<a class="code" href="struct__Key.html#o0">type</a>==KEY_TYPE_DIR));
01631 }
01632 
01633 
01634 
<a name="l01642"></a><a class="code" href="group__keytest.html#ga7">01642</a> <span class="keywordtype">int</span> <a class="code" href="group__keytest.html#ga7">keyIsBin</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01643     <span class="comment">/* if (!key) return 0;</span>
01644 <span class="comment">    if (!keyIsInitialized(key)) return 0; */</span>
01645 
01646     <span class="keywordflow">return</span> (<a class="code" href="group__key.html#gga5a10">KEY_TYPE_BINARY</a> &lt;= key-&gt;<a class="code" href="struct__Key.html#o0">type</a> &amp;&amp; key-&gt;<a class="code" href="struct__Key.html#o0">type</a> &lt; KEY_TYPE_STRING);
01647 }
01648 
01649 
01650 
<a name="l01660"></a><a class="code" href="group__keyvalue.html#ga7">01660</a> ssize_t <a class="code" href="group__keyvalue.html#ga7">keyGetBinary</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">void</span> *returnedValue, size_t maxSize) {
01661     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
01662 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01663 <span class="comment">        return 0;</span>
01664 <span class="comment">    } */</span>
01665 
01666     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o14">data</a>) {
01667         errno=KDB_RET_NODATA;
01668         <span class="keywordflow">return</span> 0;
01669     }
01670 
01671     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a> &gt; maxSize) {
01672         errno=KDB_RET_TRUNC;
01673         <span class="keywordflow">return</span> -1;
01674     }
01675 
01676     memcpy(returnedValue,key-&gt;<a class="code" href="struct__Key.html#o14">data</a>,key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>);
01677     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>;
01678 }
01679 
01680 
01681 
<a name="l01701"></a><a class="code" href="group__keyvalue.html#ga8">01701</a> ssize_t <a class="code" href="group__keyvalue.html#ga8">keySetBinary</a>(<a class="code" href="struct__Key.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">void</span> *newBinary, size_t dataSize) {
01702     ssize_t ret=<a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,newBinary,dataSize);
01703 
01704     <a class="code" href="group__keyvalue.html#ga10">keySetType</a>(key,<a class="code" href="group__key.html#gga5a10">KEY_TYPE_BINARY</a>);
01705 
01706     <span class="keywordflow">return</span> ret;
01707 }
01708 
01709 
01710 
<a name="l01719"></a><a class="code" href="group__keytest.html#ga8">01719</a> <span class="keywordtype">int</span> <a class="code" href="group__keytest.html#ga8">keyNeedsSync</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01720     <span class="comment">/* if (!key) return 0; */</span>
01721     <span class="keywordflow">return</span> (key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_NEEDSYNC);
01722 }
01723 
01724 
01725 
<a name="l01735"></a><a class="code" href="group__keyvalue.html#ga9">01735</a> u_int8_t <a class="code" href="group__keyvalue.html#ga9">keyGetType</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01736     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
01737 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01738 <span class="comment">        return KEY_TYPE_UNDEFINED;</span>
01739 <span class="comment">    } */</span>
01740 
01741     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o0">type</a>;
01742 }
01743 
01744 
01745 
<a name="l01814"></a><a class="code" href="group__keyvalue.html#ga10">01814</a> u_int8_t <a class="code" href="group__keyvalue.html#ga10">keySetType</a>(<a class="code" href="struct__Key.html">Key</a> *key,u_int8_t newType) {
01815     mode_t dirSwitch=0111;
01816 
01817     <span class="comment">/* if (!key) {</span>
01818 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01819 <span class="comment">        return KEY_TYPE_UNDEFINED;</span>
01820 <span class="comment">    }</span>
01821 <span class="comment">    if (!keyIsInitialized(key)) keyInit(key); */</span>
01822 
01823     <span class="keywordflow">switch</span> (newType) {
01824         <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga5a8">KEY_TYPE_DIR</a>:
01825             key-&gt;<a class="code" href="struct__Key.html#o0">type</a>=KEY_TYPE_DIR;
01826             dirSwitch=umask(0); umask(dirSwitch);
01827             dirSwitch=0111 &amp; ~dirSwitch;
01828             key-&gt;<a class="code" href="struct__Key.html#o3">access</a>|=dirSwitch | S_IFDIR;
01829             <a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(key,0,0); <span class="comment">/* remove data */</span>
01830             <span class="keywordflow">break</span>;
01831         <span class="keywordflow">default</span>:
01832             key-&gt;<a class="code" href="struct__Key.html#o0">type</a>=newType;
01833             key-&gt;<a class="code" href="struct__Key.html#o3">access</a> &amp;= ~(S_IFDIR | dirSwitch);
01834             key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= KEY_SWITCH_NEEDSYNC;
01835     }
01836     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o0">type</a>;
01837 }
01838 
01839 
01840 
<a name="l01853"></a><a class="code" href="group__keyvalue.html#ga11">01853</a> ssize_t <a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(<a class="code" href="struct__Key.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">void</span> *newBinary, size_t dataSize) {
01854     <span class="comment">/* if (!key) {</span>
01855 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01856 <span class="comment">        return 0;</span>
01857 <span class="comment">    }</span>
01858 <span class="comment">    if (!keyIsInitialized(key)) keyInit(key); */</span>
01859 
01860     <span class="keywordflow">if</span> (!dataSize || !newBinary) {
01861         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o14">data</a>) {
01862             free(key-&gt;<a class="code" href="struct__Key.html#o14">data</a>);
01863             key-&gt;<a class="code" href="struct__Key.html#o14">data</a>=0;
01864         }
01865         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp;= ~(KEY_SWITCH_VALUE);
01866         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= KEY_SWITCH_NEEDSYNC;
01867         <span class="keywordflow">return</span> 0;
01868     }
01869 
01870     key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>=dataSize;
01871     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o14">data</a>) {
01872         <span class="keywordtype">char</span> *p;
01873         p=realloc(key-&gt;<a class="code" href="struct__Key.html#o14">data</a>,key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>);
01874         <span class="keywordflow">if</span> (NULL==p) <span class="keywordflow">return</span> -1;
01875         key-&gt;<a class="code" href="struct__Key.html#o14">data</a>=p;
01876     } <span class="keywordflow">else</span> {
01877         key-&gt;<a class="code" href="struct__Key.html#o14">data</a>=malloc(key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>);
01878         }
01879 
01880     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o14">data</a>) <span class="keywordflow">return</span> -1;
01881 
01882     memcpy(key-&gt;<a class="code" href="struct__Key.html#o14">data</a>,newBinary,key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>);
01883     key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= <a class="code" href="group__key.html#gga7a16">KEY_SWITCH_VALUE</a> | KEY_SWITCH_NEEDSYNC;
01884     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>;
01885 }
01886 
01887 
01888 
01889 
01890 
01891 
01892 
01893 
01894 <span class="comment">/***************************************************** </span>
01895 <span class="comment"> *    General owner or domain manipulation methods   *</span>
01896 <span class="comment"> *****************************************************/</span>
01897 
01898 
01899 
<a name="l01911"></a><a class="code" href="group__keymeta.html#ga0">01911</a> ssize_t <a class="code" href="group__keymeta.html#ga0">keySetOwner</a>(<a class="code" href="struct__Key.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *userDomain) {
01912     ssize_t size;
01913 
01914     <span class="comment">/* if (!key) {</span>
01915 <span class="comment">        errno=KDB_RET_UNINITIALIZED; // KDB_RET_NULLKEY</span>
01916 <span class="comment">        return -1;</span>
01917 <span class="comment">    }</span>
01918 <span class="comment">    if (!keyIsInitialized(key)) keyInit(key); */</span>
01919     
01920     <span class="keywordflow">if</span> (userDomain == 0) {
01921         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) {
01922             free(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
01923             key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>=0;
01924         }
01925         <span class="keywordflow">return</span> 0;
01926     }
01927 
01928     <span class="keywordflow">if</span> ((size=<a class="code" href="group__backend.html#ga8">strblen</a>(userDomain)) &gt; 0) {
01929         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) {
01930             <span class="keywordtype">char</span> *p;
01931             p=realloc(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>,size);
01932             <span class="keywordflow">if</span> (NULL==p) {
01933                 errno=KDB_RET_NOMEM;
01934                 <span class="keywordflow">return</span> -1;
01935             }
01936             key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>=p;
01937         } <span class="keywordflow">else</span> {
01938             key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>=malloc(size);
01939         }
01940         <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) <span class="keywordflow">return</span> -1; <span class="comment">/* propagate errno */</span>
01941 
01942         strcpy(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>,userDomain);
01943         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= <a class="code" href="group__key.html#gga7a18">KEY_SWITCH_DOMAIN</a> | KEY_SWITCH_NEEDSYNC;
01944         <span class="keywordflow">return</span> size;
01945     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) {
01946         free(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
01947         key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>=0;
01948         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp;= ~(<a class="code" href="group__key.html#gga7a18">KEY_SWITCH_DOMAIN</a> | KEY_SWITCH_NEEDSYNC);
01949     }
01950     <span class="keywordflow">return</span> 0;
01951 }
01952 
01953 
01954 
<a name="l01962"></a><a class="code" href="group__keymeta.html#ga1">01962</a> ssize_t <a class="code" href="group__keymeta.html#ga1">keyGetOwnerSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
01963     
01964     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
01965 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
01966 <span class="comment">        return 0;</span>
01967 <span class="comment">    } */</span>
01968 
01969     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) {
01970         errno=KDB_RET_NODOMAIN;
01971         <span class="keywordflow">return</span> 0;
01972     }
01973 
01974     <span class="keywordflow">return</span> <a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
01975 }
01976 
01977 
01978 
<a name="l01999"></a><a class="code" href="group__keymeta.html#ga2">01999</a> ssize_t <a class="code" href="group__keymeta.html#ga2">keyGetOwner</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returned, size_t maxSize) {
02000     ssize_t bytes;
02001 
02002     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02003 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02004 <span class="comment">        return 0;</span>
02005 <span class="comment">    } */</span>
02006 
02007     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) {
02008         errno=KDB_RET_NODOMAIN;
02009         <span class="keywordflow">return</span> 0;
02010     }
02011 
02012     <span class="keywordflow">if</span> (maxSize &lt; (bytes=<a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>))) {
02013         errno=KDB_RET_TRUNC;
02014         <span class="keywordflow">return</span> -1;
02015     } <span class="keywordflow">else</span> strcpy(returned,key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
02016     <span class="keywordflow">return</span> bytes;
02017 }
02018 
02019 
02020 
02021 
<a name="l02031"></a><a class="code" href="group__keymeta.html#ga3">02031</a> <span class="keywordtype">char</span> *<a class="code" href="group__keymeta.html#ga3">keyStealOwner</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02032     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>;
02033 }
02034 
02035 
02036 
02037 
02038 
02039 
02040 <span class="comment">/********************************************* </span>
02041 <span class="comment"> *    General comment manipulation methods   *</span>
02042 <span class="comment"> *********************************************/</span>
02043 
02044 
02045 
<a name="l02057"></a><a class="code" href="group__keymeta.html#ga4">02057</a> ssize_t <a class="code" href="group__keymeta.html#ga4">keySetComment</a>(<a class="code" href="struct__Key.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *newComment) {
02058     ssize_t size;
02059 
02060     <span class="comment">/* if (!key) {</span>
02061 <span class="comment">        errno=KDB_RET_UNINITIALIZED; // KDB_RET_NULLKEY </span>
02062 <span class="comment">        return 0;</span>
02063 <span class="comment">    } </span>
02064 <span class="comment">    if (!keyIsInitialized(key)) keyInit(key); */</span>
02065 
02066     <span class="keywordflow">if</span> (newComment &amp;&amp; (size=<a class="code" href="group__backend.html#ga8">strblen</a>(newComment)) &gt; 0) {
02067         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_COMMENT) {
02068             <span class="keywordtype">char</span> *p;
02069             p=realloc(key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>,size);
02070             <span class="keywordflow">if</span> (NULL==p) {
02071                 errno=KDB_RET_NOMEM;
02072                 <span class="keywordflow">return</span> -1;
02073             }
02074             key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>=p;
02075         } <span class="keywordflow">else</span> {
02076             key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>=malloc(size);
02077         }
02078         <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>) <span class="keywordflow">return</span> -1;
02079 
02080         strcpy(key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>,newComment);
02081         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= <a class="code" href="group__key.html#gga7a19">KEY_SWITCH_COMMENT</a> | KEY_SWITCH_NEEDSYNC;
02082         <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o7">commentSize</a>=size;
02083     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_COMMENT) {
02084         free(key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>);
02085         key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>=0;
02086         key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp;= ~(<a class="code" href="group__key.html#gga7a19">KEY_SWITCH_COMMENT</a> | KEY_SWITCH_NEEDSYNC);
02087     }
02088     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o7">commentSize</a>=0;
02089 }
02090 
02091 
02092 
<a name="l02103"></a><a class="code" href="group__keymeta.html#ga5">02103</a> ssize_t <a class="code" href="group__keymeta.html#ga5">keyGetCommentSize</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02104     <span class="comment">/*  if (!key || !keyIsInitialized(key)) {</span>
02105 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02106 <span class="comment">        return 0;</span>
02107 <span class="comment">    } */</span>
02108 
02109     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>) {
02110         errno=KDB_RET_NODESC;
02111         <span class="keywordflow">return</span> 0;
02112     }
02113 
02114     <span class="keywordflow">return</span> <a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>);
02115 }
02116 
02117 
02118 
<a name="l02130"></a><a class="code" href="group__keymeta.html#ga6">02130</a> ssize_t <a class="code" href="group__keymeta.html#ga6">keyGetComment</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, <span class="keywordtype">char</span> *returnedDesc, size_t maxSize) {
02131     ssize_t bytes;
02132 
02133     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02134 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02135 <span class="comment">        return 0;</span>
02136 <span class="comment">    } */</span>
02137 
02138     <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>) {
02139         errno=KDB_RET_NODESC;
02140         <span class="keywordflow">return</span> 0;
02141     }
02142 
02143     bytes=<a class="code" href="group__backend.html#ga8">strblen</a>(strncpy(returnedDesc,key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>,maxSize));
02144     <span class="keywordflow">if</span> (maxSize &lt; <a class="code" href="group__backend.html#ga8">strblen</a>(key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>)) {
02145         errno=KDB_RET_TRUNC;
02146         <span class="keywordflow">return</span> -1;
02147     }
02148     <span class="keywordflow">return</span> bytes;
02149 }
02150 
02151 
<a name="l02162"></a><a class="code" href="group__keymeta.html#ga7">02162</a> <span class="keywordtype">char</span> *<a class="code" href="group__keymeta.html#ga7">keyStealComment</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02163     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>;
02164 }
02165 
02166 
02167 
02168 
02169 
02170 
02171 ssize_t keyGetRecordSize(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02172     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02173 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02174 <span class="comment">        return -1;</span>
02175 <span class="comment">    } */</span>
02176 
02177     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o9">recordSize</a>;
02178 }
02179 
02180 
<a name="l02186"></a><a class="code" href="group__keymisc.html#ga0">02186</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keymisc.html#ga0">keyNext</a>(<a class="code" href="struct__Key.html">Key</a> *key) {
02187     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
02188 }
02189 
02190 
02191 
02192 
02193 
02194 
02195 
02196 
<a name="l02211"></a><a class="code" href="group__key.html#ga2">02211</a> <span class="keywordtype">int</span> <a class="code" href="group__key.html#ga2">keyDup</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *source, <a class="code" href="struct__Key.html">Key</a> *dest) {
02212 
02213     <span class="comment">/* clear everything first */</span>
02214     <a class="code" href="group__key.html#ga4">keyClose</a>(dest);
02215 
02216     <span class="comment">/* Copy the struct data, including the "next" pointer */</span>
02217     *dest=*source;
02218 
02219     <span class="comment">/* prepare to set dynamic properties */</span>
02220     dest-&gt;<a class="code" href="struct__Key.html#o11">key</a>=
02221     dest-&gt;<a class="code" href="struct__Key.html#o12">comment</a>=
02222     dest-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>=
02223     dest-&gt;<a class="code" href="struct__Key.html#o14">data</a>=0;
02224 
02225     <span class="comment">/* Set properties that need memory allocation */</span>
02226     <a class="code" href="group__keyname.html#ga0">keySetName</a>(dest,source-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
02227     <a class="code" href="group__keymeta.html#ga4">keySetComment</a>(dest,source-&gt;<a class="code" href="struct__Key.html#o12">comment</a>);
02228     <a class="code" href="group__keymeta.html#ga0">keySetOwner</a>(dest,source-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
02229     <a class="code" href="group__keyvalue.html#ga11">keySetRaw</a>(dest,source-&gt;<a class="code" href="struct__Key.html#o14">data</a>,source-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>);
02230 
02231     dest-&gt;<a class="code" href="struct__Key.html#o10">flags</a>=source-&gt;<a class="code" href="struct__Key.html#o10">flags</a>;
02232 
02233     <span class="keywordflow">return</span> 0;
02234 }
02235 
02236 
02237 
<a name="l02248"></a><a class="code" href="group__keymeta.html#ga8">02248</a> uid_t <a class="code" href="group__keymeta.html#ga8">keyGetUID</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02249     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02250 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02251 <span class="comment">        return -1;</span>
02252 <span class="comment">    } */</span>
02253 
02254     <span class="comment">/*if (!(key-&gt;flags &amp; KEY_SWITCH_UID)) return KDB_RET_NOCRED;*/</span>
02255 
02256     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o1">uid</a>;
02257 }
02258 
02259 
02260 
<a name="l02271"></a><a class="code" href="group__keymeta.html#ga9">02271</a> <span class="keywordtype">int</span> <a class="code" href="group__keymeta.html#ga9">keySetUID</a>(<a class="code" href="struct__Key.html">Key</a> *key, uid_t uid) {
02272     <span class="comment">/* if (!key) return errno=KDB_RET_UNINITIALIZED;</span>
02273 <span class="comment">    if (!keyIsInitialized(key)) keyInit(key); */</span>
02274 
02275     key-&gt;<a class="code" href="struct__Key.html#o1">uid</a>=uid;
02276     key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= <a class="code" href="group__key.html#gga7a20">KEY_SWITCH_UID</a> | KEY_SWITCH_NEEDSYNC;
02277 
02278     <span class="keywordflow">return</span> 0;
02279 }
02280 
02281 
02282 
<a name="l02290"></a><a class="code" href="group__keymeta.html#ga10">02290</a> gid_t <a class="code" href="group__keymeta.html#ga10">keyGetGID</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02291     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02292 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02293 <span class="comment">        return -1;</span>
02294 <span class="comment">    } */</span>
02295 
02296     <span class="comment">/*if (!(key-&gt;flags &amp; KEY_SWITCH_GID)) return KDB_RET_NOCRED;*/</span>
02297 
02298     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o2">gid</a>;
02299 }
02300 
02301 
02302 
<a name="l02310"></a><a class="code" href="group__keymeta.html#ga11">02310</a> <span class="keywordtype">int</span> <a class="code" href="group__keymeta.html#ga11">keySetGID</a>(<a class="code" href="struct__Key.html">Key</a> *key, gid_t gid) {
02311     <span class="comment">/* if (!key) return errno=KDB_RET_UNINITIALIZED;</span>
02312 <span class="comment">    if (!keyIsInitialized(key)) keyInit(key); */</span>
02313 
02314     key-&gt;<a class="code" href="struct__Key.html#o2">gid</a>=gid;
02315     key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= <a class="code" href="group__key.html#gga7a21">KEY_SWITCH_GID</a> | KEY_SWITCH_NEEDSYNC;
02316 
02317     <span class="keywordflow">return</span> 0;
02318 }
02319 
02320 
02321 
<a name="l02327"></a><a class="code" href="group__keymeta.html#ga12">02327</a> mode_t <a class="code" href="group__keymeta.html#ga12">keyGetAccess</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02328     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02329 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02330 <span class="comment">        return -1;</span>
02331 <span class="comment">    } */</span>
02332 
02333     <span class="comment">/*if (!(key-&gt;flags &amp; KEY_SWITCH_MODE)) return KDB_RET_NOCRED;*/</span>
02334 
02335     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o3">access</a>;
02336 }
02337 
02338 
02339 
<a name="l02347"></a><a class="code" href="group__keymeta.html#ga13">02347</a> <span class="keywordtype">int</span> <a class="code" href="group__keymeta.html#ga13">keySetAccess</a>(<a class="code" href="struct__Key.html">Key</a> *key, mode_t mode) {
02348     <span class="comment">/* if (!key) return errno=KDB_RET_UNINITIALIZED;</span>
02349 <span class="comment">    if (!keyIsInitialized(key)) keyInit(key); */</span>
02350 
02351     key-&gt;<a class="code" href="struct__Key.html#o3">access</a>=mode;
02352     key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> |= <a class="code" href="group__key.html#gga7a22">KEY_SWITCH_MODE</a> | KEY_SWITCH_NEEDSYNC;
02353 
02354     <span class="keywordflow">return</span> 0;
02355 }
02356 
02357 
02358 
<a name="l02363"></a><a class="code" href="group__keymeta.html#ga14">02363</a> time_t <a class="code" href="group__keymeta.html#ga14">keyGetMTime</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02364     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02365 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02366 <span class="comment">        return -1;</span>
02367 <span class="comment">    } */</span>
02368     <span class="comment">/*if (!(key-&gt;flags &amp; KEY_SWITCH_TIME)) return KDB_RET_NOTIME;*/</span>
02369 
02370     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o5">mtime</a>;
02371 }
02372 
02373 
02374 
<a name="l02379"></a><a class="code" href="group__keymeta.html#ga15">02379</a> time_t <a class="code" href="group__keymeta.html#ga15">keyGetATime</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02380     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02381 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02382 <span class="comment">        return -1;</span>
02383 <span class="comment">    } */</span>
02384     <span class="comment">/*if (!(key-&gt;flags &amp; KEY_SWITCH_TIME)) return KDB_RET_NOTIME;*/</span>
02385 
02386     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o4">atime</a>;
02387 }
02388 
02389 
02390 
<a name="l02395"></a><a class="code" href="group__keymeta.html#ga16">02395</a> time_t <a class="code" href="group__keymeta.html#ga16">keyGetCTime</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02396     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02397 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02398 <span class="comment">        return -1;</span>
02399 <span class="comment">    } */</span>
02400     <span class="comment">/*if (!(key-&gt;flags &amp; KEY_SWITCH_TIME)) return KDB_RET_NOTIME;*/</span>
02401 
02402     <span class="keywordflow">return</span> key-&gt;<a class="code" href="struct__Key.html#o6">ctime</a>;
02403 }
02404 
02405 
02406 
<a name="l02479"></a><a class="code" href="group__keytest.html#ga9">02479</a> u_int32_t <a class="code" href="group__keytest.html#ga9">keyCompare</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key1, <span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key2) {
02480     u_int32_t ret=0;
02481 
02482 
02483     <span class="comment">/* Compare these numeric properties */</span>
02484     <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="struct__Key.html#o1">uid</a> != key2-&gt;<a class="code" href="struct__Key.html#o1">uid</a>)                    ret|=KEY_SWITCH_UID;
02485     <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="struct__Key.html#o2">gid</a> != key2-&gt;<a class="code" href="struct__Key.html#o2">gid</a>)                    ret|=KEY_SWITCH_GID;
02486     <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="struct__Key.html#o0">type</a> != key2-&gt;<a class="code" href="struct__Key.html#o0">type</a>)                  ret|=KEY_SWITCH_TYPE;
02487     <span class="keywordflow">if</span> ((key1-&gt;<a class="code" href="struct__Key.html#o3">access</a> &amp; (S_IRWXU|S_IRWXG|S_IRWXO)) !=
02488         (key2-&gt;<a class="code" href="struct__Key.html#o3">access</a> &amp; (S_IRWXU|S_IRWXG|S_IRWXO))) ret|=KEY_SWITCH_MODE;
02489 
02490     <span class="comment">/* Compare these string properties.</span>
02491 <span class="comment">       A lot of decisions because strcmp can't handle NULL pointers */</span>
02492     <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="struct__Key.html#o11">key</a> &amp;&amp; key2-&gt;<a class="code" href="struct__Key.html#o11">key</a>) {
02493         <span class="keywordflow">if</span> (strcmp(key1-&gt;<a class="code" href="struct__Key.html#o11">key</a>,key2-&gt;<a class="code" href="struct__Key.html#o11">key</a>))            ret|=KEY_SWITCH_NAME;
02494     } <span class="keywordflow">else</span> {
02495         <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="struct__Key.html#o11">key</a>)                              ret|=KEY_SWITCH_NAME;
02496         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key2-&gt;<a class="code" href="struct__Key.html#o11">key</a>)                         ret|=KEY_SWITCH_NAME;
02497     }
02498 
02499     <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="struct__Key.html#o12">comment</a> &amp;&amp; key2-&gt;<a class="code" href="struct__Key.html#o12">comment</a>) {
02500         <span class="keywordflow">if</span> (strcmp(key1-&gt;<a class="code" href="struct__Key.html#o12">comment</a>,key2-&gt;<a class="code" href="struct__Key.html#o12">comment</a>))    ret|=KEY_SWITCH_COMMENT;
02501     } <span class="keywordflow">else</span> {
02502         <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="struct__Key.html#o12">comment</a>)                          ret|=KEY_SWITCH_COMMENT;
02503         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key2-&gt;<a class="code" href="struct__Key.html#o12">comment</a>)                     ret|=KEY_SWITCH_COMMENT;
02504     }
02505 
02506     <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a> &amp;&amp; key2-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>) {
02507         <span class="keywordflow">if</span> (strcmp(key1-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>,key2-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>)) ret|=KEY_SWITCH_DOMAIN;
02508     } <span class="keywordflow">else</span> {
02509         <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>)                       ret|=KEY_SWITCH_DOMAIN;
02510         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key2-&gt;<a class="code" href="struct__Key.html#o12">comment</a>)                     ret|=KEY_SWITCH_DOMAIN;
02511     }
02512 
02513     <span class="comment">/* compare and select some flags */</span>
02514     ret|=(key1-&gt;<a class="code" href="struct__Key.html#o10">flags</a> ^ key2-&gt;<a class="code" href="struct__Key.html#o10">flags</a>) &amp; (<a class="code" href="group__key.html#gga7a28">KEY_SWITCH_FLAG</a> | KEY_SWITCH_NEEDSYNC);
02515     
02516     <span class="comment">/* Compare data */</span>
02517     <span class="keywordflow">if</span> (memcmp(key1-&gt;<a class="code" href="struct__Key.html#o14">data</a>,key2-&gt;<a class="code" href="struct__Key.html#o14">data</a>,
02518             (key1-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>&lt;=key2-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>?key1-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>:key2-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>)))
02519         ret|=KEY_SWITCH_VALUE;
02520 
02521     <span class="keywordflow">return</span> ret;
02522 }
02523 
02524 
02525 
02526 
02527 
02528 
<a name="l02563"></a><a class="code" href="group__keymisc.html#ga1">02563</a> ssize_t <a class="code" href="group__keymisc.html#ga1">keyToStream</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key, FILE* stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> options) {
02564     ssize_t written=0;
02565     <span class="keywordtype">char</span> buffer[800];
02566     <span class="keyword">struct </span>passwd *pwd=0;
02567     <span class="keyword">struct </span>group *grp=0;
02568 
02569 
02570     <span class="comment">/* if (!key || !keyIsInitialized(key) // || !key-&gt;key * / ) {</span>
02571 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02572 <span class="comment">        return 0;</span>
02573 <span class="comment">    } */</span>
02574 
02575     <span class="comment">/* Write key name */</span>
02576     <span class="keywordflow">if</span> (options &amp; KDB_O_FULLNAME) {
02577         <a class="code" href="group__keyname.html#ga7">keyGetFullName</a>(key,buffer,<span class="keyword">sizeof</span>(buffer));
02578         written+=fprintf(stream,<span class="stringliteral">"&lt;key name=\"%s\""</span>, buffer);
02579     } <span class="keywordflow">else</span> written+=fprintf(stream,<span class="stringliteral">"&lt;key name=\"%s\""</span>, key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
02580 
02581 
02582     <span class="keywordflow">if</span> (options &amp; KDB_O_CONDENSED) written+=fprintf(stream,<span class="stringliteral">" "</span>);
02583     <span class="keywordflow">else</span> written+=fprintf(stream,<span class="stringliteral">"\n     "</span>);
02584 
02585 
02586 
02587     <span class="comment">/* Key type */</span>
02588     <span class="keywordflow">if</span> (options &amp; KDB_O_NUMBERS) {
02589         written+=fprintf(stream,<span class="stringliteral">"type=\"%d\""</span>, key-&gt;<a class="code" href="struct__Key.html#o0">type</a>);
02590     } <span class="keywordflow">else</span> {
02591         buffer[0]=0;
02592 
02593         <span class="keywordflow">switch</span> (key-&gt;<a class="code" href="struct__Key.html#o0">type</a>) {
02594             <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga5a11">KEY_TYPE_STRING</a>:
02595                 strcpy(buffer,<span class="stringliteral">"string"</span>);
02596                 <span class="keywordflow">break</span>;
02597             <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga5a10">KEY_TYPE_BINARY</a>:
02598                 strcpy(buffer,<span class="stringliteral">"binary"</span>);
02599                 <span class="keywordflow">break</span>;
02600             <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga5a9">KEY_TYPE_LINK</a>:
02601                 strcpy(buffer,<span class="stringliteral">"link"</span>);
02602                 <span class="keywordflow">break</span>;
02603             <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga5a8">KEY_TYPE_DIR</a>:
02604                 strcpy(buffer,<span class="stringliteral">"directory"</span>);
02605                 <span class="keywordflow">break</span>;
02606             <span class="keywordflow">case</span> <a class="code" href="group__key.html#gga5a7">KEY_TYPE_UNDEFINED</a>:
02607                 strcpy(buffer,<span class="stringliteral">"undefined"</span>);
02608                 <span class="keywordflow">break</span>;
02609         }
02610         <span class="keywordflow">if</span> (buffer[0]) written+=fprintf(stream,<span class="stringliteral">"type=\"%s\""</span>, buffer);
02611         <span class="keywordflow">else</span> written+=fprintf(stream,<span class="stringliteral">"type=\"%d\""</span>, key-&gt;<a class="code" href="struct__Key.html#o0">type</a>);
02612     }
02613 
02614 
02615     <span class="keywordflow">if</span> (<a class="code" href="group__keytest.html#ga4">keyIsUser</a>(key)) {
02616         <span class="keyword">struct </span>passwd *domainPwd=0;
02617         <span class="keywordtype">int</span> uidMatch,gidMatch;
02618         
02619         domainPwd=getpwnam(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
02620         pwd=getpwuid(key-&gt;<a class="code" href="struct__Key.html#o1">uid</a>);
02621         grp=getgrgid(key-&gt;<a class="code" href="struct__Key.html#o2">gid</a>);
02622         
02623         uidMatch=(key-&gt;<a class="code" href="struct__Key.html#o1">uid</a> == domainPwd-&gt;pw_uid);
02624         gidMatch=(key-&gt;<a class="code" href="struct__Key.html#o2">gid</a> == domainPwd-&gt;pw_gid);
02625         
02626         <span class="keywordflow">if</span> (options &amp; KDB_O_FULLUGID) {
02627             <span class="keywordflow">if</span> (pwd &amp;&amp; !(options &amp; KDB_O_NUMBERS))
02628                 written+=fprintf(stream,<span class="stringliteral">" uid=\"%s\""</span>,pwd-&gt;pw_name);
02629             <span class="keywordflow">else</span> written+=fprintf(stream,   <span class="stringliteral">" uid=\"%d\""</span>,key-&gt;<a class="code" href="struct__Key.html#o1">uid</a>);
02630         
02631             <span class="keywordflow">if</span> (grp &amp;&amp; !(options &amp; KDB_O_NUMBERS))
02632                 written+=fprintf(stream,<span class="stringliteral">" gid=\"%s\""</span>,grp-&gt;gr_name);
02633             <span class="keywordflow">else</span>  written+=fprintf(stream,   <span class="stringliteral">" gid=\"%d\""</span>,key-&gt;<a class="code" href="struct__Key.html#o2">gid</a>);
02634         } <span class="keywordflow">else</span> {
02635             <span class="keywordflow">if</span> (!uidMatch) {
02636                 <span class="keywordflow">if</span> (pwd &amp;&amp; !(options &amp; KDB_O_NUMBERS))
02637                     written+=fprintf(stream,<span class="stringliteral">" uid=\"%s\""</span>,pwd-&gt;pw_name);
02638                 <span class="keywordflow">else</span> written+=fprintf(stream,   <span class="stringliteral">" uid=\"%d\""</span>,key-&gt;<a class="code" href="struct__Key.html#o1">uid</a>);
02639             }
02640 
02641             <span class="keywordflow">if</span> (!gidMatch) {
02642                 <span class="keywordflow">if</span> (grp &amp;&amp; !(options &amp; KDB_O_NUMBERS))
02643                     written+=fprintf(stream,<span class="stringliteral">" gid=\"%s\""</span>,grp-&gt;gr_name);
02644                 <span class="keywordflow">else</span> written+=fprintf(stream,   <span class="stringliteral">" gid=\"%d\""</span>,key-&gt;<a class="code" href="struct__Key.html#o2">gid</a>);
02645             }
02646         }
02647     } <span class="keywordflow">else</span> {
02648         <span class="keywordflow">if</span> (!(options &amp; KDB_O_NUMBERS)) {
02649             pwd=getpwuid(key-&gt;<a class="code" href="struct__Key.html#o1">uid</a>);
02650             grp=getgrgid(key-&gt;<a class="code" href="struct__Key.html#o2">gid</a>);
02651         }
02652 
02653         <span class="comment">/* UID, GID, mode */</span>
02654         <span class="keywordflow">if</span> (pwd) written+=fprintf(stream,<span class="stringliteral">" uid=\"%s\""</span>,pwd-&gt;pw_name);
02655         <span class="keywordflow">else</span>  written+=fprintf(stream,   <span class="stringliteral">" uid=\"%d\""</span>,key-&gt;<a class="code" href="struct__Key.html#o1">uid</a>);
02656 
02657         <span class="keywordflow">if</span> (grp) written+=fprintf(stream,<span class="stringliteral">" gid=\"%s\""</span>,grp-&gt;gr_name);
02658         <span class="keywordflow">else</span>  written+=fprintf(stream,   <span class="stringliteral">" gid=\"%d\""</span>,key-&gt;<a class="code" href="struct__Key.html#o2">gid</a>);
02659     }
02660 
02661     written+=fprintf(stream,<span class="stringliteral">" mode=\"0%o\"&gt;"</span>,
02662         key-&gt;<a class="code" href="struct__Key.html#o3">access</a> &amp; (S_IRWXU|S_IRWXG|S_IRWXO));
02663 
02664 
02665 
02666     <span class="keywordflow">if</span> (!(options &amp; KDB_O_CONDENSED) &amp;&amp; (key-&gt;<a class="code" href="struct__Key.html#o14">data</a> || key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>))
02667         written+=fprintf(stream,<span class="stringliteral">"\n\n     "</span>);
02668 
02669     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o14">data</a>) {
02670         written+=fprintf(stream,<span class="stringliteral">"&lt;value&gt;"</span>);
02671         fflush(stream);
02672         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o0">type</a> &gt;= <a class="code" href="group__key.html#gga5a11">KEY_TYPE_STRING</a> || key-&gt;<a class="code" href="struct__Key.html#o0">type</a> &lt; KEY_TYPE_BINARY) {
02673             written+=fprintf(stream,<span class="stringliteral">"&lt;![CDATA["</span>);
02674             fflush(stream);
02675             
02676             <span class="comment">/* must chop ending \0 */</span>
02677             written+=write(fileno(stream),key-&gt;<a class="code" href="struct__Key.html#o14">data</a>,key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>-1);
02678             written+=fprintf(stream,<span class="stringliteral">"]]&gt;"</span>);
02679         } <span class="keywordflow">else</span> {
02680             <span class="comment">/* Binary values */</span>
02681             <span class="keywordtype">char</span> *encoded=malloc(3*key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>);
02682             size_t encodedSize;
02683 
02684             written+=fprintf(stream,<span class="stringliteral">"\n"</span>);
02685             fflush(stream);
02686             encodedSize=<a class="code" href="group__backend.html#ga3">encode</a>(key-&gt;<a class="code" href="struct__Key.html#o14">data</a>,key-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>,encoded);
02687             written+=write(fileno(stream),encoded,encodedSize);
02688             fflush(stream);
02689             free(encoded);
02690             written+=fprintf(stream,<span class="stringliteral">"\n"</span>);
02691         }
02692         fflush(stream);
02693         written+=fprintf(stream,<span class="stringliteral">"&lt;/value&gt;"</span>);
02694     }
02695 
02696 
02697     <span class="keywordflow">if</span> (!(options &amp; KDB_O_CONDENSED)) {
02698         written+=fprintf(stream,<span class="stringliteral">"\n"</span>);
02699         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>) written+=fprintf(stream,<span class="stringliteral">"     "</span>);
02700     }
02701 
02702     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>) {
02703         written+=fprintf(stream,<span class="stringliteral">"&lt;comment&gt;&lt;![CDATA[%s]]&gt;&lt;/comment&gt;"</span>, key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>);
02704         <span class="keywordflow">if</span> (!(options &amp; KDB_O_CONDENSED))
02705             written+=fprintf(stream,<span class="stringliteral">"\n"</span>);
02706     }
02707 
02708     written+=fprintf(stream,<span class="stringliteral">"&lt;/key&gt;"</span>);
02709 
02710     <span class="keywordflow">if</span> (!(options &amp; KDB_O_CONDENSED))
02711         written+=fprintf(stream,<span class="stringliteral">"\n\n\n\n\n\n"</span>);
02712 
02713     <span class="keywordflow">return</span> written;
02714 }
02715 
02716 
02717 
02718 
02719 
02720 <span class="comment">/*</span>
02721 <span class="comment">size_t keyGetSerializedSizeWithoutName(Key *key) {</span>
02722 <span class="comment">    return sizeof(KeyInfo)+</span>
02723 <span class="comment">        key-&gt;dataSize+</span>
02724 <span class="comment">        key-&gt;groupSize+</span>
02725 <span class="comment">        key-&gt;commentSize;</span>
02726 <span class="comment">}</span>
02727 <span class="comment">*/</span>
02728 
02729 <span class="comment">/*</span>
02730 <span class="comment">size_t keyGetSerializedSize(Key *key) {</span>
02731 <span class="comment">    size_t totalSize;</span>
02732 <span class="comment"></span>
02733 <span class="comment">    totalSize=(key-&gt;key)+1+keyGetSerializedSizeWithoutName(key);</span>
02734 <span class="comment">    if (key-&gt;userDomain) totalSize+=strlen(key-&gt;userDomain)+1;</span>
02735 <span class="comment">    return totalSize;</span>
02736 <span class="comment">}*/</span>
02737 
02738 
02739 
02740 
02741 
02742 
<a name="l02752"></a><a class="code" href="group__keymeta.html#ga17">02752</a> <span class="keywordtype">int</span> <a class="code" href="group__keymeta.html#ga17">keySetFlag</a>(<a class="code" href="struct__Key.html">Key</a> *key) {
02753     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02754 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02755 <span class="comment">        return -1;</span>
02756 <span class="comment">    } */</span>
02757 
02758     key-&gt;<a class="code" href="struct__Key.html#o10">flags</a>|=KEY_SWITCH_FLAG;
02759 
02760     <span class="keywordflow">return</span> 0;
02761 }
02762 
02763 
02764 
<a name="l02774"></a><a class="code" href="group__keymeta.html#ga18">02774</a> <span class="keywordtype">int</span> <a class="code" href="group__keymeta.html#ga18">keyClearFlag</a>(<a class="code" href="struct__Key.html">Key</a> *key) {
02775     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02776 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02777 <span class="comment">        return -1;</span>
02778 <span class="comment">    } */</span>
02779 
02780     key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp;= ~KEY_SWITCH_FLAG;
02781 
02782     <span class="keywordflow">return</span> 0;
02783 }
02784 
02785 
02786 
<a name="l02797"></a><a class="code" href="group__keymeta.html#ga19">02797</a> <span class="keywordtype">int</span> <a class="code" href="group__keymeta.html#ga19">keyGetFlag</a>(<span class="keyword">const</span> <a class="code" href="struct__Key.html">Key</a> *key) {
02798     <span class="comment">/* if (!key || !keyIsInitialized(key)) {</span>
02799 <span class="comment">        errno=KDB_RET_UNINITIALIZED;</span>
02800 <span class="comment">        return 0;</span>
02801 <span class="comment">    } */</span>
02802 
02803     <span class="keywordflow">return</span> (key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> &amp; KEY_SWITCH_FLAG) ? 1:0;
02804 }
02805 
02806 
02807 
02808  
02809  
<a name="l02832"></a><a class="code" href="group__key.html#ga3">02832</a> <span class="keywordtype">int</span> <a class="code" href="group__key.html#ga3">keyInit</a>(<a class="code" href="struct__Key.html">Key</a> *key) {
02833     <span class="comment">/* if (!key) return errno=KDB_RET_NULLKEY; */</span>
02834 
02835     memset(key,0,<span class="keyword">sizeof</span>(<a class="code" href="struct__Key.html">Key</a>));
02836     key-&gt;<a class="code" href="struct__Key.html#o0">type</a>=KEY_TYPE_UNDEFINED;
02837     key-&gt;<a class="code" href="struct__Key.html#o1">uid</a>=getuid();
02838     key-&gt;<a class="code" href="struct__Key.html#o2">gid</a>=getgid();
02839     key-&gt;<a class="code" href="struct__Key.html#o3">access</a>=umask(0); umask(key-&gt;<a class="code" href="struct__Key.html#o3">access</a>);
02840     key-&gt;<a class="code" href="struct__Key.html#o3">access</a>=DEFFILEMODE &amp; ~key-&gt;<a class="code" href="struct__Key.html#o3">access</a>;
02841 
02842     key-&gt;<a class="code" href="struct__Key.html#o10">flags</a> = KEY_SWITCH_INITIALIZED;
02843 
02844     <span class="keywordflow">return</span> 0;
02845 }
02846 
02847 
02848 
02849 
<a name="l02862"></a><a class="code" href="group__key.html#ga4">02862</a> <span class="keywordtype">int</span> <a class="code" href="group__key.html#ga4">keyClose</a>(<a class="code" href="struct__Key.html">Key</a> *key) {
02863     <span class="comment">/* if (!key) return errno=KDB_RET_NULLKEY;</span>
02864 <span class="comment">    if (!keyIsInitialized(key)) return 0; */</span>
02865 
02866     free(key-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
02867     free(key-&gt;<a class="code" href="struct__Key.html#o14">data</a>);
02868     free(key-&gt;<a class="code" href="struct__Key.html#o12">comment</a>);
02869     free(key-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>);
02870     memset(key,0,<span class="keyword">sizeof</span>(<a class="code" href="struct__Key.html">Key</a>));
02871     <span class="keywordflow">return</span> 0;
02872 }
02873 
02874 
02875 
02876 
02877 
02878 
02879 
<a name="l02913"></a><a class="code" href="group__keyset.html#ga0">02913</a> <a class="code" href="struct__KeySet.html">KeySet</a> *<a class="code" href="group__keyset.html#ga0">ksNew</a>() {
02914     <a class="code" href="struct__KeySet.html">KeySet</a> *<span class="keyword">new</span>=(<a class="code" href="struct__KeySet.html">KeySet</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct__KeySet.html">KeySet</a>));
02915     <a class="code" href="group__keyset.html#ga22">ksInit</a>(<span class="keyword">new</span>);
02916     <span class="keywordflow">return</span> <span class="keyword">new</span>;
02917 } 
02918 
02919 
02920 
<a name="l02932"></a><a class="code" href="group__keyset.html#ga1">02932</a> <span class="keywordtype">int</span> <a class="code" href="group__keyset.html#ga1">ksDel</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
02933     <span class="keywordtype">int</span> rc;
02934     
02935     rc=<a class="code" href="group__keyset.html#ga23">ksClose</a>(ks);
02936     free(ks);
02937     
02938     <span class="keywordflow">return</span> rc;
02939 }
02940 
02941 
02942 
<a name="l02946"></a><a class="code" href="group__keyset.html#ga2">02946</a> ssize_t <a class="code" href="group__keyset.html#ga2">ksGetSize</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
02947     <span class="keywordflow">return</span> ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>;
02948 }
02949 
02950 
02951 
02952 
02953 
02954 
02955 
02956 
02957 <span class="comment">/******************************************* </span>
02958 <span class="comment"> *           KeySet walking methods        *</span>
02959 <span class="comment"> *******************************************/</span>
02960 
02961 
<a name="l02970"></a><a class="code" href="group__keyset.html#ga3">02970</a> <span class="keywordtype">int</span> <a class="code" href="group__keyset.html#ga3">ksRewind</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
02971     ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=0;
02972     <span class="keywordflow">return</span> 0;
02973 }
02974 
02975 
02976 
<a name="l02990"></a><a class="code" href="group__keyset.html#ga4">02990</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keyset.html#ga4">ksNext</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
02991     <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>) ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
02992     <span class="keywordflow">else</span> ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
02993 
02994     <span class="keywordflow">return</span> ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>;
02995 }
02996 
02997 
02998 
<a name="l03006"></a><a class="code" href="group__keyset.html#ga5">03006</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keyset.html#ga5">ksCurrent</a>(<span class="keyword">const</span> <a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
03007     <span class="keywordflow">return</span> ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>;
03008 }
03009 
03010 
03011 
<a name="l03019"></a><a class="code" href="group__keyset.html#ga6">03019</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keyset.html#ga6">ksHead</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
03020     <span class="keywordflow">return</span> ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03021 }
03022 
03023 
03024 
<a name="l03031"></a><a class="code" href="group__keyset.html#ga7">03031</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keyset.html#ga7">ksTail</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
03032     <span class="keywordflow">return</span> ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>;
03033 }
03034 
03035 
03036 
03037 
03038 
03039 
03040 
03041 
03042 
03043 
03044 
03045 <span class="comment">/******************************************* </span>
03046 <span class="comment"> *    Looking up Keys inside KeySets       *</span>
03047 <span class="comment"> *******************************************/</span>
03048 
03049 
<a name="l03074"></a><a class="code" href="group__keyset.html#ga8">03074</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keyset.html#ga8">ksLookupByName</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> options) {
03075     <a class="code" href="struct__Key.html">Key</a> *init=0;
03076     <a class="code" href="struct__Key.html">Key</a> *current=0;
03077     size_t nameSize;
03078     size_t currentNameSize;
03079     
03080     nameSize=<a class="code" href="group__backend.html#ga8">strblen</a>(name);
03081     
03082     init=ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>;
03083     
03084     <span class="keywordflow">while</span> ((current=<a class="code" href="group__keyset.html#ga4">ksNext</a>(ks))) {
03085         <span class="keywordflow">if</span> (current-&gt;<a class="code" href="struct__Key.html#o11">key</a> == name) <span class="keywordflow">return</span> current; <span class="comment">/* for NULLs */</span>
03086         
03087         currentNameSize=current-&gt;<a class="code" href="struct__Key.html#o11">key</a>?<a class="code" href="group__backend.html#ga8">strblen</a>(current-&gt;<a class="code" href="struct__Key.html#o11">key</a>):0;
03088         <span class="keywordflow">if</span> (currentNameSize != nameSize) <span class="keywordflow">continue</span>;
03089         
03090         <span class="keywordflow">if</span> ((current-&gt;<a class="code" href="struct__Key.html#o11">key</a> &amp;&amp; name)) {
03091             <span class="keywordflow">if</span> ((options &amp; KDB_O_NOCASE) &amp;&amp;
03092                 !strcasecmp(current-&gt;<a class="code" href="struct__Key.html#o11">key</a>,name)) <span class="keywordflow">return</span> current;
03093             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(current-&gt;<a class="code" href="struct__Key.html#o11">key</a>,name)) <span class="keywordflow">return</span> current;
03094         }
03095     }
03096     
03097     <span class="comment">/* Reached end of KeySet. Put cursor in initial position. */</span>
03098     ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=init;
03099     
03100     <span class="keywordflow">return</span> 0;
03101 }
03102 
03103 
03104 
<a name="l03192"></a><a class="code" href="group__keyset.html#ga9">03192</a> u_int32_t <a class="code" href="group__keyset.html#ga9">ksLookupRE</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks, u_int32_t where,
03193         <span class="keyword">const</span> regex_t *regexp, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> options) {
03194     regmatch_t offsets;
03195     u_int32_t match=0;
03196     <a class="code" href="struct__Key.html">Key</a> *init, *walker;
03197     <span class="keywordtype">char</span> *parentName=0;
03198     size_t walkerNameSize=0,parentNameSize=0;
03199     
03200     init=ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>;
03201     <span class="keywordflow">if</span> (!init)
03202         <span class="comment">/* I don't have a parent to match. Ignore this option. */</span>
03203         options &amp;= options &amp; ~KDB_O_NOSPANPARENT;
03204     
03205     <span class="keywordflow">if</span> (options &amp; KDB_O_NOSPANPARENT) {
03206         <span class="comment">/* User wants siblings. Prepare context. */</span>
03207         parentNameSize=<a class="code" href="group__keyname.html#ga15">keyGetParentNameSize</a>(init);
03208         parentName=(<span class="keywordtype">char</span> *)malloc(parentNameSize);
03209         <a class="code" href="group__keyname.html#ga16">keyGetParentName</a>(init,parentName,parentNameSize);
03210     }
03211     
03212     <span class="keywordflow">while</span> ((walker=<a class="code" href="group__keyset.html#ga4">ksNext</a>(ks))) {
03213         walkerNameSize=<a class="code" href="group__keyname.html#ga3">keyGetNameSize</a>(walker);
03214         
03215         <span class="keywordflow">if</span> (options &amp; KDB_O_NOSPANPARENT) {
03216             <span class="comment">/* User wants siblings. Check if walker is a sibling of init. */</span>
03217             <span class="keywordflow">if</span> (walkerNameSize &lt; parentNameSize)
03218                 <span class="comment">/* we're out of out scope, so abort */</span>
03219                 <span class="keywordflow">break</span>;
03220             
03221             <span class="keywordflow">if</span> (memcmp(parentName,walker-&gt;<a class="code" href="struct__Key.html#o11">key</a>,parentNameSize))
03222                 <span class="comment">/* walker has a different parent, so abort */</span>
03223                 <span class="keywordflow">break</span>;
03224         }
03225     
03226         <span class="keywordflow">if</span> ((where &amp; KEY_SWITCH_NAME) &amp;&amp; walker-&gt;<a class="code" href="struct__Key.html#o11">key</a>)
03227             <span class="keywordflow">if</span> (!regexec(regexp,walker-&gt;<a class="code" href="struct__Key.html#o11">key</a>,1,&amp;offsets,0))
03228                 match |= KEY_SWITCH_NAME;
03229         
03230         <span class="keywordflow">if</span> ((where &amp; KEY_SWITCH_VALUE) &amp;&amp; walker-&gt;<a class="code" href="struct__Key.html#o14">data</a> &amp;&amp;
03231             !(<a class="code" href="group__key.html#gga5a10">KEY_TYPE_BINARY</a> &lt;= walker-&gt;<a class="code" href="struct__Key.html#o0">type</a> &amp;&amp; walker-&gt;<a class="code" href="struct__Key.html#o0">type</a> &lt; KEY_TYPE_STRING))
03232             <span class="keywordflow">if</span> (!regexec(regexp,(<span class="keywordtype">char</span> *)walker-&gt;<a class="code" href="struct__Key.html#o14">data</a>,1,&amp;offsets,0))
03233                 match |= KEY_SWITCH_VALUE;
03234         
03235         <span class="keywordflow">if</span> ((where &amp; KEY_SWITCH_OWNER) &amp;&amp; <a class="code" href="group__keytest.html#ga4">keyIsUser</a>(walker))
03236             <span class="keywordflow">if</span> (!regexec(regexp,walker-&gt;<a class="code" href="struct__Key.html#o13">userDomain</a>,1,&amp;offsets,0))
03237                 match |= KEY_SWITCH_OWNER;
03238         
03239         <span class="keywordflow">if</span> ((where &amp; KEY_SWITCH_COMMENT) &amp;&amp; walker-&gt;<a class="code" href="struct__Key.html#o12">comment</a>)
03240             <span class="keywordflow">if</span> (!regexec(regexp,walker-&gt;<a class="code" href="struct__Key.html#o12">comment</a>,1,&amp;offsets,0))
03241                 match |= KEY_SWITCH_OWNER;
03242         
03243         <span class="keywordflow">if</span> (match) <span class="keywordflow">return</span> match;
03244     }
03245     
03246     <span class="keywordflow">if</span> (parentName) free(parentName);
03247     ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=init;
03248     
03249     <span class="keywordflow">return</span> 0;
03250 }
03251 
03252 
03253 
<a name="l03284"></a><a class="code" href="group__keyset.html#ga10">03284</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keyset.html#ga10">ksLookupByValue</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks, <span class="keyword">const</span> <span class="keywordtype">char</span> *value, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> options) {
03285     <a class="code" href="struct__Key.html">Key</a> *init=0;
03286     <a class="code" href="struct__Key.html">Key</a> *current=0;
03287     size_t size=0;
03288     
03289     size=<a class="code" href="group__backend.html#ga8">strblen</a>(value);
03290     init=ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>;
03291     
03292     <span class="keywordflow">while</span> ((current=<a class="code" href="group__keyset.html#ga4">ksNext</a>(ks))) {
03293         <span class="keywordflow">if</span> (current-&gt;<a class="code" href="struct__Key.html#o14">data</a> == value) <span class="keywordflow">return</span> current;
03294         
03295         <span class="keywordflow">if</span> (size != current-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>) <span class="keywordflow">continue</span>;
03296         
03297         <span class="keywordflow">if</span> (<a class="code" href="group__key.html#gga5a10">KEY_TYPE_BINARY</a>&lt;= current-&gt;<a class="code" href="struct__Key.html#o0">type</a> &amp;&amp; current-&gt;<a class="code" href="struct__Key.html#o0">type</a> &lt; KEY_TYPE_STRING)
03298             <span class="keywordflow">continue</span>;
03299         
03300         <span class="keywordflow">if</span> ((current-&gt;<a class="code" href="struct__Key.html#o14">data</a> &amp;&amp; value)) {
03301             <span class="keywordflow">if</span> ((options &amp; KDB_O_NOCASE) &amp;&amp; 
03302                 !strcasecmp(current-&gt;<a class="code" href="struct__Key.html#o14">data</a>,value)) <span class="keywordflow">return</span> current;
03303             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(current-&gt;<a class="code" href="struct__Key.html#o14">data</a>,value)) <span class="keywordflow">return</span> current;
03304         }
03305     }
03306     
03307     <span class="comment">/* reached end of KeySet */</span>
03308     ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=init;
03309     
03310     <span class="keywordflow">return</span> 0;
03311 }
03312 
03313 
03314 
<a name="l03333"></a><a class="code" href="group__keyset.html#ga11">03333</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keyset.html#ga11">ksLookupByBinaryValue</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks, <span class="keywordtype">void</span> *value, size_t size,
03334         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> options) {
03335     <a class="code" href="struct__Key.html">Key</a> *init=0;
03336     <a class="code" href="struct__Key.html">Key</a> *current=0;
03337     
03338     init=ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>;
03339     
03340     <span class="keywordflow">while</span> ((current=<a class="code" href="group__keyset.html#ga4">ksNext</a>(ks))) {
03341         <span class="keywordflow">if</span> (current-&gt;<a class="code" href="struct__Key.html#o14">data</a> == value) <span class="keywordflow">return</span> current;
03342         
03343         <span class="keywordflow">if</span> (size != current-&gt;<a class="code" href="struct__Key.html#o8">dataSize</a>) <span class="keywordflow">continue</span>;
03344         
03345         <span class="keywordflow">if</span> ((current-&gt;<a class="code" href="struct__Key.html#o14">data</a> &amp;&amp; value) &amp;&amp; 
03346                 !memcmp(current-&gt;<a class="code" href="struct__Key.html#o14">data</a>,value,size)) <span class="keywordflow">return</span> current;
03347     }
03348     
03349     <span class="comment">/* reached end of KeySet, so reset cursor */</span>
03350     ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=init;
03351     
03352     <span class="keywordflow">return</span> 0;
03353 }
03354 
03355 
03356 
03357 
03358 
03359 
03360 
03361 <span class="comment">/******************************************* </span>
03362 <span class="comment"> *           Filling up KeySets            *</span>
03363 <span class="comment"> *******************************************/</span>
03364 
03365  
<a name="l03380"></a><a class="code" href="group__keyset.html#ga12">03380</a> ssize_t <a class="code" href="group__keyset.html#ga12">ksInsert</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks, <a class="code" href="struct__Key.html">Key</a> *toInsert) {
03381     toInsert-&gt;<a class="code" href="struct__Key.html#o15">next</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03382     ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=toInsert;
03383     <span class="keywordflow">if</span> (!ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>) ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=toInsert;
03384     <span class="keywordflow">return</span> ++ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>;
03385 }
03386 
03387 
<a name="l03400"></a><a class="code" href="group__keyset.html#ga13">03400</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keyset.html#ga13">ksPop</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
03401     <a class="code" href="struct__Key.html">Key</a> *key=0;
03402     
03403     <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>) {
03404         key=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03405         ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=key-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03406         <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a> == key) ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=0;
03407         ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>--;
03408         <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a> == key) ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=0;
03409     }
03410     
03411     <span class="keywordflow">return</span> key;
03412 }
03413 
03414 
<a name="l03427"></a><a class="code" href="group__keyset.html#ga14">03427</a> <a class="code" href="struct__Key.html">Key</a> *<a class="code" href="group__keyset.html#ga14">ksPopLast</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
03428     <a class="code" href="struct__Key.html">Key</a> *key=0;
03429     <a class="code" href="struct__Key.html">Key</a> *prev=0;
03430     
03431     <span class="comment">/* When ks is empty: */</span>
03432     <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a> == 0) <span class="keywordflow">return</span> 0;
03433     
03434     <span class="comment">/* When ks has only one member: */</span>
03435     <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a> == ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>) {
03436         key=ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>;
03437         ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=0;
03438         ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>=0;
03439         
03440         <span class="keywordflow">return</span> key;
03441     }
03442     
03443     prev=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03444     <span class="keywordflow">while</span> (prev-&gt;<a class="code" href="struct__Key.html#o15">next</a>!=ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>) prev=prev-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03445     
03446     key=ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>;
03447     prev-&gt;<a class="code" href="struct__Key.html#o15">next</a>=0;
03448     ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=prev;
03449     ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>--;
03450     <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a> == key) ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=0;
03451     
03452     <span class="keywordflow">return</span> key;
03453 }
03454 
03455 
<a name="l03467"></a><a class="code" href="group__keyset.html#ga15">03467</a> ssize_t <a class="code" href="group__keyset.html#ga15">ksInsertKeys</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks, <a class="code" href="struct__KeySet.html">KeySet</a> *toInsert) {
03468     <span class="keywordflow">if</span> (toInsert-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>) {
03469         toInsert-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>-&gt;<a class="code" href="struct__Key.html#o15">next</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03470         ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=toInsert-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03471 
03472         ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>+=toInsert-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>;
03473 
03474         <span class="comment">/* Invalidate the old KeySet */</span>
03475         toInsert-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=toInsert-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=toInsert-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=0;
03476         toInsert-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>=0;
03477     }
03478     <span class="keywordflow">return</span> ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>;
03479 }
03480 
03481 
03482 
<a name="l03497"></a><a class="code" href="group__keyset.html#ga16">03497</a> ssize_t <a class="code" href="group__keyset.html#ga16">ksAppend</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks, <a class="code" href="struct__Key.html">Key</a> *toAppend) {
03498     toAppend-&gt;<a class="code" href="struct__Key.html#o15">next</a>=0;
03499     <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>) ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>-&gt;<a class="code" href="struct__Key.html#o15">next</a>=toAppend;
03500     <span class="keywordflow">if</span> (!ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>) ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=toAppend;
03501     ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=toAppend;
03502     <span class="keywordflow">return</span> ++ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>;
03503 }
03504 
03505 
03506 
<a name="l03519"></a><a class="code" href="group__keyset.html#ga17">03519</a> ssize_t <a class="code" href="group__keyset.html#ga17">ksAppendKeys</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks, <a class="code" href="struct__KeySet.html">KeySet</a> *toAppend) {
03520     <span class="keywordflow">if</span> (toAppend-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>) {
03521         <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>) {
03522             ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>-&gt;<a class="code" href="struct__Key.html#o15">next</a>=toAppend-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03523             ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=toAppend-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>;
03524         } <span class="keywordflow">else</span> {
03525             ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=toAppend-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>;
03526             ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=toAppend-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03527         }
03528 
03529         ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>+=toAppend-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>;
03530         
03531         <span class="comment">/* Invalidate the old KeySet */</span>
03532         toAppend-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=toAppend-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=toAppend-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=0;
03533         toAppend-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>=0;
03534     }
03535     <span class="keywordflow">return</span> ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>;
03536 }
03537 
03538 
03539 
03540 
03541 
03542 
03543 
03544 
03545 
03546 
03547 <span class="comment">/******************************************* </span>
03548 <span class="comment"> *    Other operations                     *</span>
03549 <span class="comment"> *******************************************/</span>
03550 
03551 
<a name="l03612"></a><a class="code" href="group__keyset.html#ga18">03612</a> <span class="keywordtype">int</span> <a class="code" href="group__keyset.html#ga18">ksCompare</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks1, <a class="code" href="struct__KeySet.html">KeySet</a> *ks2, <a class="code" href="struct__KeySet.html">KeySet</a> *removed) {
03613     <span class="keywordtype">int</span> flagRemoved=1;
03614     <a class="code" href="struct__Key.html">Key</a> *ks1Cursor=0;
03615     <a class="code" href="struct__Key.html">Key</a> *ks2Cursor=0;
03616 
03617     <a class="code" href="struct__Key.html">Key</a> *ks1PrevCursor=0;
03618 
03619     ks1Cursor=ks1-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03620     <span class="keywordflow">while</span> (ks1Cursor) {
03621         <a class="code" href="struct__Key.html">Key</a> *ks2PrevCursor=0;
03622         flagRemoved=1;
03623         
03624         <span class="keywordflow">for</span> (ks2Cursor=ks2-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>; ks2Cursor; ks2Cursor=ks2Cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>) {
03625             u_int32_t flags=<a class="code" href="group__keytest.html#ga9">keyCompare</a>(ks1Cursor,ks2Cursor);
03626             
03627             <span class="keywordflow">if</span> (!(flags &amp; (<a class="code" href="group__key.html#gga7a15">KEY_SWITCH_NAME</a> | KEY_SWITCH_DOMAIN))) {
03628                 <span class="comment">/* Comparing fullname-equal keys */</span>
03629                 flagRemoved=0; <span class="comment">/* key was not removed */</span>
03630                     
03631                 <span class="comment">/* First remove from ks2 */</span>
03632                 <span class="keywordflow">if</span> (ks2PrevCursor) ks2PrevCursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>=ks2Cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03633                 <span class="keywordflow">else</span> ks2-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=ks2Cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03634                 <span class="keywordflow">if</span> (ks2-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>==ks2Cursor) ks2-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=ks2PrevCursor;
03635                 ks2-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>--;
03636                     
03637                 <span class="keywordflow">if</span> (flags) {
03638                     <span class="comment">/* keys are different. Transfer to ks1. */</span>
03639                     
03640                     <span class="comment">/* Put in ks1 */</span>
03641                     <span class="keywordflow">if</span> (ks1PrevCursor) ks1PrevCursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>=ks2Cursor;
03642                     <span class="keywordflow">else</span> ks1-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=ks2Cursor;
03643                     <span class="keywordflow">if</span> (ks1-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>==ks1Cursor) ks1-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=ks2Cursor;
03644                     ks2Cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>=ks1Cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03645                     
03646                     <span class="comment">/* delete old version */</span>
03647                     <a class="code" href="group__key.html#ga1">keyDel</a>(ks1Cursor);
03648                     
03649                     <span class="comment">/* Reset pointers */</span>
03650                     ks1Cursor=ks2Cursor;
03651                 } <span class="keywordflow">else</span> {
03652                     <span class="comment">/* Keys are identical. Delete ks2's key. */</span>
03653 
03654                     <span class="comment">/* Delete ks2Cusrsor */</span>
03655                     <a class="code" href="group__key.html#ga1">keyDel</a>(ks2Cursor);
03656                 }
03657                 <span class="comment">/* Don't need to walk through ks2 anymore */</span>
03658                 <span class="keywordflow">break</span>;
03659             }
03660             ks2PrevCursor=ks2Cursor;
03661             
03662         } <span class="comment">/* ks2 iteration */</span>
03663         
03664         <span class="keywordflow">if</span> (flagRemoved) {
03665             <span class="comment">/* This ks1 key was not found in ks2 */</span>
03666             <span class="comment">/* Transfer it from ks1 to removed */</span>
03667             
03668             <span class="comment">/* Remove from ks1 */</span>
03669             <span class="keywordflow">if</span> (ks1PrevCursor) ks1PrevCursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>=ks1Cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03670             <span class="keywordflow">else</span> ks1-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=ks1Cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03671             <span class="keywordflow">if</span> (ks1-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>==ks1Cursor) ks1-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=ks1PrevCursor;
03672             ks1-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>--;
03673 
03674             <span class="comment">/* Append to removed */</span>
03675             <a class="code" href="group__keyset.html#ga16">ksAppend</a>(removed,ks1Cursor);
03676             
03677             <span class="comment">/* Reset pointers */</span>
03678             <span class="keywordflow">if</span> (ks1PrevCursor) ks1Cursor=ks1PrevCursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03679             <span class="keywordflow">else</span> ks1Cursor=ks1-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03680         } <span class="keywordflow">else</span> {
03681             ks1PrevCursor=ks1Cursor;
03682             ks1Cursor=ks1Cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03683         }
03684     } <span class="comment">/* ks1 iteration */</span>
03685     
03686     <span class="comment">/* Now transfer all remaining ks2 keys to ks1 */</span>
03687     <a class="code" href="group__keyset.html#ga17">ksAppendKeys</a>(ks1,ks2);
03688     
03689     <span class="keywordflow">return</span> 0;
03690 }
03691 
03692 
03693 
03694 
<a name="l03729"></a><a class="code" href="group__keyset.html#ga19">03729</a> ssize_t <a class="code" href="group__keyset.html#ga19">ksToStream</a>(<span class="keyword">const</span> <a class="code" href="struct__KeySet.html">KeySet</a> *ks, FILE* stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> options) {
03730     size_t written=0;
03731     <a class="code" href="struct__Key.html">Key</a> *key=0;
03732 
03733     <span class="keywordflow">if</span> (options &amp; KDB_O_XMLHEADERS) {
03734         written+=fprintf(stream,<span class="stringliteral">"&lt;?xml version=\"1.0\" encoding=\"%s\"?&gt;\n"</span>,
03735             nl_langinfo(CODESET));
03736         written+=fprintf(stream,
03737             <span class="stringliteral">"\n\n&lt;!-- Generated by Elektra API. Total of %d keys. --&gt;\n\n\n\n"</span>,ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>);
03738         
03739         written+=fprintf(stream,<span class="stringliteral">"&lt;keyset xmlns=\"http://elektra.sourceforge.net\"\n\</span>
03740 <span class="stringliteral">        xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n\</span>
03741 <span class="stringliteral">        xsi:schemaLocation=\"http://elektra.sourceforge.net elektra.xsd\"&gt;\n\n\n"</span>);
03742         
03743         <span class="comment">/* written+=fprintf(stream,</span>
03744 <span class="comment">            "&lt;!DOCTYPE keyset PUBLIC \"-//Avi Alkalay//DTD Elektra 0.1.0//EN\" \"http://elektra.sf.net/dtd/elektra.dtd\"&gt;\n\n\n"); */</span>
03745     } <span class="keywordflow">else</span> written+=fprintf(stream,<span class="stringliteral">"&lt;keyset&gt;\n\n\n"</span>);
03746 
03747     <span class="keywordflow">for</span> (key=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>; key; key=key-&gt;<a class="code" href="struct__Key.html#o15">next</a>)
03748         written+=<a class="code" href="group__keymisc.html#ga1">keyToStream</a>(key,stream,options);
03749     
03750     written+=fprintf(stream,<span class="stringliteral">"&lt;/keyset&gt;\n"</span>);
03751     <span class="keywordflow">return</span> written;
03752 }
03753 
03754 
03755 
03756 <span class="comment">/* Used as a callback by the qsort() function */</span>
03757 <span class="keywordtype">int</span> keyCompareByName(<span class="keyword">const</span> <span class="keywordtype">void</span> *p1, <span class="keyword">const</span> <span class="keywordtype">void</span> *p2) {
03758     <a class="code" href="struct__Key.html">Key</a> *key1=*(<a class="code" href="struct__Key.html">Key</a> **)p1;
03759     <a class="code" href="struct__Key.html">Key</a> *key2=*(<a class="code" href="struct__Key.html">Key</a> **)p2;
03760 
03761     <span class="keywordflow">return</span> strcmp(key1-&gt;<a class="code" href="struct__Key.html#o11">key</a>, key2-&gt;<a class="code" href="struct__Key.html#o11">key</a>);
03762 }
03763 
03764 
<a name="l03770"></a><a class="code" href="group__keyset.html#ga21">03770</a> <span class="keywordtype">void</span> <a class="code" href="group__keyset.html#ga21">ksSort</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
03771     <a class="code" href="struct__Key.html">Key</a> *keys[ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>];
03772     <a class="code" href="struct__Key.html">Key</a> *cursor;
03773     size_t c=0;
03774 
03775     <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>) {
03776         <span class="keywordflow">for</span> (cursor=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>; cursor; cursor=cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>, c++)
03777             keys[c]=cursor;
03778 
03779         qsort(keys,ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>,<span class="keyword">sizeof</span>(<a class="code" href="struct__Key.html">Key</a> *),keyCompareByName);
03780 
03781         ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=cursor=keys[0];
03782         <span class="keywordflow">for</span> (c=1; c&lt;ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>; c++) {
03783             cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>=keys[c];
03784             cursor=cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03785         }
03786         cursor-&gt;<a class="code" href="struct__Key.html#o15">next</a>=0;
03787         ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=cursor;
03788     }
03789 }
03790 
03791 
03792 
03793 
03794 
03795 
<a name="l03808"></a><a class="code" href="group__keyset.html#ga22">03808</a> <span class="keywordtype">int</span> <a class="code" href="group__keyset.html#ga22">ksInit</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
03809     ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=0;
03810     ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>=0;
03811     
03812     <span class="keywordflow">return</span> 0;
03813 }
03814 
03815 
<a name="l03827"></a><a class="code" href="group__keyset.html#ga23">03827</a> <span class="keywordtype">int</span> <a class="code" href="group__keyset.html#ga23">ksClose</a>(<a class="code" href="struct__KeySet.html">KeySet</a> *ks) {
03828     <span class="keywordflow">if</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>) {
03829         <span class="keywordflow">while</span> (ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>) {
03830             <a class="code" href="struct__Key.html">Key</a> *destroyer=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03831             ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>=destroyer-&gt;<a class="code" href="struct__Key.html#o15">next</a>;
03832             <a class="code" href="group__key.html#ga1">keyDel</a>(destroyer);
03833             --ks-&gt;<a class="code" href="struct__KeySet.html#o3">size</a>;
03834         }
03835     }
03836     ks-&gt;<a class="code" href="struct__KeySet.html#o2">cursor</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o1">end</a>=ks-&gt;<a class="code" href="struct__KeySet.html#o0">start</a>;
03837     <span class="keywordflow">return</span> 0;
03838 }
03839 
03840 
03841 
03842 
03843 
03844 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Jul 30 09:10:59 2005 for Elektra Project by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
