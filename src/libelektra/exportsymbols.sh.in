#!/bin/sh -x

# exportsymbols.sh
# ----------------
#
# Export kdbBackendFactory entry point symbols
# for each compiled backend
#
# (c) 2006 Yannick Lecaillez

echo '
/* exported_symbols.c generated by exportsymbols.sh */

#include "kdbbackend.h"
#include "kdbLibLoader.h"

/* Make the compiler happy */
' > exported_symbols.c

for lib in "$@"
do
	if [ -r $lib ]; then
		echo "Exporting symbols for $lib ..."
		sym=`@NM@ -B $lib | @EGREP@ "_LTX_" | @AWK@ '{print $3}'`
		for symbol in $sym
		do
			echo "extern int $symbol;" >> exported_symbols.c
		done
	else
		echo "SKIPED: $lib doesn't exist."
	fi
done

echo '
kdblib_symbol kdb_exported_syms[] =
{
' >> exported_symbols.c

for lib in "$@"
do
	if [ -r $lib ]; then
		fname=`basename $lib .a`
		echo -e "\t{\"$fname\", NULL}," >> exported_symbols.c
		sym=`@NM@ -B $lib | @EGREP@ "_LTX_" | @AWK@ '{print $3}'`
		for symbol in $sym
		do
			func=`echo $symbol | sed 's/^\(.*\)\(_LTX_\)\(.*\)$/\3/'`
			echo -e "\t{\"$func\", &$symbol }," >> exported_symbols.c
		done
		echo "" >> exported_symbols.c
	fi
done
echo -e "\t{ NULL, NULL }" >> exported_symbols.c
echo "};" >> exported_symbols.c
	
