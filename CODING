This document provides an introduction in how the source code of
libelektra is organized and how and where to add functionality.

Make sure to read DESIGN together with this document.

= Folder structure =

After you downloaded and unpacked elektra you see untypically many
folders. The reason is that elektra project consists of many activities.

The most important are:
src ... Here is the source for the library and the tools itself.
tests ... Is the testing framework for the Source

= Source Code =

libelektra is the ANSI/ISO C-Core which does interacts between the user
and the backends.

libhelper needs POSIX (at the moment) and provides common functionality
between backends. Next to locking, methods to convert keys to filenames
it takes care of utf8 conversations.

libloader is responsible for loading the backend modules. It works for
various operating systems by using libltdl, but has an optimized code
for static linking and win32.

kdb and preload are tools to access and initialize the elektra database.

= Compiling =

To compile a program using elektra, use:
 $ cc `pkg-config --cflags elektra` -o myapp.o -c myapp.c
 $ cc `pkg-config --libs elektra`   -o myapp myapp.o

To compile a backend for elektra, use:
 $ cc -fpic `pkg-config --cflags elektra` -o myback.o -c myback.c
 $ cc -shared -fpic `pkg-config --libs elektra` -o libelektra-myback.so myback.o

= Add a backend  =

To add a backend, make a new folder according to your backendname below src/backends.
Copy the Makefile.am and template.c from src/backends/template to your new folder.
Substitute all template to your backendname in both files using :%s/template/backendname/g
using vim.

Add your directory in AC_OUTPUT of the file configure.ac to generate the Makefile.in and
Makefile out of Makefile.am.

Add a switch to enable/disable your backend using ALLOW_BACKEND. Make sure that it is
disabled by default, you need to put NO as third parameter and do not add the backend
to BACKENDS variable to do so.

Now add the subdirectory at src/backends/Makefile.am in DIST_SUBDIRS.

Your backend won't be compiled statically yet. You need to trigger that by adding
the target libelektra-<backend>.a in src/libelektra/Makefile.am of your backend.

Make sure to run ./bootstrap.sh to put the changes into effect.

= Search path of backends =

Backends and libraries (libelektratools) are loaded with the libloader.
libloader uses different techniques for different uses cases and operating
systems:
1) Static case
2) Win32
3) Generic libtldl

In the static case it looks up symbols which were compiled into the .a archive
previously. Looking up works with the backend_symbols.c generated by exportsymbols.sh.
The collecting of the symbols is done by linking the output from `cat objects`.
The file objects is generated by exportobjects.sh.

The generic libtldl searchs for .la or .so (or others e.g. dynlib on mac) in
following directories (can be changed by configure options):

backenddir, default /usr/lib/elektra
hlvlbackenddir, default ulibdir, for libelektratools
ulibdir, default /usr/lib
libdir, default /lib

The prefered place for backends is of course backenddir. libdir might be useful
for backends which are needed at the bootup process.


= Regular expressions =

Here is a collection of regular expressions to help you generate some code.
To do so just delete the old text and copy the text which should be used to generate
from to the appropriate place. Mark it with 'V', press ':' and then 'ctrl-f'.
Now open the file REGEXP with :r and press enter at the suitable line.

== KDBCap ==

use vim regular expression in REGEXP to generate the getters out of KDBCap struct

@see kdbStrError for a similar one

to enter ^M use: ^Q and <enter>
to enter ^I use: <tab>
explanation of wildcards:
:'<,'>s>>-------substitute visual block
%>------>-------used as seperate mark
^>------>-------start of line
\s>----->-------whitespaces
\([A-Z_]*\)>----catch something containing A-Z and _ and store it in \1
\=>----->-------means 0 or 1 time
\*>----->-------the * itself
\!>----->-------the ! itself

== Errors ==

To get this format out from kdb.h you can use vim regular expression in REGEXP
to enter ^M use: ^Q and <enter>
to enter ^I use: <tab>
explanation of wildcards:
:'<,'>s		substitute visual block
%		used as seperate mark
^		start of line
\s		whitespaces
\([A-Z_]*\)	catch something containing A-Z and _ and store it in \1
\=		means 0 or 1 time
\*		the * itself
\!		the ! itself

